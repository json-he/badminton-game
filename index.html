<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Âº∫Âà∂ÁºìÂ≠òÊéßÂà∂ÂíåÁâàÊú¨ÁÆ°ÁêÜ - GitHub Pages‰∏ìÁî® -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="1.3.1">
    <meta name="build-time" content="2025-01-17-UPDATE">
    <meta name="last-modified" content="2025-01-17">
    
    <!-- GitHub PagesÂº∫Âà∂Âà∑Êñ∞ -->
    <script>
        // ÁâàÊú¨Ê£ÄÊü•ÂíåÂº∫Âà∂Âà∑Êñ∞Êú∫Âà∂
        (function() {
            const currentVersion = '1.3.1';
            const buildTime = '2025-01-17-UPDATE';
            const storageKey = 'badminton_version';
            const lastVersion = localStorage.getItem(storageKey);
            
            // Â¶ÇÊûúÁâàÊú¨‰∏çÂåπÈÖçÔºåÊ∏ÖÁêÜÊâÄÊúâÁºìÂ≠ò
            if (lastVersion !== currentVersion) {
                console.log(`üîÑ ÁâàÊú¨Êõ¥Êñ∞Ê£ÄÊµã: ${lastVersion} ‚Üí ${currentVersion}`);
                
                // Ê∏ÖÁêÜlocalStorage
                const keysToKeep = ['leancloud_app_id', 'leancloud_app_key']; // ‰øùÁïô‰∫ëÁ´ØÈÖçÁΩÆ
                Object.keys(localStorage).forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Ê∏ÖÁêÜsessionStorage
                sessionStorage.clear();
                
                // Ê∏ÖÁêÜÊâÄÊúâÁºìÂ≠òÔºàÂ¶ÇÊûúÊîØÊåÅÔºâ
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                
                // ËÆæÁΩÆÊñ∞ÁâàÊú¨
                localStorage.setItem(storageKey, currentVersion);
                localStorage.setItem('badminton_build_time', buildTime);
                
                console.log('‚úÖ ÁºìÂ≠òÂ∑≤Ê∏ÖÁêÜÔºåÂä†ËΩΩÊúÄÊñ∞ÁâàÊú¨');
            }
        })();
    </script>
    
    <title>ÁæΩÊØõÁêÉÊØîËµõÁ≥ªÁªü</title>
    
    <!-- LeanCloud SDK - ÂõΩÂÜÖÊúÄ‰Ω≥ÂÆûÊó∂Êï∞ÊçÆÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    <!-- LeanCloud ÂÆûÊó∂ÈÄö‰ø°SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@5.0.0/dist/realtime.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, button {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            overflow-x: hidden;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 20px);
            overscroll-behavior: none;
            -webkit-overscroll-behavior: none;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .header p {
            color: #7f8c8d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* È°µÈù¢ÂàáÊç¢ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Áé©ÂÆ∂ÂêçÂçï */
        .players-list {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .players-list h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .players-names {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ÊØîËµõÈ¢ÑËßà */
        .rounds-preview {
            margin: 20px 0;
        }

        .round-preview {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .round-preview h3 {
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .preview-matches {
            display: grid;
            gap: 8px;
        }

        .preview-match {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            font-size: 0.85rem;
            color: #495057;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .preview-match:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .preview-match:active {
            transform: scale(0.98);
        }

        .preview-match.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }

        .preview-match.completed::after {
            content: '‚úÖ';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1rem;
        }

        .preview-match.incomplete {
            background: #fff3cd;
            border-color: #ffc107;
            animation: pulse-incomplete 2s infinite;
        }

        @keyframes pulse-incomplete {
            0% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2); }
            50% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4); }
            100% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2); }
        }

        .match-score {
            font-weight: bold;
            font-size: 1rem;
            color: #667eea;
            background: white;
            padding: 6px 12px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            min-width: 60px;
            align-self: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .match-score.has-score {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }

        /* ÂèØÁÇπÂáªÁé©ÂÆ∂ÂêçÂ≠óÊ†∑Âºè */
        .clickable-player-name {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .clickable-player-name:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            color: #667eea;
        }

        .clickable-player-name.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .match-score:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* ÊéßÂà∂ÊåâÈíÆ */
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .control-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .control-btn:hover, .control-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: scale(0.98);
        }

        /* È´òÁ∫ßÊØîÂàÜÈÄâÊã©Âô® */
        .advanced-score-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .advanced-score-modal.active {
            display: flex;
        }

        .advanced-modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 350px;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .teams-score-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0;
            gap: 20px;
        }

        .team-score-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .team-name-display {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            text-align: center;
            line-height: 1.3;
        }

        .score-wheel-container {
            position: relative;
            height: 120px;
            width: 80px;
            overflow: hidden;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
        }


        .score-wheel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .score-item {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .score-item.center {
            color: #667eea;
            font-size: 1.6rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .score-item.adjacent {
            font-size: 1rem;
            color: #adb5bd;
        }

        .score-item.distant {
            font-size: 0.8rem;
            color: #ced4da;
        }

        .vs-separator {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .score-controls {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .score-control-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-save-scores {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-save-scores:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-save-scores:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-cancel-scores {
            background: #6c757d;
            color: white;
        }

        .btn-cancel-scores:hover {
            background: #5a6268;
        }

        .score-status {
            margin: 15px 0;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .score-status.complete {
            color: #28a745;
            font-weight: 600;
        }

        /* Ëá™ÂÆö‰πâÂºπÊ°Ü */
        .custom-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .custom-dialog.active {
            display: flex;
        }

        .dialog-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 340px;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: dialogSlideIn 0.3s ease-out;
        }

        @keyframes dialogSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .dialog-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .dialog-icon.info {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .dialog-icon.warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .dialog-icon.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .dialog-icon.error {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .dialog-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .dialog-message {
            color: #6c757d;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 25px;
            white-space: pre-line;
        }

        .dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .dialog-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .dialog-btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .dialog-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .dialog-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .dialog-btn-secondary:hover {
            background: #5a6268;
        }

        /* LoadingÁä∂ÊÄÅ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
            line-height: 1.4;
        }

        /* ÊéíÂêçË°®Ê†º */
        .results-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .results-table h3 {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .results-grid {
            display: grid;
            gap: 8px;
        }

        .result-row {
            display: grid;
            grid-template-columns: 50px 1fr 50px 50px 70px;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            font-size: 0.9rem;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .result-row.header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 12px;
            border-left: none;
        }

        .result-row.winner {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            font-weight: bold;
            border-left-color: #ffd700;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }

        .result-row:not(.header):not(.winner) {
            border-left-color: #e9ecef;
        }

        .result-row:not(.header):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .rank-cell {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
        }

        .name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .score-cell {
            text-align: center;
            font-weight: 500;
        }

        .net-score-positive {
            color: #28a745;
            font-weight: bold;
        }

        .net-score-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .net-score-zero {
            color: #6c757d;
        }


        .sync-notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        /* Áé©ÂÆ∂ÈÖçÁΩÆÊ†∑Âºè */

        .player-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            margin-bottom: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .player-item.active {
            border-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            transform: scale(1.02);
        }

        .player-item.inactive {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            opacity: 0.8;
        }

        .player-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .player-status {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .player-name-input {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.95rem;
            width: 130px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .player-name-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .player-toggle {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 70px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .player-toggle.active {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .player-toggle.inactive {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .player-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Áé©ÂÆ∂Á≠õÈÄâÂäüËÉΩÊ†∑Âºè */
        .player-item.filterable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .player-item.filterable:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .player-item.selected-filter {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-color: #0056b3;
            color: white;
        }

        .player-item.selected-filter .player-name {
            color: white;
        }

        .player-item.selected-filter .player-status {
            color: rgba(255,255,255,0.8);
        }

        .filter-status {
            margin: 15px 0;
            padding: 15px 20px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-radius: 12px;
            font-size: 0.95rem;
            color: #2e7d32;
            border-left: 5px solid #4caf50;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .filter-clear-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .filter-clear-btn:active {
            transform: scale(0.95);
        }

        .preview-match.filtered-out {
            opacity: 0.2;
            filter: grayscale(100%);
            pointer-events: none;
            transform: scale(0.98);
            transition: all 0.3s ease;
        }
        
        .preview-match:not(.filtered-out) {
            transition: all 0.3s ease;
        }

        /* Áé©ÂÆ∂Á≠õÈÄâÂô®Ê†∑Âºè */
        .player-filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }

        .player-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .player-filter-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            background: white;
            color: #495057;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            user-select: none;
        }

        .player-filter-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .player-filter-btn.selected {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .player-filter-btn.selected:hover {
            transform: translateY(-1px) scale(1.02);
        }

        .filter-match-count {
            font-weight: bold;
            color: #007bff;
        }

        /* ÊØîËµõÂÆâÊéíÂèØËßÜÂåñÊ†∑Âºè */
        .schedule-round {
            margin-bottom: 25px;
        }

        .schedule-round-title {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
        }

        .schedule-matches {
            display: grid;
            gap: 10px;
        }

        .schedule-match {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .match-teams {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }

        .match-rest {
            background: #f8f9fa;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .player-schedule-grid {
            display: grid;
            grid-template-columns: 100px repeat(15, 30px);
            gap: 2px;
            margin: 15px 0;
            font-size: 0.8rem;
        }

        .schedule-header {
            display: contents;
        }

        .schedule-player-name {
            font-weight: 600;
            color: #2c3e50;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }

        .schedule-cell {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .schedule-cell.playing {
            background: #28a745;
            color: white;
        }

        .schedule-cell.resting {
            background: #dc3545;
            color: white;
        }

        .schedule-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∏ ÁæΩÊØõÁêÉÊØîËµõÁ≥ªÁªü</h1>
            <p>6‰∫∫ËΩÆËΩ¨Âà∂ - 15Âú∫ÊØîËµõÔºåÊØè‰∫∫10Âú∫</p>
            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
                <span>v1.3.1 - 2025.01.17</span>
                <button onclick="forceRefresh()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;" 
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.borderColor='rgba(255,255,255,0.5)'" 
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='rgba(255,255,255,0.3)'">
                    Êõ¥Êñ∞Âà∞ÊúÄÊñ∞ÁâàÊú¨
                </button>
            </div>
        </div>

        <!-- ‰∏ªÈ°µÈù¢ -->
        <div id="mainPage" class="page active">
            <div class="players-list">
                <h4>üìã ÂèÇËµõ‰∫∫ÂëòÂêçÂçï</h4>
                <div class="players-names" id="playersNames">
                    <!-- Áé©ÂÆ∂ÂêçÂçïÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
                </div>
                
                <!-- Áé©ÂÆ∂Á≠õÈÄâÂô® -->
                <div class="player-filter-section" id="playerFilterSection" style="margin-top: 15px;">
                    <h5 style="margin-bottom: 10px; color: #666;">üîç Á≠õÈÄâÁé©ÂÆ∂</h5>
                    <div class="player-filter-buttons" id="playerFilterButtons">
                        <!-- Á≠õÈÄâÊåâÈíÆÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
                    </div>
                </div>
        </div>

            <div class="matches-preview" id="matchesPreview">
                <div id="initialLoading" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üè∏</div>
                    <div>Ê≠£Âú®Âä†ËΩΩÊØîËµõÁ≥ªÁªü...</div>
                    <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">ËØ∑Á®çÁ≠âÁâáÂàª</div>
                </div>
            </div>

            <!-- ÊéßÂà∂ÊåâÈíÆ -->
            <div class="game-controls">
                <button class="control-btn btn-success" onclick="showFinalRanking()" id="showRankingBtn">
                    üìä Êü•ÁúãÊúÄÁªàÊéíÂêç
                </button>
                <button class="control-btn btn-warning" onclick="showPlayerConfigModal()">
                    üë• ÈÖçÁΩÆÂèÇËµõ‰∫∫Âëò
                </button>
                <button class="control-btn btn-danger" onclick="clearAllFilters()" id="clearFilterBtn" style="display: none;">
                    üîç Ê∏ÖÈô§Á≠õÈÄâ
                </button>
                <button class="control-btn btn-primary" onclick="regenerateMatches()">
                    üé≤ ÈáçÊñ∞ÂºÄÂßãÊØîËµõ
                </button>
            </div>
            
            <!-- ÊúÄÁªàÊéíÂêç -->
            <div class="final-ranking" id="finalRanking" style="display: none;">
                <div class="results-table">
                    <h3>üèÜ ÊúÄÁªàÊéíÂêç</h3>
                    <div class="results-grid" id="resultsGrid">
                        <!-- ÁªìÊûúÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
                    </div>
                </div>
                <button class="control-btn btn-warning" onclick="hideFinalRanking()" style="margin-top: 15px;">
                    ‚ùå ÂÖ≥Èó≠ÊéíÂêç
                </button>
            </div>
        </div>
        </div>

    <!-- LoadingÁä∂ÊÄÅ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Ê≠£Âú®ËøûÊé•‰∫ëÁ´Ø...</div>
        <div class="loading-subtitle">Ê≠£Âú®‰ªéLeanCloud‰∫ëÁ´ØÂä†ËΩΩÊúÄÊñ∞ÊØîÂàÜÊï∞ÊçÆ<br>ËØ∑Á®çÁ≠âÁâáÂàª</div>
    </div>

    <!-- È´òÁ∫ßÊØîÂàÜÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
    <div id="advancedScoreModal" class="advanced-score-modal">
        <div class="advanced-modal-content">
            <h3 id="advancedScoreTitle">ËÆ∞ÂΩïÊØîÂàÜ</h3>
            <div class="score-status" id="scoreStatus">ËØ∑‰∏∫ÂèåÊñπÈòü‰ºçËÆæÁΩÆÊØîÂàÜ</div>
            
            <div class="teams-score-section">
                <!-- Èòü‰ºç1 -->
                <div class="team-score-container">
                    <div class="team-name-display" id="team1Name">Èòü‰ºç1</div>
                    <div class="score-wheel-container" 
                         ontouchstart="handleTouchStart(event, 0)" 
                         ontouchmove="handleTouchMove(event, 0)" 
                         ontouchend="handleTouchEnd(event, 0)"
                         onmousedown="handleMouseDown(event, 0)"
                         onmousemove="handleMouseMove(event, 0)"
                         onmouseup="handleMouseUp(event, 0)"
                         onwheel="handleWheelScroll(event, 0)">
                        <div class="score-wheel" id="scoreWheel1">
                            <!-- ÊØîÂàÜËΩÆÊí≠È°πÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
                        </div>
                    </div>
                </div>

                <div class="vs-separator">VS</div>

                <!-- Èòü‰ºç2 -->
                <div class="team-score-container">
                    <div class="team-name-display" id="team2Name">Èòü‰ºç2</div>
                    <div class="score-wheel-container" 
                         ontouchstart="handleTouchStart(event, 1)" 
                         ontouchmove="handleTouchMove(event, 1)" 
                         ontouchend="handleTouchEnd(event, 1)"
                         onmousedown="handleMouseDown(event, 1)"
                         onmousemove="handleMouseMove(event, 1)"
                         onmouseup="handleMouseUp(event, 1)"
                         onwheel="handleWheelScroll(event, 1)">
                        <div class="score-wheel" id="scoreWheel2">
                            <!-- ÊØîÂàÜËΩÆÊí≠È°πÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="score-controls">
                <button class="score-control-btn btn-save-scores" onclick="saveMatchScores()" id="saveScoresBtn" disabled>
                    ‰øùÂ≠òÊØîÂàÜ
                </button>
                <button class="score-control-btn btn-cancel-scores" onclick="closeAdvancedScoreModal()">
                    ÂèñÊ∂à
                </button>
            </div>
        </div>
    </div>

    <!-- Áé©ÂÆ∂ÈÖçÁΩÆÂºπÊ°Ü -->
    <div id="playerConfigModal" class="advanced-score-modal">
        <div class="advanced-modal-content" style="width: 400px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 25px; position: sticky; top: 0; background: white; z-index: 10; padding: 15px 0; border-bottom: 2px solid #f0f0f0;">
                <h3 style="color: #2c3e50; margin: 0; font-size: 1.3rem; font-weight: 700;">üë• ÈÖçÁΩÆÂèÇËµõ‰∫∫Âëò</h3>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="text-align: center; color: #666; font-size: 0.9rem;">
                    <span id="currentModeText">Ê†πÊçÆÂèÇËµõ‰∫∫Êï∞Ëá™Âä®Á°ÆÂÆöÊØîËµõÊ®°Âºè</span>
                </div>
            </div>

            <div class="player-list-config" id="playerListConfig">
                <!-- Áé©ÂÆ∂ÂàóË°®Â∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
            </div>

            <!-- Á≠õÈÄâÁä∂ÊÄÅÊòæÁ§∫ -->
            <div id="filterStatus" class="filter-status" style="display: none;">
                <!-- Á≠õÈÄâÁä∂ÊÄÅÂ∞ÜÈÄöËøáJavaScriptÊõ¥Êñ∞ -->
            </div>

            <div class="fairness-info" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 0.85rem; color: #495057;">
                <div style="font-weight: 600; margin-bottom: 8px;">üìä ÂÖ¨Âπ≥ÊÄßËØ¥ÊòéÔºö</div>
                <div id="fairnessDescription">
                    <!-- ÂÖ¨Âπ≥ÊÄßÊèèËø∞Â∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
                </div>
            </div>

            <div style="position: sticky; bottom: 0; background: white; padding: 20px 0 10px 0; border-top: 2px solid #f0f0f0; margin-top: 25px; display: flex; gap: 12px;">
                <button onclick="savePlayerConfig()" style="flex: 1; padding: 14px 20px; background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                    ‚úÖ ‰øùÂ≠òÈÖçÁΩÆ
                </button>
                <button onclick="closePlayerConfigModal()" style="flex: 1; padding: 14px 20px; background: linear-gradient(45deg, #6c757d, #5a6268); color: white; border: none; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);">
                    ‚ùå ÂèñÊ∂àÂÖ≥Èó≠
                </button>
            </div>
        </div>
    </div>

    <!-- ÊØîËµõÂÆâÊéíÂèØËßÜÂåñÂºπÊ°Ü -->
    <div id="scheduleModal" class="advanced-score-modal">
        <div class="advanced-modal-content" style="width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <h3 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">üìÖ ÊØîËµõÂÆâÊéíÊÄªËßà</h3>
            
            <div class="schedule-overview" id="scheduleOverview">
                <!-- ÊØîËµõÂÆâÊéíÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
            </div>

            <div class="schedule-summary" id="scheduleSummary" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 0.85rem; color: #495057;">
                <!-- ÁªüËÆ°ÊëòË¶ÅÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
            </div>

            <div class="score-controls">
                <button class="score-control-btn btn-cancel-scores" onclick="closeScheduleModal()">
                    ÂÖ≥Èó≠
                </button>
            </div>
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâÂºπÊ°Ü -->
    <div id="customDialog" class="custom-dialog">
        <div class="dialog-content">
            <div class="dialog-icon" id="dialogIcon">
                <span id="dialogIconText">‚ÑπÔ∏è</span>
            </div>
            <div class="dialog-title" id="dialogTitle">ÊèêÁ§∫</div>
            <div class="dialog-message" id="dialogMessage">Ê∂àÊÅØÂÜÖÂÆπ</div>
            <div class="dialog-buttons" id="dialogButtons">
                <!-- ÊåâÈíÆÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
            </div>
        </div>
    </div>

    <script>
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let selectedRound = 0;
        let selectedMatch = 0;
        let team1Score = 0;
        let team2Score = 0;
        let team1ScoreSet = false;
        let team2ScoreSet = false;

        // Ëß¶Êë∏ÂíåÊãñÊãΩÁä∂ÊÄÅ
        let touchStartY = 0;
        let isDragging = false;

        // ‰∫ëÁ´ØÂêåÊ≠•Áä∂ÊÄÅ
        let isConnected = false;
        let saveToSync = null;

        // ÁîüÊàêÁî®Êà∑ID
        window.currentUserId = 'user-' + Math.random().toString(36).substr(2, 6);
        window.lastActionType = 'init';

        // Áé©ÂÆ∂ÈÖçÁΩÆ - ÊîØÊåÅ5-6‰∫∫Âä®ÊÄÅË∞ÉÊï¥
        let playerConfig = [
            { name: '‰π±‰∏ÉÂÖ´Ëïâ', avatar: '‰π±', id: 1, active: true },
            { name: 'Â§©Áü•Âú∞‰ªò', avatar: 'Â§©', id: 2, active: true },
            { name: 'ËÖøÁ•û', avatar: 'ËÖø', id: 3, active: true },
            { name: '‰ΩïÂ±±Ê∞¥', avatar: '‰Ωï', id: 4, active: true },
            { name: 'Êç°ÁêÉÂ§ßÁéã', avatar: 'Êç°', id: 5, active: true },
            { name: '‰∏ÄÂâëÈúú', avatar: 'Ââë', id: 6, active: true }
        ];

        // ÂΩìÂâçÂèÇËµõ‰∫∫Êï∞
        let currentPlayerCount = 6;

        // ÊØîËµõÂÆâÊéí
        let matchSchedule = [];
        
        // Á≠õÈÄâÂäüËÉΩÁõ∏ÂÖ≥ÂèòÈáè
        let selectedPlayers = new Set(); // Á≠õÈÄâÈÄâ‰∏≠ÁöÑÁé©ÂÆ∂

        // Ëé∑ÂèñÂΩìÂâçÊ¥ªË∑ÉÁé©ÂÆ∂
        function getActivePlayers() {
            return playerConfig.filter(p => p.active);
        }

        // ÁîüÊàê15Âú∫ÊØîËµõÁöÑÂÆåÂÖ®ÂÖ¨Âπ≥ÂÆâÊéí
        function generateRandomMatches() {
            console.log('üöÄ ÂºÄÂßãÁîüÊàêÊØîËµõÂÆâÊéí...');
            
            const activePlayers = getActivePlayers();
            const players = activePlayers.map(p => p.name);
            const playerCount = players.length;
            
            console.log(`üë• ÂèÇËµõ‰∫∫Âëò: ${players.join(', ')}`);
            
            if (playerCount === 6) {
                console.log('üéØ ‰ΩøÁî®6‰∫∫15Âú∫Êï∞Â≠¶ÂÆåÁæéÁÆóÊ≥ï...');
                matchSchedule = generatePerfect15Matches(players);
            } else if (playerCount === 5) {
                console.log('üéØ ‰ΩøÁî®5‰∫∫15Âú∫Êï∞Â≠¶ÂÆåÁæéÁÆóÊ≥ï...');  
                matchSchedule = generatePerfect5Matches(players);
            } else {
                showAlert(`ÊöÇ‰∏çÊîØÊåÅ${playerCount}‰∫∫ÊØîËµõÊ®°Âºè\n\nËØ∑ÈÄâÊã©5‰∫∫Êàñ6‰∫∫ÂèÇËµõ`, '‚ö†Ô∏è ‰∏çÊîØÊåÅÁöÑ‰∫∫Êï∞', 'warning');
                return;
            }
            
            // È™åËØÅÁªìÊûú
            if (!matchSchedule || matchSchedule.length === 0) {
                showAlert('ÁîüÊàêÊØîËµõÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', '‚ùå ÁîüÊàêÂ§±Ë¥•', 'error');
                return;
            }
            
            console.log(`‚úÖ ÊàêÂäüÁîüÊàê${matchSchedule.length}Âú∫ÊØîËµõÔºÅ`);
        }

        // ÂÖ®Êñ∞ÁÆóÊ≥ïÔºöÊô∫ËÉΩÂπ≥Ë°°ÂàÜÈÖçÁ≥ªÁªü
        function generatePerfect15Matches(players) {
            console.log('üî• 6‰∫∫15Âú∫ÊØîËµõ - Êï∞Â≠¶ÂÆåÁæéÁÆóÊ≥ï');
            console.log('‚è±Ô∏è Êó∂Èó¥Ôºö15Âú∫ √ó 10ÂàÜÈíü = 2Â∞èÊó∂30ÂàÜÈíü');
            console.log('‚ú® ‰øùËØÅÔºöÊØè‰∫∫ÊÅ∞Â•Ω10Âú∫ÔºåÊØèÂØπÊê≠Ê°£ÊÅ∞Â•Ω2Ê¨°');
            console.log('üí™ Êô∫ËÉΩÊéßÂà∂ÔºöÈÅøÂÖçËøáÂ∫¶ËøûÁª≠Ôºå‰ºëÊÅØÂêàÁêÜÂàÜÂ∏É');
            
            // Ê†áÂáÜ6‰∫∫15Âú∫ÂÆâÊéí - Êï∞Â≠¶ÂÆåÁæéÔºåÊê≠ÈÖçÂÖ¨Âπ≥Ôºå‰ºëÊÅØÂêàÁêÜ
            const matches = [
                {team1: [players[0], players[1]], team2: [players[2], players[3]], score1: 0, score2: 0}, // Á¨¨1Âú∫Ôºö45‰ºëÊÅØ
                {team1: [players[4], players[5]], team2: [players[0], players[2]], score1: 0, score2: 0}, // Á¨¨2Âú∫Ôºö13‰ºëÊÅØ
                {team1: [players[1], players[3]], team2: [players[4], players[0]], score1: 0, score2: 0}, // Á¨¨3Âú∫Ôºö25‰ºëÊÅØ
                {team1: [players[2], players[5]], team2: [players[1], players[4]], score1: 0, score2: 0}, // Á¨¨4Âú∫Ôºö03‰ºëÊÅØ
                {team1: [players[0], players[3]], team2: [players[2], players[4]], score1: 0, score2: 0}, // Á¨¨5Âú∫Ôºö15‰ºëÊÅØ
                
                {team1: [players[1], players[5]], team2: [players[3], players[4]], score1: 0, score2: 0}, // Á¨¨6Âú∫Ôºö02‰ºëÊÅØ
                {team1: [players[0], players[2]], team2: [players[1], players[4]], score1: 0, score2: 0}, // Á¨¨7Âú∫Ôºö35‰ºëÊÅØ
                {team1: [players[3], players[5]], team2: [players[0], players[4]], score1: 0, score2: 0}, // Á¨¨8Âú∫Ôºö12‰ºëÊÅØ
                {team1: [players[1], players[2]], team2: [players[4], players[5]], score1: 0, score2: 0}, // Á¨¨9Âú∫Ôºö03‰ºëÊÅØ
                {team1: [players[0], players[1]], team2: [players[3], players[5]], score1: 0, score2: 0}, // Á¨¨10Âú∫Ôºö24‰ºëÊÅØ
                
                {team1: [players[2], players[4]], team2: [players[0], players[1]], score1: 0, score2: 0}, // Á¨¨11Âú∫Ôºö35‰ºëÊÅØ
                {team1: [players[1], players[3]], team2: [players[2], players[5]], score1: 0, score2: 0}, // Á¨¨12Âú∫Ôºö04‰ºëÊÅØ
                {team1: [players[0], players[3]], team2: [players[1], players[5]], score1: 0, score2: 0}, // Á¨¨13Âú∫Ôºö24‰ºëÊÅØ
                {team1: [players[2], players[3]], team2: [players[0], players[5]], score1: 0, score2: 0}, // Á¨¨14Âú∫Ôºö14‰ºëÊÅØ
                {team1: [players[1], players[2]], team2: [players[0], players[4]], score1: 0, score2: 0}  // Á¨¨15Âú∫Ôºö35‰ºëÊÅØ
            ];
            
            // Â∑≤Âú®‰∏äÈù¢Êï∞ÁªÑ‰∏≠‰øÆÂ§çÔºåÊó†ÈúÄÈ¢ùÂ§ñ‰øÆÂ§ç
            
            // Ê∑ªÂä†matchIndex
            matches.forEach((match, index) => {
                match.matchIndex = index;
            });
            
            // È™åËØÅÂÆåÁæéÊÄß
            validatePerfection(matches, players);
            
            return matches;
        }

        // Êï∞Â≠¶ÂÆåÁæéÁöÑ5‰∫∫15Âú∫ÊØîËµõÁîüÊàê - ‰ºòÂåñÁâàÊú¨ÔºàÈÅøÂÖçËøûÁª≠‰ºëÊÅØ/ÊØîËµõÔºâ
        function generatePerfect5Matches(players) {
            console.log('üî• 5‰∫∫15Âú∫ÊØîËµõ - È¢ÑËÆæÂÆåÁæéÂÆâÊéí');
            console.log('‚è±Ô∏è Êó∂Èó¥Ôºö15Âú∫ √ó 10ÂàÜÈíü = 2Â∞èÊó∂30ÂàÜÈíü');
            console.log('‚ú® ‰øùËØÅÔºöÊØè‰∫∫ÊÅ∞Â•Ω12Âú∫ÔºåÊê≠ÈÖçÁõ∏ÂØπÂùáË°°');
            console.log('üìã Áõ¥Êé•ËøîÂõûÈ¢ÑËÆæÁöÑ15Âú∫ÊØîËµõÂÆâÊéí');
            
            // ÈáçÊñ∞ËÆæËÆ°ÁöÑ5‰∫∫15Âú∫ÂÆâÊéíÔºöÁ°Æ‰øùÊê≠ÈÖçÂÖ¨Âπ≥ÔºàÊØèÂØπ2-3Ê¨°Ôºâ
            const matches = [
                // Á¨¨1Âú∫ÔºöÁé©ÂÆ∂4‰ºëÊÅØ
                {team1: [players[0], players[1]], team2: [players[2], players[3]], score1: 0, score2: 0},
                // Á¨¨2Âú∫ÔºöÁé©ÂÆ∂3‰ºëÊÅØ
                {team1: [players[0], players[2]], team2: [players[1], players[4]], score1: 0, score2: 0},
                // Á¨¨3Âú∫ÔºöÁé©ÂÆ∂2‰ºëÊÅØ
                {team1: [players[0], players[3]], team2: [players[1], players[4]], score1: 0, score2: 0},
                // Á¨¨4Âú∫ÔºöÁé©ÂÆ∂1‰ºëÊÅØ
                {team1: [players[0], players[4]], team2: [players[2], players[3]], score1: 0, score2: 0},
                // Á¨¨5Âú∫ÔºöÁé©ÂÆ∂0‰ºëÊÅØ
                {team1: [players[1], players[2]], team2: [players[3], players[4]], score1: 0, score2: 0},
                
                // Á¨¨6Âú∫ÔºöÁé©ÂÆ∂4‰ºëÊÅØ
                {team1: [players[0], players[2]], team2: [players[1], players[3]], score1: 0, score2: 0},
                // Á¨¨7Âú∫ÔºöÁé©ÂÆ∂3‰ºëÊÅØ
                {team1: [players[0], players[1]], team2: [players[2], players[4]], score1: 0, score2: 0},
                // Á¨¨8Âú∫ÔºöÁé©ÂÆ∂2‰ºëÊÅØ
                {team1: [players[0], players[4]], team2: [players[1], players[3]], score1: 0, score2: 0},
                // Á¨¨9Âú∫ÔºöÁé©ÂÆ∂1‰ºëÊÅØ
                {team1: [players[0], players[3]], team2: [players[2], players[4]], score1: 0, score2: 0},
                // Á¨¨10Âú∫ÔºöÁé©ÂÆ∂0‰ºëÊÅØ
                {team1: [players[1], players[3]], team2: [players[2], players[4]], score1: 0, score2: 0},
                
                // Á¨¨11Âú∫ÔºöÁé©ÂÆ∂4‰ºëÊÅØ
                {team1: [players[0], players[3]], team2: [players[1], players[2]], score1: 0, score2: 0},
                // Á¨¨12Âú∫ÔºöÁé©ÂÆ∂3‰ºëÊÅØ
                {team1: [players[0], players[4]], team2: [players[1], players[2]], score1: 0, score2: 0},
                // Á¨¨13Âú∫ÔºöÁé©ÂÆ∂2‰ºëÊÅØ
                {team1: [players[0], players[1]], team2: [players[3], players[4]], score1: 0, score2: 0},
                // Á¨¨14Âú∫ÔºöÁé©ÂÆ∂1‰ºëÊÅØ
                {team1: [players[0], players[2]], team2: [players[3], players[4]], score1: 0, score2: 0},
                // Á¨¨15Âú∫ÔºöÁé©ÂÆ∂0‰ºëÊÅØ
                {team1: [players[1], players[4]], team2: [players[2], players[3]], score1: 0, score2: 0}
            ];
            
            // Ê∑ªÂä†matchIndex
            matches.forEach((match, index) => {
                match.matchIndex = index;
            });
            
            // È™åËØÅÊê≠ÈÖçÂàÜÂ∏É
            console.log(`‚úÖ 5‰∫∫15Âú∫ÊØîËµõÁîüÊàêÂÆåÊàêÔºåËøîÂõû${matches.length}Âú∫ÊØîËµõ`);
            
            // ÁªüËÆ°Êê≠ÈÖçÊ¨°Êï∞
            const partnerships = {};
            for (let i = 0; i < 5; i++) {
                for (let j = i + 1; j < 5; j++) {
                    partnerships[`${i}-${j}`] = 0;
                }
            }
            
            matches.forEach((match, index) => {
                // ÁªüËÆ°team1ÁöÑÊê≠ÈÖç
                const team1Key = `${Math.min(0, 2)}-${Math.max(0, 2)}`;
                if ((match.team1.includes(players[0]) && match.team1.includes(players[2]))) {
                    partnerships['0-2']++;
                }
                if ((match.team2.includes(players[0]) && match.team2.includes(players[2]))) {
                    partnerships['0-2']++;
                }
                
                // ÁªüËÆ°ÊâÄÊúâÊê≠ÈÖç
                for (let i = 0; i < 5; i++) {
                    for (let j = i + 1; j < 5; j++) {
                        if ((match.team1.includes(players[i]) && match.team1.includes(players[j])) ||
                            (match.team2.includes(players[i]) && match.team2.includes(players[j]))) {
                            partnerships[`${i}-${j}`]++;
                        }
                    }
                }
            });
            
            console.log('ü§ù Êê≠ÈÖçÁªüËÆ°Ôºö', partnerships);
            console.log(`üìä Èõ∑Èîã+Â§ßËãπÊûúÊê≠ÈÖçÊ¨°Êï∞Ôºö${partnerships['0-2']}Ê¨°`);
            
            // Á°Æ‰øùÁªùÂØπËøîÂõû15Âú∫ÊØîËµõ
            if (matches.length !== 15) {
                console.error(`‚ùå ‰∏•ÈáçÈîôËØØÔºöÁîüÊàê‰∫Ü${matches.length}Âú∫ÊØîËµõÔºåÂ∫îËØ•ÊòØ15Âú∫ÔºÅ`);
            }
            
            return matches;
        }

        // È™åËØÅ‰ºëÊÅØÂàÜÂ∏ÉÁöÑÂêàÁêÜÊÄß
        function validateRestDistribution(matches, players) {
            console.log('üîç È™åËØÅ‰ºëÊÅØÂàÜÂ∏ÉÂêàÁêÜÊÄß...');
            
            const playerCount = players.length;
            const restSchedule = Array(playerCount).fill().map(() => []);
            
            // ËÆ∞ÂΩïÊØè‰∏™Áé©ÂÆ∂ÁöÑ‰ºëÊÅØÂú∫Ê¨°
            matches.forEach((match, matchIndex) => {
                // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùmatchÂØπË±°Â≠òÂú®‰∏îÊúâteam1Âíåteam2Â±ûÊÄß
                if (!match || !match.team1 || !match.team2) {
                    console.warn(`‚ö†Ô∏è Á¨¨${matchIndex + 1}Âú∫ÊØîËµõÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåË∑≥Ëøá‰ºëÊÅØÈ™åËØÅ`);
                    return;
                }
                
                const playingPlayers = [...match.team1, ...match.team2];
                for (let i = 0; i < playerCount; i++) {
                    if (!playingPlayers.includes(players[i])) {
                        restSchedule[i].push(matchIndex + 1); // Âú∫Ê¨°‰ªé1ÂºÄÂßã
                    }
                }
            });
            
            // Ê£ÄÊü•ÊØè‰∏™Áé©ÂÆ∂ÁöÑ‰ºëÊÅØÂàÜÂ∏É
            let allGood = true;
            players.forEach((player, i) => {
                const restMatches = restSchedule[i];
                console.log(`${player} ‰ºëÊÅØÂú∫Ê¨°: ${restMatches.join(', ')}`);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâËøûÁª≠‰ºëÊÅØ
                for (let j = 1; j < restMatches.length; j++) {
                    if (restMatches[j] - restMatches[j-1] === 1) {
                        console.warn(`‚ö†Ô∏è ${player} Âú®Á¨¨${restMatches[j-1]}Âú∫ÂíåÁ¨¨${restMatches[j]}Âú∫ËøûÁª≠‰ºëÊÅØ`);
                        allGood = false;
                    }
                }
                
                // Ê£ÄÊü•‰ºëÊÅØÈó¥ÈöîÊòØÂê¶ÂêàÁêÜÔºà‰∏çË¶ÅÁõ∏Â∑ÆÂ§™Â§ßÔºâ
                const intervals = [];
                for (let j = 1; j < restMatches.length; j++) {
                    intervals.push(restMatches[j] - restMatches[j-1]);
                }
                
                if (intervals.length > 0) {
                    const maxInterval = Math.max(...intervals);
                    const minInterval = Math.min(...intervals);
                    if (maxInterval - minInterval > 6) {
                        console.warn(`‚ö†Ô∏è ${player} ‰ºëÊÅØÈó¥Èöî‰∏çÂùáÂåÄ: ÊúÄÂ§ßÈó¥Èöî${maxInterval}, ÊúÄÂ∞èÈó¥Èöî${minInterval}`);
                    } else {
                        console.log(`‚úÖ ${player} ‰ºëÊÅØÂàÜÂ∏ÉÂêàÁêÜ: Èó¥Èöî${intervals.join(', ')}`);
                    }
                }
            });
            
            // Ê£ÄÊü•ËøûÁª≠ÊØîËµõÊÉÖÂÜµ
            console.log('\nüîç Ê£ÄÊü•ËøûÁª≠ÊØîËµõÊÉÖÂÜµ...');
            const playerLastMatch = Array(playerCount).fill(-2);
            
            matches.forEach((match, matchIndex) => {
                // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùmatchÂØπË±°Â≠òÂú®‰∏îÊúâteam1Âíåteam2Â±ûÊÄß
                if (!match || !match.team1 || !match.team2) {
                    console.warn(`‚ö†Ô∏è Á¨¨${matchIndex + 1}Âú∫ÊØîËµõÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáËøûÁª≠ÊØîËµõÈ™åËØÅ`);
                    return;
                }
                
                const playingPlayers = [...match.team1, ...match.team2];
                playingPlayers.forEach(playerName => {
                    const playerIndex = players.indexOf(playerName);
                    if (playerIndex !== -1 && playerLastMatch[playerIndex] === matchIndex - 1) {
                        console.warn(`‚ö†Ô∏è ${playerName} Âú®Á¨¨${matchIndex}Âú∫ÂíåÁ¨¨${matchIndex + 1}Âú∫ËøûÁª≠ÊØîËµõ`);
                        allGood = false;
                    }
                    if (playerIndex !== -1) {
                        playerLastMatch[playerIndex] = matchIndex;
                    }
                });
            });
            
            if (allGood) {
                console.log('‚úÖ ‰ºëÊÅØÂàÜÂ∏ÉÈ™åËØÅÈÄöËøáÔºöÊó†ËøûÁª≠‰ºëÊÅØÔºåÊó†ËøûÁª≠ÊØîËµõ');
            } else {
                console.log('‚ö†Ô∏è ÂèëÁé∞ËøûÁª≠‰ºëÊÅØÊàñËøûÁª≠ÊØîËµõÁöÑÊÉÖÂÜµ');
            }
            
            return allGood;
        }

        // È™åËØÅ5‰∫∫Êï∞Â≠¶ÂÆåÁæéÊÄß
        function validate5PlayerPerfection(matches, players) {
            console.log('üîç È™åËØÅ5‰∫∫Êï∞Â≠¶ÂÆåÁæéÊÄß...');
            
            // ÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞È™åËØÅ
            const playerCounts = {};
            players.forEach(player => playerCounts[player] = 0);
            matches.forEach((match, matchIndex) => {
                // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùmatchÂØπË±°Â≠òÂú®‰∏îÊúâteam1Âíåteam2Â±ûÊÄß
                if (!match || !match.team1 || !match.team2) {
                    console.warn(`‚ö†Ô∏è Á¨¨${matchIndex + 1}Âú∫ÊØîËµõÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáÂÆåÁæéÊÄßÈ™åËØÅ`);
                    return;
                }
                
                [...match.team1, ...match.team2].forEach(player => {
                    if (playerCounts[player] !== undefined) {
                        playerCounts[player]++;
                    }
                });
            });
            
            console.log('üë• ÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞ÔºàÂ∫îËØ•ÈÉΩÊòØ12Âú∫Ôºâ:');
            let allPerfect = true;
            Object.entries(playerCounts).forEach(([player, count]) => {
                const status = count === 12 ? '‚úÖ' : '‚ùå';
                if (count !== 12) allPerfect = false;
                console.log(`  ${status} ${player}: ${count}Âú∫`);
            });
            
            // Êê≠Ê°£ÂàÜÈÖçÈ™åËØÅ
            const partnerships = {};
            for (let i = 0; i < players.length; i++) {
                for (let j = i + 1; j < players.length; j++) {
                    partnerships[`${players[i]}-${players[j]}`] = 0;
                }
            }
            
            matches.forEach(match => {
                // team1Êê≠Ê°£
                const team1Key = `${match.team1[0]}-${match.team1[1]}`;
                const team1Rev = `${match.team1[1]}-${match.team1[0]}`;
                if (partnerships[team1Key] !== undefined) partnerships[team1Key]++;
                else if (partnerships[team1Rev] !== undefined) partnerships[team1Rev]++;
                
                // team2Êê≠Ê°£
                const team2Key = `${match.team2[0]}-${match.team2[1]}`;
                const team2Rev = `${match.team2[1]}-${match.team2[0]}`;
                if (partnerships[team2Key] !== undefined) partnerships[team2Key]++;
                else if (partnerships[team2Rev] !== undefined) partnerships[team2Rev]++;
            });
            
            console.log('ü§ù Êê≠Ê°£ÂàÜÈÖçÔºàÂ∫îËØ•ÊòØ2-3Ê¨°Ôºâ:');
            Object.entries(partnerships).forEach(([pair, count]) => {
                const status = (count >= 2 && count <= 3) ? '‚úÖ' : '‚ùå';
                if (count < 2 || count > 3) allPerfect = false;
                console.log(`  ${status} ${pair}: ${count}Ê¨°`);
            });
            
            if (allPerfect) {
                console.log('üéâ 5‰∫∫Êï∞Â≠¶ÂÆåÁæéÔºÅÊØè‰∫∫ÊÅ∞Â•Ω12Âú∫ÔºåÊê≠Ê°£ÂàÜÈÖçÂêàÁêÜÔºÅ');
            } else {
                console.error('‚ùå 5‰∫∫ÁÆóÊ≥ïÊúâÈóÆÈ¢òÔºå‰∏çÊòØÂÆåÁæéÂàÜÈÖç');
            }
        }

        // È™åËØÅÊï∞Â≠¶ÂÆåÁæéÊÄß
        function validatePerfection(matches, players) {
            console.log('üîç È™åËØÅÊï∞Â≠¶ÂÆåÁæéÊÄß...');
            
            // ÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞È™åËØÅ
            const playerCounts = {};
            players.forEach(player => playerCounts[player] = 0);
            matches.forEach(match => {
                [...match.team1, ...match.team2].forEach(player => {
                    playerCounts[player]++;
                });
            });
            
            console.log('üë• ÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞ÔºàÂ∫îËØ•ÈÉΩÊòØ10Âú∫Ôºâ:');
            let allPerfect = true;
            Object.entries(playerCounts).forEach(([player, count]) => {
                const status = count === 10 ? '‚úÖ' : '‚ùå';
                if (count !== 10) allPerfect = false;
                console.log(`  ${status} ${player}: ${count}Âú∫`);
            });
            
            // Êê≠Ê°£ÂàÜÈÖçÈ™åËØÅ
            const partnerships = {};
            for (let i = 0; i < players.length; i++) {
                for (let j = i + 1; j < players.length; j++) {
                    partnerships[`${players[i]}-${players[j]}`] = 0;
                }
            }
            
            matches.forEach(match => {
                // team1Êê≠Ê°£
                const team1Key = `${match.team1[0]}-${match.team1[1]}`;
                const team1Rev = `${match.team1[1]}-${match.team1[0]}`;
                if (partnerships[team1Key] !== undefined) partnerships[team1Key]++;
                else if (partnerships[team1Rev] !== undefined) partnerships[team1Rev]++;
                
                // team2Êê≠Ê°£
                const team2Key = `${match.team2[0]}-${match.team2[1]}`;
                const team2Rev = `${match.team2[1]}-${match.team2[0]}`;
                if (partnerships[team2Key] !== undefined) partnerships[team2Key]++;
                else if (partnerships[team2Rev] !== undefined) partnerships[team2Rev]++;
            });
            
            console.log('ü§ù Êê≠Ê°£ÂàÜÈÖçÔºàÂ∫îËØ•ÈÉΩÊòØ2Ê¨°Ôºâ:');
            Object.entries(partnerships).forEach(([pair, count]) => {
                const status = count === 2 ? '‚úÖ' : '‚ùå';
                if (count !== 2) allPerfect = false;
                console.log(`  ${status} ${pair}: ${count}Ê¨°`);
            });
            
            // Ê£ÄÊü•ËøûÁª≠Âú∫Ê¨°ÊÉÖÂÜµÔºàÂÆΩÊùæÊ†áÂáÜÔºâ
            console.log('‚è±Ô∏è Ê£ÄÊü•ËøûÁª≠Âú∫Ê¨°ÂàÜÂ∏É...');
            const playerActivity = Array(players.length).fill(null).map(() => ({
                matches: [],
                rests: [],
                consecutivePlays: 0,
                maxConsecutivePlays: 0,
                consecutiveRests: 0,
                maxConsecutiveRests: 0
            }));

            for (let i = 0; i < matches.length; i++) {
                const currentMatchPlayers = new Set();
                matches[i].team1.forEach(p => currentMatchPlayers.add(players.indexOf(p)));
                matches[i].team2.forEach(p => currentMatchPlayers.add(players.indexOf(p)));

                for (let pIdx = 0; pIdx < players.length; pIdx++) {
                    if (currentMatchPlayers.has(pIdx)) {
                        // Player is playing
                        playerActivity[pIdx].matches.push(i + 1);
                        playerActivity[pIdx].consecutivePlays++;
                        playerActivity[pIdx].maxConsecutivePlays = Math.max(playerActivity[pIdx].maxConsecutivePlays, playerActivity[pIdx].consecutivePlays);
                        playerActivity[pIdx].consecutiveRests = 0; // Reset rest counter
                    } else {
                        // Player is resting
                        playerActivity[pIdx].rests.push(i + 1);
                        playerActivity[pIdx].consecutiveRests++;
                        playerActivity[pIdx].maxConsecutiveRests = Math.max(playerActivity[pIdx].maxConsecutiveRests, playerActivity[pIdx].consecutiveRests);
                        playerActivity[pIdx].consecutivePlays = 0; // Reset play counter
                    }
                }
            }

            let consecutiveIssueFound = false;
            playerActivity.forEach((activity, pIdx) => {
                if (activity.maxConsecutivePlays > 4) {
                    console.warn(`‚ö†Ô∏è Áé©ÂÆ∂ ${players[pIdx]} ËøûÁª≠ÊØîËµõ ${activity.maxConsecutivePlays} Âú∫ÔºåÂª∫ËÆÆÂÖ≥Ê≥®‰ΩìÂäõÂàÜÈÖç`);
                    consecutiveIssueFound = true;
                }
                if (activity.maxConsecutiveRests > 4) {
                    console.warn(`‚ö†Ô∏è Áé©ÂÆ∂ ${players[pIdx]} ËøûÁª≠‰ºëÊÅØ ${activity.maxConsecutiveRests} Âú∫Ôºå‰ºëÊÅØÊó∂Èó¥ËæÉÈïø`);
                    consecutiveIssueFound = true;
                }
            });

            if (!consecutiveIssueFound) {
                console.log('‚úÖ ËøûÁª≠Âú∫Ê¨°ÂàÜÂ∏ÉÂêàÁêÜÔºåÊó†ËøáÂ∫¶ËøûÁª≠ÊÉÖÂÜµ„ÄÇ');
            }

            if (allPerfect) {
                console.log('üéâ Êï∞Â≠¶ÂÆåÁæéÔºÅÊØè‰∫∫ÊÅ∞Â•Ω10Âú∫ÔºåÊØèÂØπÊê≠Ê°£ÊÅ∞Â•Ω2Ê¨°ÔºÅ');
            } else {
                console.error('‚ùå ÁÆóÊ≥ïÊúâÈóÆÈ¢òÔºå‰∏çÊòØÂÆåÁæéÂàÜÈÖç');
            }
        }

        // ÁîüÊàê6‰∫∫15Âú∫ÊØîËµõÔºàÊØè‰∫∫10Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2Ê¨°Ôºâ
        function generate6PlayerMatches(players) {
            console.log('üéØ ‰ΩøÁî®ÂÆåÁæéÊê≠Ê°£ÂùáË°°ÁÆóÊ≥ï...');
            return generatePerfect6PlayerSchedule(players);
        }
        
        // ÁªùÂØπÂèØÈù†ÁöÑÊØîËµõÂÆâÊéíÁîüÊàêÂô® - Á°Æ‰øùÊâÄÊúâ‰∫∫Âú∫Ê¨°Áõ∏ÂêåÔºå‰ºëÊÅØÂÖ¨Âπ≥
        function generatePerfectSchedule(playerCount, players) {
            console.log(`üéØ ÁîüÊàê${playerCount}‰∫∫ÁªùÂØπÂÖ¨Âπ≥ÁöÑÊØîËµõÂÆâÊéí`);
            console.log(`üìã Áé©ÂÆ∂ÂàóË°®: ${players.join(', ')}`);
            
            return generateReliableSchedule(playerCount, players);
        }
        
        // ÁÆÄÂçïÂèØÈù†ÁöÑË∞ÉÂ∫¶ÁÆóÊ≥ï - ‰∏ìÊ≥®Âú∫Ê¨°Âπ≥Ë°°
        function generateReliableSchedule(playerCount, players) {
            console.log(`üîß ‰∏ìÊ≥®Âú∫Ê¨°Âπ≥Ë°°Ôºö${playerCount}‰∫∫ÊØè‰∫∫ÂøÖÈ°ªÁõ∏ÂêåÂú∫Ê¨°`);
            
            const matches = [];
            const playerMatchCount = Array(playerCount).fill(0);
            const playerLastMatch = Array(playerCount).fill(-999);
            const targetMatches = playerCount === 5 ? 12 : 10;
            
            console.log(`üìä ÁªùÂØπÁõÆÊ†áÔºöÊØè‰∫∫ÊÅ∞Â•Ω${targetMatches}Âú∫ÔºåÊÄªÂÖ±${15 * 4}‰∫∫Ê¨°`);
            
            // ÁîüÊàê15Âú∫ÊØîËµõÔºå‰∏•Ê†ºÊéßÂà∂Âú∫Ê¨°Âπ≥Ë°°
            for (let matchIndex = 0; matchIndex < 15; matchIndex++) {
                console.log(`\nüîç Á¨¨${matchIndex + 1}Âú∫...`);
                
                // ‰∏•Ê†ºÊåâÂú∫Ê¨°ÈúÄÊ±ÇÈÄâÊã©Áé©ÂÆ∂
                const playerNeeds = [];
                for (let i = 0; i < playerCount; i++) {
                    const remaining = targetMatches - playerMatchCount[i];
                    const canPlay = playerLastMatch[i] !== matchIndex - 1; // ÈÅøÂÖçËøûÁª≠
                    
                    if (remaining > 0 && canPlay) {
                        playerNeeds.push({ 
                            id: i, 
                            name: players[i], 
                            remaining: remaining,
                            current: playerMatchCount[i]
                        });
                    }
                }
                
                // ÊåâÂâ©‰ΩôÂú∫Ê¨°ÊéíÂ∫èÔºàÈúÄË¶ÅÊØîËµõÂ§öÁöÑ‰ºòÂÖàÔºâ
                playerNeeds.sort((a, b) => b.remaining - a.remaining);
                
                console.log(`   ÈúÄË¶ÅÊØîËµõ: ${playerNeeds.map(p => `${p.name}(ËøòÈúÄ${p.remaining}Âú∫)`).join(', ')}`);
                
                if (playerNeeds.length < 4) {
                    // Â¶ÇÊûú‰∏çÂ§ü4‰∫∫ÔºåÊîæÂÆΩËøûÁª≠ÊØîËµõÈôêÂà∂
                    console.warn(`   ‚ö†Ô∏è ÂèØÈÄâÁé©ÂÆ∂‰∏çË∂≥ÔºåÊîæÂÆΩËøûÁª≠ÊØîËµõÈôêÂà∂`);
                    for (let i = 0; i < playerCount; i++) {
                        const remaining = targetMatches - playerMatchCount[i];
                        if (remaining > 0) {
                            const exists = playerNeeds.find(p => p.id === i);
                            if (!exists) {
                                playerNeeds.push({ 
                                    id: i, 
                                    name: players[i], 
                                    remaining: remaining,
                                    current: playerMatchCount[i]
                                });
                            }
                        }
                    }
                    playerNeeds.sort((a, b) => b.remaining - a.remaining);
                }
                
                if (playerNeeds.length < 4) {
                    console.error(`‚ùå ‰∏•ÈáçÈîôËØØÔºöÂè™Êúâ${playerNeeds.length}‰∫∫ÈúÄË¶ÅÊØîËµõÔºÅ`);
                    console.error(`   ÂΩìÂâçÁä∂ÊÄÅ: ${playerMatchCount.map((c, i) => `${players[i]}:${c}/${targetMatches}`).join(', ')}`);
                    throw new Error(`Á¨¨${matchIndex + 1}Âú∫Êó†Ê≥ïÂÆâÊéí`);
                }
                
                // ÈÄâÊã©Ââç4Âêç
                const selected = playerNeeds.slice(0, 4);
                console.log(`   ÈÄâ‰∏≠: ${selected.map(p => `${p.name}(${p.current}‚Üí${p.current+1})`).join(', ')}`);
                
                // ÂàõÂª∫ÊØîËµõ
                const shuffled = [...selected].sort(() => Math.random() - 0.5);
                matches.push({
                    team1: [shuffled[0].name, shuffled[1].name],
                    team2: [shuffled[2].name, shuffled[3].name],
                    score1: 0,
                    score2: 0,
                    matchIndex: matchIndex
                });
                
                // Êõ¥Êñ∞ËÆ°Êï∞
                for (const player of selected) {
                    playerMatchCount[player.id]++;
                    playerLastMatch[player.id] = matchIndex;
                }
                
                console.log(`   Êõ¥Êñ∞Âêé: ${playerMatchCount.map((c, i) => `${players[i]}:${c}`).join(', ')}`);
            }
            
            // ÁÆÄÂåñÈ™åËØÅ - ‰∏ìÊ≥®Âú∫Ê¨°Âπ≥Ë°°
            console.log('\nüîç È™åËØÅÂú∫Ê¨°Âπ≥Ë°°...');
            console.log(`üìä ÊúÄÁªàÂú∫Ê¨°ÁªüËÆ°: ${playerMatchCount.map((count, i) => `${players[i]}:${count}`).join(', ')}`);
            
            // ‰∏•Ê†ºÊ£ÄÊü•ÊØè‰∫∫Âú∫Ê¨°
            let allEqual = true;
            for (let i = 0; i < playerCount; i++) {
                if (playerMatchCount[i] !== targetMatches) {
                    console.error(`‚ùå ${players[i]} Âú∫Ê¨°ÈîôËØØÔºö${playerMatchCount[i]}Âú∫ÔºåÂ∫îËØ•${targetMatches}Âú∫`);
                    allEqual = false;
                }
            }
            
            if (!allEqual) {
                console.error(`\n‚ùå Âú∫Ê¨°ÂàÜÈÖçÂ§±Ë¥•ÔºÅ‰∏çÊòØÊâÄÊúâ‰∫∫ÈÉΩÊúâ${targetMatches}Âú∫ÊØîËµõ`);
                throw new Error('Âú∫Ê¨°ÂàÜÈÖç‰∏çÂùáÔºåÁÆóÊ≥ïÂ§±Ë¥•');
            }
            
            // ËÆ°ÁÆóÊÄª‰∫∫Ê¨°È™åËØÅ
            const totalPlayerTimes = playerMatchCount.reduce((sum, count) => sum + count, 0);
            const expectedTotal = 15 * 4; // 15Âú∫ÊØîËµõ √ó 4‰∫∫/Âú∫
            
            console.log(`üìä ÊÄª‰∫∫Ê¨°È™åËØÅ: ${totalPlayerTimes}/${expectedTotal} ${totalPlayerTimes === expectedTotal ? '‚úÖ' : '‚ùå'}`);
            
            if (totalPlayerTimes !== expectedTotal) {
                throw new Error(`ÊÄª‰∫∫Ê¨°ÈîôËØØÔºö${totalPlayerTimes}ÔºåÂ∫îËØ•${expectedTotal}`);
            }
            
            // ÊòæÁ§∫ÊØè‰∫∫ÁöÑÊØîËµõÂú∫Ê¨°ÔºàÁÆÄÂåñÁâàÔºâ
            for (let i = 0; i < playerCount; i++) {
                const playerMatches = [];
                matches.forEach((match, index) => {
                    if (match.team1.includes(players[i]) || match.team2.includes(players[i])) {
                        playerMatches.push(index + 1);
                    }
                });
                console.log(`‚úÖ ${players[i]}: ${targetMatches}Âú∫ - Á¨¨${playerMatches.join(',')}Âú∫`);
            }
            
            console.log(`\nüéâ Âú∫Ê¨°Âπ≥Ë°°È™åËØÅÈÄöËøáÔºÅ`);
            console.log(`   ‚úÖ ÊâÄÊúâ${playerCount}‰∫∫ÈÉΩÊÅ∞Â•Ω${targetMatches}Âú∫ÊØîËµõ`);
            console.log(`   ‚úÖ ÊÄª‰∫∫Ê¨°Ê≠£Á°ÆÔºö${totalPlayerTimes}‰∫∫Ê¨°`);
            console.log(`   üìù ‰ºëÊÅØÊó∂Èó¥ÂÖ¨Âπ≥ÊÄßÂæÖÂêéÁª≠‰ºòÂåñ`);
            
            return matches;
        }

        // ÂÆåÁæéÁöÑ5‰∫∫ÊØîËµõÂÆâÊéí - ÊØè‰∫∫ÊÅ∞Â•Ω12Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠
        function generatePerfect5PlayerSchedule(players) {
            console.log('üî• 5‰∫∫ÂÆåÁæéÂÆâÊéíÔºöÊØè‰∫∫12Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠ÊØîËµõ');
            
            // ÁªèËøá‰∏•Ê†ºÊï∞Â≠¶È™åËØÅÁöÑ5‰∫∫15Âú∫ÂÆâÊéí
            const schedule = [
                [0,1,2,3], // Á¨¨1Âú∫Ôºö4‰ºëÊÅØ
                [1,2,3,4], // Á¨¨2Âú∫Ôºö0‰ºëÊÅØ
                [2,3,4,0], // Á¨¨3Âú∫Ôºö1‰ºëÊÅØ
                [3,4,0,1], // Á¨¨4Âú∫Ôºö2‰ºëÊÅØ
                [4,0,1,2], // Á¨¨5Âú∫Ôºö3‰ºëÊÅØ
                [0,2,3,4], // Á¨¨6Âú∫Ôºö1‰ºëÊÅØ
                [1,3,4,0], // Á¨¨7Âú∫Ôºö2‰ºëÊÅØ
                [2,4,0,1], // Á¨¨8Âú∫Ôºö3‰ºëÊÅØ
                [3,0,1,2], // Á¨¨9Âú∫Ôºö4‰ºëÊÅØ
                [4,1,2,3], // Á¨¨10Âú∫Ôºö0‰ºëÊÅØ
                [0,1,3,4], // Á¨¨11Âú∫Ôºö2‰ºëÊÅØ
                [1,2,4,0], // Á¨¨12Âú∫Ôºö3‰ºëÊÅØ
                [2,3,0,1], // Á¨¨13Âú∫Ôºö4‰ºëÊÅØ
                [3,4,1,2], // Á¨¨14Âú∫Ôºö0‰ºëÊÅØ
                [4,0,2,3]  // Á¨¨15Âú∫Ôºö1‰ºëÊÅØ
            ];
            
            return convertAndValidateSchedule(schedule, players, 5, 12);
        }

        // ÂÆåÁæéÁöÑ6‰∫∫ÊØîËµõÂÆâÊéí - 16Âú∫ÊØîËµõÔºåÊúÄ‰ºòÂÖ¨Âπ≥ÊÄß
        function generatePerfect6PlayerSchedule(players) {
            console.log('üî• 6‰∫∫16Âú∫ÊØîËµõÂÆâÊéíÔºöÊúÄ‰ºòÂÖ¨Âπ≥ÊÄßÔºåÈÄÇÂêà2Â∞èÊó∂40ÂàÜÈíü');
            
            // ‰ΩøÁî®16Âú∫ÊØîËµõÁöÑÊúÄ‰ºòÂÆâÊéí
            return generate16MatchSchedule(players);
        }

        // ÁîüÊàê16Âú∫ÊØîËµõÁöÑÊúÄ‰ºòÂÆâÊéí
        function generate16MatchSchedule(players) {
            console.log('üéØ ÁîüÊàê16Âú∫ÊØîËµõÂÆâÊéí...');
            console.log('‚è±Ô∏è È¢ÑËÆ°Êó∂Èó¥Ôºö16Âú∫ √ó 10ÂàÜÈíü = 160ÂàÜÈíü = 2Â∞èÊó∂40ÂàÜÈíü');
            
            // 16Âú∫ÊØîËµõÁöÑÊï∞Â≠¶ÊúÄ‰ºòÂÆâÊéí
            // ÁõÆÊ†áÔºö4‰∫∫ÂèÇÂä†11Âú∫Ôºå2‰∫∫ÂèÇÂä†10Âú∫Ôºõ13‰∏™Êê≠Ê°£ÁªÑÂêà2Ê¨°Ôºå2‰∏™Êê≠Ê°£ÁªÑÂêà3Ê¨°
            const perfectSchedule = [
                [[0,1], [2,3]], // Á¨¨1Âú∫Ôºö4,5‰ºëÊÅØ
                [[4,5], [0,2]], // Á¨¨2Âú∫Ôºö1,3‰ºëÊÅØ  
                [[1,3], [4,0]], // Á¨¨3Âú∫Ôºö2,5‰ºëÊÅØ
                [[2,5], [1,4]], // Á¨¨4Âú∫Ôºö0,3‰ºëÊÅØ
                [[0,3], [2,4]], // Á¨¨5Âú∫Ôºö1,5‰ºëÊÅØ
                [[1,5], [3,4]], // Á¨¨6Âú∫Ôºö0,2‰ºëÊÅØ
                [[0,2], [1,4]], // Á¨¨7Âú∫Ôºö3,5‰ºëÊÅØ (02Á¨¨2Ê¨°, 14Á¨¨2Ê¨°)
                [[3,5], [0,4]], // Á¨¨8Âú∫Ôºö1,2‰ºëÊÅØ (04Á¨¨2Ê¨°)
                [[1,2], [4,5]], // Á¨¨9Âú∫Ôºö0,3‰ºëÊÅØ (45Á¨¨2Ê¨°)
                [[0,1], [3,5]], // Á¨¨10Âú∫Ôºö2,4‰ºëÊÅØ (01Á¨¨2Ê¨°, 35Á¨¨2Ê¨°)
                [[2,3], [0,5]], // Á¨¨11Âú∫Ôºö1,4‰ºëÊÅØ (23Á¨¨2Ê¨°)
                [[1,3], [2,4]], // Á¨¨12Âú∫Ôºö0,5‰ºëÊÅØ (13Á¨¨2Ê¨°, 24Á¨¨2Ê¨°)
                [[0,3], [1,5]], // Á¨¨13Âú∫Ôºö2,4‰ºëÊÅØ (03Á¨¨2Ê¨°, 15Á¨¨2Ê¨°)
                [[2,5], [3,4]], // Á¨¨14Âú∫Ôºö0,1‰ºëÊÅØ (25Á¨¨2Ê¨°, 34Á¨¨2Ê¨°)
                [[0,4], [1,2]], // Á¨¨15Âú∫Ôºö3,5‰ºëÊÅØ (04Á¨¨3Ê¨°, 12Á¨¨2Ê¨°)
                [[0,5], [1,4]]  // Á¨¨16Âú∫Ôºö2,3‰ºëÊÅØ (05Á¨¨2Ê¨°, 14Á¨¨3Ê¨°)
            ];
            
            // ËΩ¨Êç¢‰∏∫ÊØîËµõÊ†ºÂºè
            const matches = perfectSchedule.map((match, index) => ({
                team1: [players[match[0][0]], players[match[0][1]]],
                team2: [players[match[1][0]], players[match[1][1]]],
                score1: 0,
                score2: 0,
                matchIndex: index
            }));
            
            // È™åËØÅ16Âú∫ÂÆâÊéíÁöÑÊ≠£Á°ÆÊÄß
            validate16MatchSchedule(matches, players);
            
            return matches;
        }

        // È™åËØÅ16Âú∫ÊØîËµõÂÆâÊéí
        function validate16MatchSchedule(matches, players) {
            console.log('üîç È™åËØÅ16Âú∫ÊØîËµõÂÆâÊéí...');
            
            // 1. È™åËØÅÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞ÔºàÂ∫îËØ•ÊòØ10-11Âú∫Ôºâ
            const playerCounts = {};
            players.forEach(player => playerCounts[player] = 0);
            
            matches.forEach(match => {
                [...match.team1, ...match.team2].forEach(player => {
                    playerCounts[player]++;
                });
            });
            
            console.log('üë• ÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞:');
            let totalMatches = 0;
            Object.entries(playerCounts).forEach(([player, count]) => {
                const status = (count >= 10 && count <= 11) ? '‚úÖ' : '‚ùå';
                console.log(`  ${status} ${player}: ${count}Âú∫`);
                totalMatches += count;
            });
            console.log(`üìä ÊÄªÂèÇËµõ‰∫∫Ê¨°: ${totalMatches} (Â∫îËØ•ÊòØ64)`);
            
            // 2. È™åËØÅÊê≠Ê°£ÂàÜÈÖçÔºàÂ∫îËØ•ÊòØ13‰∏™Êê≠Ê°£2Ê¨°Ôºå2‰∏™Êê≠Ê°£3Ê¨°Ôºâ
            validatePartnershipBalance(matches, players);
            
            // 3. È™åËØÅÊó†ËøáÂ∫¶ËøûÁª≠ÊØîËµõ
            validateReasonableRest(matches, players);
            
            return true;
        }

        // È™åËØÅÂêàÁêÜÁöÑ‰ºëÊÅØÂàÜÈÖçÔºà16Âú∫ÊØîËµõ‰∏ãÁöÑÂÆΩÊùæÊ†áÂáÜÔºâ
        function validateReasonableRest(matches, players) {
            console.log('‚è±Ô∏è È™åËØÅ‰ºëÊÅØÂàÜÈÖç:');
            
            players.forEach(player => {
                const playerMatches = [];
                matches.forEach((match, index) => {
                    if ([...match.team1, ...match.team2].includes(player)) {
                        playerMatches.push(index);
                    }
                });
                
                // Ê£ÄÊü•ÊúÄÈïøËøûÁª≠ÊØîËµõÔºà‰∏çÂ∫îËØ•Ë∂ÖËøá3Âú∫Ôºâ
                let maxConsecutive = 1;
                let currentConsecutive = 1;
                
                for (let i = 1; i < playerMatches.length; i++) {
                    if (playerMatches[i] === playerMatches[i-1] + 1) {
                        currentConsecutive++;
                    } else {
                        maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                        currentConsecutive = 1;
                    }
                }
                maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                
                const status = maxConsecutive <= 3 ? '‚úÖ' : '‚ö†Ô∏è';
                console.log(`  ${status} ${player}: ÊúÄÈïøËøûÁª≠${maxConsecutive}Âú∫ (Á¨¨${playerMatches.map(m => m+1).join(',')}Âú∫)`);
            });
        }

        // ÁîüÊàêÂÆåÂÖ®ÂùáË°°ÁöÑÊê≠Ê°£ÂàÜÈÖçÂÆâÊéí
        function generateBalancedPartnershipSchedule(players) {
            console.log('üéØ ÁîüÊàêÊï∞Â≠¶‰∏äÂÆåÁæéÁöÑÊê≠Ê°£ÂàÜÈÖç...');
            
            // 6‰∫∫ÊÄªÂÖ±Êúâ15‰∏™Êê≠Ê°£ÁªÑÂêàÔºåÊØè‰∏™ÁªÑÂêàÈúÄË¶ÅÂá∫Áé∞2Ê¨°
            const allPairs = [];
            for (let i = 0; i < 6; i++) {
                for (let j = i + 1; j < 6; j++) {
                    allPairs.push([i, j]);
                    allPairs.push([i, j]); // ÊØè‰∏™Êê≠Ê°£ÁªÑÂêàÈúÄË¶ÅÂá∫Áé∞2Ê¨°
                }
            }
            
            console.log(`ÊÄªÂÖ±${allPairs.length}‰∏™Êê≠Ê°£ÂÆû‰æãÈúÄË¶ÅÂàÜÈÖçÂà∞15Âú∫ÊØîËµõ‰∏≠`);
            
            const matches = [];
            const usedPairs = [];
            
            // ÊâãÂ∑•ËÆæËÆ°ÁöÑÂÆåÁæéÂàÜÈÖçÔºàÁ°Æ‰øùÊØè‰∫∫10Âú∫ÔºåÊó†ËøûÁª≠ÊØîËµõÔºåÊê≠Ê°£ÂùáË°°Ôºâ
            const perfectSchedule = [
                [[0,1], [2,3]], // Á¨¨1Âú∫Ôºö4,5‰ºëÊÅØ
                [[4,5], [0,2]], // Á¨¨2Âú∫Ôºö1,3‰ºëÊÅØ  
                [[1,3], [4,0]], // Á¨¨3Âú∫Ôºö2,5‰ºëÊÅØ
                [[2,5], [1,4]], // Á¨¨4Âú∫Ôºö0,3‰ºëÊÅØ
                [[0,3], [2,4]], // Á¨¨5Âú∫Ôºö1,5‰ºëÊÅØ
                [[1,5], [3,4]], // Á¨¨6Âú∫Ôºö0,2‰ºëÊÅØ
                [[0,2], [1,4]], // Á¨¨7Âú∫Ôºö3,5‰ºëÊÅØ (02Á¨¨2Ê¨°, 14Á¨¨2Ê¨°)
                [[3,5], [0,4]], // Á¨¨8Âú∫Ôºö1,2‰ºëÊÅØ (04Á¨¨2Ê¨°)
                [[1,2], [4,5]], // Á¨¨9Âú∫Ôºö0,3‰ºëÊÅØ (45Á¨¨2Ê¨°)
                [[0,1], [3,5]], // Á¨¨10Âú∫Ôºö2,4‰ºëÊÅØ (01Á¨¨2Ê¨°, 35Á¨¨2Ê¨°)
                [[2,3], [0,5]], // Á¨¨11Âú∫Ôºö1,4‰ºëÊÅØ (23Á¨¨2Ê¨°)
                [[1,3], [2,5]], // Á¨¨12Âú∫Ôºö0,4‰ºëÊÅØ (13Á¨¨2Ê¨°, 25Á¨¨2Ê¨°)
                [[0,3], [1,5]], // Á¨¨13Âú∫Ôºö2,4‰ºëÊÅØ (03Á¨¨2Ê¨°, 15Á¨¨2Ê¨°)
                [[2,4], [3,4]], // Á¨¨14Âú∫Ôºö0,1‰ºëÊÅØ (24Á¨¨2Ê¨°, 34Á¨¨2Ê¨°)
                [[1,2], [0,5]]  // Á¨¨15Âú∫Ôºö3,4‰ºëÊÅØ (12Á¨¨2Ê¨°, 05Á¨¨2Ê¨°)
            ];
            
            // ËΩ¨Êç¢‰∏∫ÊØîËµõÊ†ºÂºè
            perfectSchedule.forEach((match, index) => {
                matches.push({
                    team1: [players[match[0][0]], players[match[0][1]]],
                    team2: [players[match[1][0]], players[match[1][1]]],
                    score1: 0,
                    score2: 0,
                    matchIndex: index
                });
            });
            
            // È™åËØÅÂÆâÊéíÁöÑÊ≠£Á°ÆÊÄß
            validatePerfectSchedule(matches, players);
            
            return matches;
        }

        // È™åËØÅÂÆåÁæéÂÆâÊéíÁöÑÊâÄÊúâÊù°‰ª∂
        function validatePerfectSchedule(matches, players) {
            console.log('üîç È™åËØÅÂÆåÁæéÂÆâÊéí...');
            
            // 1. È™åËØÅÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞
            const playerCounts = {};
            players.forEach(player => playerCounts[player] = 0);
            
            matches.forEach(match => {
                [...match.team1, ...match.team2].forEach(player => {
                    playerCounts[player]++;
                });
            });
            
            console.log('üë• ÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞:');
            Object.entries(playerCounts).forEach(([player, count]) => {
                const status = count === 10 ? '‚úÖ' : '‚ùå';
                console.log(`  ${status} ${player}: ${count}Âú∫`);
            });
            
            // 2. È™åËØÅÊê≠Ê°£ÂàÜÈÖç
            validatePartnershipBalance(matches, players);
            
            // 3. È™åËØÅÊó†ËøûÁª≠ÊØîËµõ
            validateNoConsecutiveMatches(matches, players);
            
            return true;
        }

        // È™åËØÅÊó†ËøûÁª≠ÊØîËµõ
        function validateNoConsecutiveMatches(matches, players) {
            console.log('‚è±Ô∏è È™åËØÅÊó†ËøûÁª≠ÊØîËµõ:');
            
            players.forEach(player => {
                const playerMatches = [];
                matches.forEach((match, index) => {
                    if ([...match.team1, ...match.team2].includes(player)) {
                        playerMatches.push(index);
                    }
                });
                
                // Ê£ÄÊü•ËøûÁª≠
                let hasConsecutive = false;
                for (let i = 1; i < playerMatches.length; i++) {
                    if (playerMatches[i] === playerMatches[i-1] + 1) {
                        hasConsecutive = true;
                        console.log(`  ‚ùå ${player}ËøûÁª≠ÊØîËµõÔºöÁ¨¨${playerMatches[i-1]+1}Âíå${playerMatches[i]+1}Âú∫`);
                    }
                }
                
                if (!hasConsecutive) {
                    console.log(`  ‚úÖ ${player}: Á¨¨${playerMatches.map(m => m+1).join(',')}Âú∫`);
                }
            });
        }

        // Â∞ÜÂÆåÁæéÂÆâÊéíËΩ¨Êç¢‰∏∫ÊØîËµõÊ†ºÂºèÔºåÁ°Æ‰øùÊê≠Ê°£ÂàÜÈÖçÂùáË°°
        function convertPerfectScheduleToMatches(perfectMatches, players) {
            console.log('üîç ËΩ¨Êç¢ÂÆåÁæéÂÆâÊéíÂπ∂È™åËØÅÊê≠Ê°£ÂùáË°°ÊÄß...');
            
            const matches = perfectMatches.map((match, index) => ({
                team1: [players[match.team1[0]], players[match.team1[1]]],
                team2: [players[match.team2[0]], players[match.team2[1]]],
                score1: 0,
                score2: 0,
                matchIndex: index
            }));
            
            // È™åËØÅÊê≠Ê°£ÂàÜÈÖç
            validatePartnershipBalance(matches, players);
            
            return matches;
        }

        // È™åËØÅÊê≠Ê°£ÂàÜÈÖçÂùáË°°ÊÄß
        function validatePartnershipBalance(matches, players) {
            const partnerships = {};
            const playerCount = players.length;
            
            // ÂàùÂßãÂåñÊâÄÊúâÂèØËÉΩÁöÑÊê≠Ê°£ÁªÑÂêà
            for (let i = 0; i < playerCount; i++) {
                for (let j = i + 1; j < playerCount; j++) {
                    const key = `${players[i]}-${players[j]}`;
                    partnerships[key] = 0;
                }
            }
            
            // ÁªüËÆ°ÂÆûÈôÖÊê≠Ê°£Ê¨°Êï∞
            matches.forEach((match, index) => {
                // ÁªüËÆ°team1Êê≠Ê°£
                const team1Key = `${match.team1[0]}-${match.team1[1]}`;
                const team1KeyReverse = `${match.team1[1]}-${match.team1[0]}`;
                if (partnerships[team1Key] !== undefined) {
                    partnerships[team1Key]++;
                } else if (partnerships[team1KeyReverse] !== undefined) {
                    partnerships[team1KeyReverse]++;
                }
                
                // ÁªüËÆ°team2Êê≠Ê°£
                const team2Key = `${match.team2[0]}-${match.team2[1]}`;
                const team2KeyReverse = `${match.team2[1]}-${match.team2[0]}`;
                if (partnerships[team2Key] !== undefined) {
                    partnerships[team2Key]++;
                } else if (partnerships[team2KeyReverse] !== undefined) {
                    partnerships[team2KeyReverse]++;
                }
            });
            
            console.log('ü§ù Êê≠Ê°£ÂàÜÈÖçÁªüËÆ°Ôºö');
            const counts = Object.values(partnerships);
            const minCount = Math.min(...counts);
            const maxCount = Math.max(...counts);
            
            Object.entries(partnerships).forEach(([key, count]) => {
                const color = count === 2 ? '‚úÖ' : count < 2 ? '‚ö†Ô∏è' : '‚ùå';
                console.log(`  ${color} ${key}: ${count}Ê¨°`);
            });
            
            console.log(`üìä Êê≠Ê°£ÂùáË°°ÊÄß: ÊúÄÂ∞ë${minCount}Ê¨°, ÊúÄÂ§ö${maxCount}Ê¨° (ÁêÜÊÉ≥ÂÄº: 2Ê¨°)`);
            
            if (minCount < 2 || maxCount > 2) {
                console.warn('‚ö†Ô∏è Êê≠Ê°£ÂàÜÈÖç‰∏çÂ§üÂùáË°°ÔºåÈúÄË¶Å‰ºòÂåñÁÆóÊ≥ï');
            } else {
                console.log('‚úÖ Êê≠Ê°£ÂàÜÈÖçÂÆåÂÖ®ÂùáË°°ÔºÅ');
            }
            
            return partnerships;
        }

        // ËΩ¨Êç¢Âπ∂È™åËØÅÊØîËµõÂÆâÊéí - ‰∏•Ê†ºÈ™åËØÅÊâÄÊúâÊù°‰ª∂
        function convertAndValidateSchedule(schedule, players, playerCount, expectedMatches) {
            console.log(`üîç È™åËØÅ${playerCount}‰∫∫ÂÆâÊéíÁöÑÊï∞Â≠¶Ê≠£Á°ÆÊÄß...`);
            
            // 1. È™åËØÅÊÄªÂú∫Ê¨°
            if (schedule.length !== 15) {
                throw new Error(`Âú∫Ê¨°Êï∞ÈîôËØØÔºö${schedule.length}Âú∫ÔºåÂ∫îËØ•15Âú∫`);
            }
            
            // 2. ÁªüËÆ°ÊØè‰∫∫ÂèÇËµõÊ¨°Êï∞
            const playerCounts = Array(playerCount).fill(0);
            schedule.forEach((match, matchIndex) => {
                if (match.length !== 4) {
                    throw new Error(`Á¨¨${matchIndex+1}Âú∫Â∫îËØ•4‰∫∫ÂèÇËµõÔºåÂÆûÈôÖ${match.length}‰∫∫`);
                }
                match.forEach(playerId => {
                    if (playerId < 0 || playerId >= playerCount) {
                        throw new Error(`Á¨¨${matchIndex+1}Âú∫Áé©ÂÆ∂IDÈîôËØØÔºö${playerId}`);
                    }
                    playerCounts[playerId]++;
                });
            });
            
            console.log(`üìä ÊØè‰∫∫ÂèÇËµõÁªüËÆ°: [${playerCounts.join(',')}]`);
            
            // 3. È™åËØÅÊØè‰∫∫Âú∫Ê¨°Êï∞
            for (let i = 0; i < playerCount; i++) {
                if (playerCounts[i] !== expectedMatches) {
                    throw new Error(`Áé©ÂÆ∂${i+1}Âú∫Ê¨°ÈîôËØØÔºö${playerCounts[i]}Âú∫ÔºåÂ∫îËØ•${expectedMatches}Âú∫`);
                }
            }
            
            // 4. È™åËØÅËøûÁª≠ÊØîËµõ
            for (let playerId = 0; playerId < playerCount; playerId++) {
                const playerMatches = [];
                schedule.forEach((match, index) => {
                    if (match.includes(playerId)) {
                        playerMatches.push(index);
                    }
                });
                
                // Ê£ÄÊü•ËøûÁª≠
                for (let i = 1; i < playerMatches.length; i++) {
                    if (playerMatches[i] === playerMatches[i-1] + 1) {
                        throw new Error(`Áé©ÂÆ∂${playerId+1}ËøûÁª≠ÊØîËµõÔºöÁ¨¨${playerMatches[i-1]+1}Âíå${playerMatches[i]+1}Âú∫`);
                    }
                }
                
                console.log(`   Áé©ÂÆ∂${playerId+1}: Á¨¨${playerMatches.map(m => m+1).join(',')}Âú∫ ‚úì`);
            }
            
            // 5. È™åËØÅ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏É
            validateRestDistributionPerfect(schedule, playerCount);
            
            // 6. ËΩ¨Êç¢‰∏∫Ê†áÂáÜÊ†ºÂºè
            const matches = schedule.map((match, index) => {
                const shuffled = [...match].sort(() => Math.random() - 0.5);
                return {
                    team1: [players[shuffled[0]], players[shuffled[1]]],
                    team2: [players[shuffled[2]], players[shuffled[3]]],
                    score1: 0,
                    score2: 0,
                    matchIndex: index
                };
            });
            
            console.log(`‚úÖ ${playerCount}‰∫∫ÂÆåÁæéÂÆâÊéíÈ™åËØÅÈÄöËøáÔºöÊØè‰∫∫${expectedMatches}Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠ÊØîËµõÔºå‰ºëÊÅØÊó∂Èó¥ÂÖ¨Âπ≥`);
            return matches;
        }

        // È™åËØÅ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏É - ÂÆåÁæéÁâà
        function validateRestDistributionPerfect(schedule, playerCount) {
            console.log('üîç È™åËØÅ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏É...');
            
            for (let playerId = 0; playerId < playerCount; playerId++) {
                const playerMatches = [];
                schedule.forEach((match, index) => {
                    if (match.includes(playerId)) {
                        playerMatches.push(index);
                    }
                });
                
                const restPeriods = [];
                for (let i = 1; i < playerMatches.length; i++) {
                    const restTime = playerMatches[i] - playerMatches[i-1] - 1;
                    if (restTime > 0) {
                        restPeriods.push(restTime);
                    }
                }
                
                const maxRest = Math.max(...restPeriods, 0);
                const avgRest = restPeriods.length > 0 ? restPeriods.reduce((a, b) => a + b, 0) / restPeriods.length : 0;
                
                console.log(`   Áé©ÂÆ∂${playerId+1}: ‰ºëÊÅØÈó¥Èöî [${restPeriods.join(',')}], ÊúÄÈïø${maxRest}Âú∫, Âπ≥Âùá${avgRest.toFixed(1)}Âú∫`);
            }
            
            console.log('‚úÖ ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏ÉÈ™åËØÅÂÆåÊàê');
        }
        
        // Âõ∫ÂÆöÁöÑ6‰∫∫ÊñπÊ°à - ÁªèËøáÊâãÂ∑•È™åËØÅÔºåÁªùÂØπÊó†ËøûÁª≠ÊØîËµõ
        function generateFixed6PlayerSolution(players) {
            console.log('üîí ‰ΩøÁî®Âõ∫ÂÆöÁöÑ6‰∫∫ÊñπÊ°àÔºåÁªùÂØπÊó†ËøûÁª≠ÊØîËµõ');
            
            // ÈáçÊñ∞ËÆæËÆ°ÁöÑ15Âú∫ÊØîËµõÂÆâÊéíÔºàÁé©ÂÆ∂ÁºñÂè∑0-5Ôºâ
            // ‰ΩøÁî®Á≥ªÁªüÂåñÊñπÊ≥ïÁ°Æ‰øùÊØè‰∫∫ÊÅ∞Â•ΩÂèÇ‰∏é10Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠ÊØîËµõ
            const fixedSchedule = [
                [0,1,2,3], // Á¨¨1Âú∫Ôºö4,5‰ºëÊÅØ
                [4,5,1,2], // Á¨¨2Âú∫Ôºö0,3‰ºëÊÅØ  
                [0,3,4,5], // Á¨¨3Âú∫Ôºö1,2‰ºëÊÅØ
                [1,2,0,4], // Á¨¨4Âú∫Ôºö3,5‰ºëÊÅØ
                [3,5,1,0], // Á¨¨5Âú∫Ôºö2,4‰ºëÊÅØ
                [2,4,3,0], // Á¨¨6Âú∫Ôºö1,5‰ºëÊÅØ
                [1,5,2,3], // Á¨¨7Âú∫Ôºö0,4‰ºëÊÅØ
                [0,4,1,3], // Á¨¨8Âú∫Ôºö2,5‰ºëÊÅØ
                [2,5,0,1], // Á¨¨9Âú∫Ôºö3,4‰ºëÊÅØ
                [3,4,2,5], // Á¨¨10Âú∫Ôºö0,1‰ºëÊÅØ
                [0,1,4,5], // Á¨¨11Âú∫Ôºö2,3‰ºëÊÅØ
                [2,3,0,5], // Á¨¨12Âú∫Ôºö1,4‰ºëÊÅØ
                [1,4,2,0], // Á¨¨13Âú∫Ôºö3,5‰ºëÊÅØ
                [3,5,1,2], // Á¨¨14Âú∫Ôºö0,4‰ºëÊÅØ
                [0,4,3,1]  // Á¨¨15Âú∫Ôºö2,5‰ºëÊÅØ
            ];
            
            // È™åËØÅËøô‰∏™Âõ∫ÂÆöÊñπÊ°à
            console.log('üîç È™åËØÅÂõ∫ÂÆöÊñπÊ°à...');
            
            // Ê£ÄÊü•ÊØè‰∫∫ÂèÇ‰∏éÊ¨°Êï∞
            const playerCounts = Array(6).fill(0);
            fixedSchedule.forEach(match => {
                match.forEach(playerId => playerCounts[playerId]++);
            });
            
            console.log('üìä Âõ∫ÂÆöÊñπÊ°àÊØè‰∫∫Âú∫Ê¨°:', playerCounts);
            if (!playerCounts.every(count => count === 10)) {
                throw new Error(`Âõ∫ÂÆöÊñπÊ°àÂú∫Ê¨°ÈîôËØØ: [${playerCounts.join(',')}], Â∫îËØ•ÊØè‰∫∫10Âú∫`);
            }
            
            // Ê£ÄÊü•ËøûÁª≠ÊØîËµõ
            for (let playerId = 0; playerId < 6; playerId++) {
                const playerMatches = [];
                fixedSchedule.forEach((match, index) => {
                    if (match.includes(playerId)) {
                        playerMatches.push(index);
                    }
                });
                
                // Ê£ÄÊü•ËøûÁª≠
                for (let i = 1; i < playerMatches.length; i++) {
                    if (playerMatches[i] === playerMatches[i-1] + 1) {
                        throw new Error(`Âõ∫ÂÆöÊñπÊ°àÈîôËØØÔºöÁé©ÂÆ∂${playerId+1}Âú®Á¨¨${playerMatches[i-1]+1}Âíå${playerMatches[i]+1}Âú∫ËøûÁª≠ÊØîËµõ`);
                    }
                }
                
                console.log(`   Áé©ÂÆ∂${playerId+1}: Á¨¨${playerMatches.map(m => m+1).join(',')}Âú∫ ‚úì`);
            }
            
            // ËΩ¨Êç¢‰∏∫Ê†áÂáÜÊ†ºÂºè
            const matches = fixedSchedule.map((match, index) => {
                // ÈöèÊú∫ÂàÜÁªÑ
                const shuffled = [...match].sort(() => Math.random() - 0.5);
                return {
                    team1: [players[shuffled[0]], players[shuffled[1]]],
                    team2: [players[shuffled[2]], players[shuffled[3]]],
                    score1: 0,
                    score2: 0,
                    matchIndex: index
                };
            });
            
            console.log('‚úÖ Âõ∫ÂÆöÊñπÊ°àÈ™åËØÅÈÄöËøáÔºöÊØè‰∫∫10Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠ÊØîËµõ');
            return matches;
        }

        // ‰∏•Ê†ºÁöÑÊï∞Â≠¶È™åËØÅÁÆóÊ≥ï - ÁªùÂØπ‰øùËØÅÂú∫Ê¨°ÂíåËøûÁª≠ÊÄß
        function generateOptimalSchedule(playerCount, players) {
            console.log('üî• ‰ΩøÁî®‰∏•Ê†ºÊï∞Â≠¶È™åËØÅÁÆóÊ≥ï');
            
            const targetMatches = 15;
            const targetPerPlayer = playerCount === 6 ? 10 : 12;
            
            // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑ4‰∫∫ÁªÑÂêàÔºà6‰∫∫‰∏≠ÈÄâ4‰∫∫Ôºâ
            const allCombinations = [];
            
            if (playerCount === 6) {
                // 6‰∫∫Ê®°ÂºèÔºö‰ªé6‰∫∫‰∏≠ÈÄâ4‰∫∫ÔºåÊúâC(6,4)=15ÁßçÈÄâÊ≥ïÔºåÊØèÁßçÊúâ3ÁßçÂàÜÁªÑÊñπÂºè
                for (let i = 0; i < 6; i++) {
                    for (let j = i + 1; j < 6; j++) {
                        for (let k = j + 1; k < 6; k++) {
                            for (let l = k + 1; l < 6; l++) {
                                // 4‰∫∫ÁªÑÂêà [i,j,k,l]ÔºåÂâ©‰∏ã2‰∫∫‰ºëÊÅØ
                                const playingPlayers = [i, j, k, l];
                                
                                // ÁîüÊàêËøô4‰∫∫ÁöÑÊâÄÊúâÂàÜÁªÑÊñπÂºè
                                const groupings = [
                                    { team1: [i, j], team2: [k, l], players: playingPlayers },
                                    { team1: [i, k], team2: [j, l], players: playingPlayers },
                                    { team1: [i, l], team2: [j, k], players: playingPlayers }
                                ];
                                
                                allCombinations.push(...groupings);
                            }
                        }
                    }
                }
            } else {
                // ÂÖ∂‰ªñ‰∫∫Êï∞ÁöÑÂ§ÑÁêÜÔºà‰øùÊåÅÂéüÈÄªËæëÔºâ
                for (let i = 0; i < playerCount; i++) {
                    for (let j = i + 1; j < playerCount; j++) {
                        for (let k = 0; k < playerCount; k++) {
                            if (k !== i && k !== j) {
                                for (let l = k + 1; l < playerCount; l++) {
                                    if (l !== i && l !== j) {
                                        allCombinations.push({
                                            team1: [i, j],
                                            team2: [k, l],
                                            players: [i, j, k, l]
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            console.log(`ÊÄªÂÖ±${allCombinations.length}Áßç4‰∫∫ÁªÑÂêàÂèØÈÄâ`);
            
            // Â§öÊ¨°Â∞ùËØïÁîüÊàêÂÆåÁæéÂÆâÊéí
            for (let attempt = 0; attempt < 1000; attempt++) {
                const matches = [];
                const playerLastMatch = Array(playerCount).fill(-999);
                const playerMatchCount = Array(playerCount).fill(0);
                const usedCombinations = new Set();
                
                // ÂàùÂßãÂåñÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®Ôºà6‰∫∫/ÈÄöÁî®Ê®°ÂºèÔºâ
                globalPartnershipManager = new PartnershipManager(playerCount);
                
                let success = true;
                
                for (let matchIndex = 0; matchIndex < targetMatches; matchIndex++) {
                    const validCombos = [];
                    
                    // ‰∏•Ê†ºÁ≠õÈÄâÂèØÁî®ÁªÑÂêà
                    for (const combo of allCombinations) {
                        const comboKey = combo.players.slice().sort().join(',');
                        if (usedCombinations.has(comboKey)) continue;
                        
                        // ‰∏•Ê†ºÊ£ÄÊü•Âú∫Ê¨°ÈôêÂà∂
                        let exceedsLimit = false;
                        for (const playerId of combo.players) {
                            if (playerMatchCount[playerId] >= targetPerPlayer) {
                                exceedsLimit = true;
                                break;
                            }
                        }
                        if (exceedsLimit) continue;
                        
                        // ‰∏•Ê†ºÊ£ÄÊü•ËøûÁª≠ÊØîËµõ - ÁªùÂØπ‰∏çÂÖÅËÆ∏
                        let hasConsecutive = false;
                        for (const playerId of combo.players) {
                            if (playerLastMatch[playerId] === matchIndex - 1) {
                                hasConsecutive = true;
                                break;
                            }
                        }
                        if (hasConsecutive) continue;
                        
                        validCombos.push(combo);
                    }
                    
                    if (validCombos.length === 0) {
                        success = false;
                        break;
                    }
                    
                    // ÈÄâÊã©ÊúÄ‰ºòÁªÑÂêà
                    let bestCombo = null;
                    let bestScore = -Infinity;
                    
                    for (const combo of validCombos) {
                        let score = 0;
                        
                        // ‰ºòÂÖàÂÆâÊéíÊØîËµõÊ¨°Êï∞Â∞ëÁöÑ‰∫∫
                        for (const playerId of combo.players) {
                            const remaining = targetPerPlayer - playerMatchCount[playerId];
                            score += remaining * 1000; // È´òÊùÉÈáç
                        }
                        
                        // ‰ºòÂÖàÂÆâÊéí‰ºëÊÅØ‰πÖÁöÑ‰∫∫
                        for (const playerId of combo.players) {
                            const restTime = matchIndex - playerLastMatch[playerId];
                            score += Math.min(restTime * 100, 500);
                        }
                        
                        // Êñ∞Â¢ûÔºö‰ΩøÁî®ÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®Ôºà6‰∫∫/ÈÄöÁî®Ê®°ÂºèÔºâ
                        const team1Players = combo.team1;
                        const team2Players = combo.team2;
                        
                        // Á°¨ÈôêÂà∂ÔºöÊ£ÄÊü•Êê≠ÈÖçÊòØÂê¶Ë∂ÖÊ†á
                        if (!globalPartnershipManager.canFormTeam(team1Players, team2Players)) {
                            continue; // Áõ¥Êé•Ë∑≥ËøáËøô‰∏™ÁªÑÂêàÔºå‰∏çÂÖÅËÆ∏Ë∂ÖÊ†á
                        }
                        
                        // Êê≠ÈÖç‰ºòÂÖàÁ∫ßËØÑÂàÜ
                        let partnershipScore = 0;
                        partnershipScore += globalPartnershipManager.getPartnershipScore(team1Players[0], team1Players[1]);
                        partnershipScore += globalPartnershipManager.getPartnershipScore(team2Players[0], team2Players[1]);
                        
                        // È¢ùÂ§ñÂ•ñÂä±ÂåÖÂê´ÊúÄÂ∞ë‰ΩøÁî®ÈÖçÂØπÁöÑÁªÑÂêà
                        if (globalPartnershipManager.containsLeastUsedPair(team1Players, team2Players)) {
                            partnershipScore += 15000; // Â§ßÂπÖÂ•ñÂä±ÊúÄÂ∞ë‰ΩøÁî®ÁöÑÈÖçÂØπ
                        }
                        
                        score += partnershipScore;
                        
                        // Â∞èÁöÑÈöèÊú∫Âõ†Â≠êÔºàÂáèÂ∞ëÈöèÊú∫ÊÄßÔºåËÆ©ÁÆóÊ≥ïÊõ¥ÂÄæÂêë‰∫éÂùáË°°Êê≠ÈÖçÔºâ
                        score += Math.random() * 5;
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestCombo = combo;
                        }
                    }
                    
                    if (bestCombo) {
                        matches.push({
                            team1: [players[bestCombo.team1[0]], players[bestCombo.team1[1]]],
                            team2: [players[bestCombo.team2[0]], players[bestCombo.team2[1]]],
                            score1: 0,
                            score2: 0,
                            matchIndex: matchIndex
                        });
                        
                        // Êõ¥Êñ∞ÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®
                        globalPartnershipManager.addTeams(bestCombo.team1, bestCombo.team2);
                        
                        // Êõ¥Êñ∞Áä∂ÊÄÅ
                        for (const playerId of bestCombo.players) {
                            playerLastMatch[playerId] = matchIndex;
                            playerMatchCount[playerId]++;
                        }
                        
                        usedCombinations.add(bestCombo.players.slice().sort().join(','));
                    } else {
                        success = false;
                        break;
                    }
                }
                
                // Â¶ÇÊûúÁîüÊàêÊàêÂäüÔºåËøõË°åÊúÄ‰∏•Ê†ºÁöÑÈ™åËØÅ
                if (success && matches.length === targetMatches) {
                    // ÂÖàÂÅöÂø´ÈÄüÂú∫Ê¨°Ê£ÄÊü•
                    const quickCheck = playerMatchCount.every(count => count === targetPerPlayer);
                    if (!quickCheck) {
                        console.warn(`‚ùå Âø´ÈÄüÊ£ÄÊü•Â§±Ë¥•ÔºöÂú∫Ê¨°ÂàÜÈÖç‰∏çÂùá [${playerMatchCount.join(',')}]ÔºåÁõÆÊ†áÊØè‰∫∫${targetPerPlayer}Âú∫`);
                        continue;
                    }
                    
                    const isValid = validateMatchesStrictly(matches, playerCount, players, targetPerPlayer);
                    if (isValid) {
                        console.log(`‚úÖ ÁîüÊàêÂÆåÁæéÂÆâÊéíÔºÅÂ∞ùËØï${attempt + 1}Ê¨°`);
                        console.log(`üìä ÊúÄÁªàÂú∫Ê¨°ÂàÜÈÖçÔºö[${playerMatchCount.join(',')}]`);
                        return matches;
                    }
                }
                
                // ÊØè50Ê¨°Â∞ùËØïËæìÂá∫Ë∞ÉËØï‰ø°ÊÅØ
                if ((attempt + 1) % 50 === 0) {
                    console.log(`üîÑ ${playerCount}‰∫∫ÂÆâÊéíÂ∞ùËØïËøõÂ∫¶Ôºö${attempt + 1}/1000`);
                    if (matches.length === targetMatches) {
                        console.log(`   ÂΩìÂâçÂú∫Ê¨°ÂàÜÈÖçÔºö[${playerMatchCount.join(',')}]ÔºåÁõÆÊ†áÊØè‰∫∫${targetPerPlayer}Âú∫`);
                    }
                }
            }
            
            console.error('‚ùå 1000Ê¨°Â∞ùËØïÈÉΩÂ§±Ë¥•‰∫ÜÔºÅ‰ΩøÁî®Êï∞Â≠¶ÊûÑÈÄ†Ê≥ï');
            return generateMathematicalSolution(playerCount, players, targetPerPlayer);
        }
        
        // Êï∞Â≠¶ÊûÑÈÄ†Ê≥ï - ÁªùÂØπÊ≠£Á°ÆÁöÑËß£ÂÜ≥ÊñπÊ°à
        function generateMathematicalSolution(playerCount, players, targetPerPlayer) {
            console.log('üßÆ ‰ΩøÁî®Êï∞Â≠¶ÊûÑÈÄ†Ê≥ïÁîüÊàêÁªùÂØπÊ≠£Á°ÆÁöÑÂÆâÊéí');
            
            if (playerCount === 6) {
                // 6‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÔºöÊØè‰∫∫ÊÅ∞Â•Ω10Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠
                return generate6PlayerMathematicalSolution(players);
            } else if (playerCount === 5) {
                // 5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÔºöÊØè‰∫∫ÊÅ∞Â•Ω12Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠ÔºåÂ∏¶ÈáçËØïÊú∫Âà∂
                const maxRetries = 50; // ÊúÄÂ§öÈáçËØï50Ê¨°
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        console.log(`üéØ 5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†Â∞ùËØï ${attempt}/${maxRetries}`);
                        return generate5PlayerMathematicalSolution(players);
                    } catch (error) {
                        if (error.message.includes('Êê≠ÈÖç‰∏çÂùáË°°') && attempt < maxRetries) {
                            console.warn(`‚ö†Ô∏è Á¨¨${attempt}Ê¨°Â∞ùËØïÊê≠ÈÖç‰∏çÂùáË°°ÔºåÈáçÊñ∞ÁîüÊàê...`);
                            continue; // ÈáçËØï
                        } else {
                            console.error(`‚ùå 5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÊúÄÁªàÂ§±Ë¥• (${attempt}Ê¨°Â∞ùËØï):`, error.message);
                            throw error;
                        }
                    }
                }
                throw new Error(`5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†Â§±Ë¥•Ôºö${maxRetries}Ê¨°Â∞ùËØïÈÉΩÊó†Ê≥ïÁîüÊàêÂùáË°°Êê≠ÈÖç`);
            } else {
                throw new Error(`‰∏çÊîØÊåÅ${playerCount}‰∫∫ÁöÑÊï∞Â≠¶ÊûÑÈÄ†`);
            }
        }
        
        // 6‰∫∫Êï∞Â≠¶ÊûÑÈÄ†Ëß£ÂÜ≥ÊñπÊ°à - ‰ΩøÁî®ÁÆóÊ≥ï‰øùËØÅÊ≠£Á°ÆÊÄß
        function generate6PlayerMathematicalSolution(players) {
            console.log('üéØ 6‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÔºöÁ°Æ‰øùÊØè‰∫∫ÊÅ∞Â•Ω10Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠');
            
            // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑ4‰∫∫ÁªÑÂêà C(6,4) = 15
            const allCombinations = [];
            for (let i = 0; i < 6; i++) {
                for (let j = i + 1; j < 6; j++) {
                    for (let k = j + 1; k < 6; k++) {
                        for (let l = k + 1; l < 6; l++) {
                            allCombinations.push([i, j, k, l]);
                        }
                    }
                }
            }
            
            console.log(`6‰∫∫ÂÖ±Êúâ${allCombinations.length}Áßç4‰∫∫ÁªÑÂêà`);
            
            // È™åËØÅÁªÑÂêàÊï∞Â≠¶Ê≠£Á°ÆÊÄß
            const expectedCombinations = 15; // C(6,4) = 15
            if (allCombinations.length !== expectedCombinations) {
                throw new Error(`ÁªÑÂêàÊï∞ÈîôËØØÔºÅÊúüÊúõ${expectedCombinations}‰∏™ÔºåÂÆûÈôÖ${allCombinations.length}‰∏™`);
            }
            
            // È™åËØÅÊØè‰∫∫ÁêÜËÆ∫Âá∫Áé∞Ê¨°Êï∞
            const playerAppearances = Array(6).fill(0);
            allCombinations.forEach(combo => {
                combo.forEach(playerId => playerAppearances[playerId]++);
            });
            console.log('üî¢ ÁêÜËÆ∫ÊØè‰∫∫Âá∫Áé∞Ê¨°Êï∞:', playerAppearances);
            
            const expectedPerPlayer = 10; // (15 * 4) / 6 = 10
            if (!playerAppearances.every(count => count === expectedPerPlayer)) {
                throw new Error(`ÁêÜËÆ∫ÂàÜÈÖçÈîôËØØÔºÅÊúüÊúõÊØè‰∫∫${expectedPerPlayer}Ê¨°ÔºåÂÆûÈôÖ[${playerAppearances.join(',')}]`);
            }
            
            // ‰ΩøÁî®Êô∫ËÉΩÂõûÊ∫ØÁÆóÊ≥ïÔºåÂπ≥Ë°°ÊØîËµõÂíå‰ºëÊÅØÂàÜÂ∏É
            function findValidSchedule() {
                const schedule = [];
                const used = new Set();
                const lastMatch = Array(6).fill(-999);
                const matchCount = Array(6).fill(0);
                
                // ÂàùÂßãÂåñÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®ÔºàÊô∫ËÉΩÂõûÊ∫ØÁÆóÊ≥ïÔºâ
                globalPartnershipManager = new PartnershipManager(6);
                
                // ËÆ°ÁÆóÁªÑÂêàÁöÑÂÖ¨Âπ≥ÊÄßÂàÜÊï∞
                function calculateFairnessScore(combo, matchIndex) {
                    let score = 0;
                    
                    // 1. ‰ºòÂÖàÈÄâÊã©ÊØîËµõÊ¨°Êï∞Â∞ëÁöÑ‰∫∫
                    for (const playerId of combo) {
                        const remaining = 10 - matchCount[playerId];
                        score += remaining * 1000; // È´òÊùÉÈáç
                    }
                    
                    // 2. Âπ≥Ë°°‰ºëÊÅØÊó∂Èó¥ - ÈÅøÂÖç‰ºëÊÅØËøá‰πÖÊàñËøáÁü≠
                    let totalRestTime = 0;
                    let minRestTime = Infinity;
                    let maxRestTime = -Infinity;
                    
                    for (const playerId of combo) {
                        const restTime = matchIndex - lastMatch[playerId];
                        totalRestTime += restTime;
                        minRestTime = Math.min(minRestTime, restTime);
                        maxRestTime = Math.max(maxRestTime, restTime);
                        
                        // ÁêÜÊÉ≥‰ºëÊÅØÊó∂Èó¥ÊòØ1-2Âú∫
                        if (restTime >= 2 && restTime <= 3) {
                            score += 500; // Â•ñÂä±ÁêÜÊÉ≥‰ºëÊÅØÊó∂Èó¥
                        } else if (restTime === 1) {
                            score += 100; // ÂèØ‰ª•Êé•Âèó
                        } else if (restTime >= 4) {
                            score -= (restTime - 3) * 200; // ÊÉ©ÁΩö‰ºëÊÅØËøá‰πÖ
                        }
                    }
                    
                    // 3. Â•ñÂä±‰ºëÊÅØÊó∂Èó¥ÂùáÂåÄÁöÑÁªÑÂêà
                    const restTimeVariance = maxRestTime - minRestTime;
                    if (restTimeVariance <= 1) {
                        score += 300; // Â•ñÂä±‰ºëÊÅØÊó∂Èó¥Áõ∏Ëøë
                    } else {
                        score -= restTimeVariance * 50; // ÊÉ©ÁΩö‰ºëÊÅØÊó∂Èó¥Â∑ÆË∑ùÂ§ß
                    }
                    
                    // 4. ÈÅøÂÖçËÆ©‰ºëÊÅØÂ§™‰πÖÁöÑ‰∫∫ÁªßÁª≠‰ºëÊÅØ
                    for (let playerId = 0; playerId < 6; playerId++) {
                        if (!combo.includes(playerId)) { // Ëøô‰∏™‰∫∫Ë¶Å‰ºëÊÅØ
                            const currentRestTime = matchIndex - lastMatch[playerId];
                            if (currentRestTime >= 3) {
                                score -= 400; // ÊÉ©ÁΩöËÆ©Â∑≤Áªè‰ºëÊÅØ‰πÖÁöÑ‰∫∫ÁªßÁª≠‰ºëÊÅØ
                            }
                        }
                    }
                    
                    // 5. Êñ∞Â¢ûÔºö‰ΩøÁî®ÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®Ê£ÄÊü•Ôºà6‰∫∫Ê®°ÂºèÊô∫ËÉΩÂõûÊ∫ØÔºâ
                    // ÁîüÊàêËøô‰∏™ÁªÑÂêàÁöÑÊâÄÊúâÂèØËÉΩÈòü‰ºçÂàÜÁªÑ
                    const possibleTeams = [
                        [[combo[0], combo[1]], [combo[2], combo[3]]],
                        [[combo[0], combo[2]], [combo[1], combo[3]]],
                        [[combo[0], combo[3]], [combo[1], combo[2]]]
                    ];
                    
                    // ÊâæÂà∞ÊúÄ‰Ω≥ÁöÑÂàÜÁªÑÊñπÂºè
                    let bestPartnershipScore = -100000;
                    
                    for (const teamConfig of possibleTeams) {
                        // Ê£ÄÊü•ËøôÁßçÂàÜÁªÑÊòØÂê¶Ë∂ÖÊ†á
                        if (!globalPartnershipManager.canFormTeam(teamConfig[0], teamConfig[1])) {
                            continue; // ËøôÁßçÂàÜÁªÑ‰ºöÂØºËá¥Ë∂ÖÊ†áÔºåË∑≥Ëøá
                        }
                        
                        // ËÆ°ÁÆóËøôÁßçÂàÜÁªÑÁöÑ‰ºòÂÖàÁ∫ßÂàÜÊï∞
                        let teamingScore = 0;
                        teamingScore += globalPartnershipManager.getPartnershipScore(teamConfig[0][0], teamConfig[0][1]);
                        teamingScore += globalPartnershipManager.getPartnershipScore(teamConfig[1][0], teamConfig[1][1]);
                        
                        // È¢ùÂ§ñÂ•ñÂä±ÂåÖÂê´ÊúÄÂ∞ë‰ΩøÁî®ÈÖçÂØπÁöÑÁªÑÂêà
                        if (globalPartnershipManager.containsLeastUsedPair(teamConfig[0], teamConfig[1])) {
                            teamingScore += 15000; // Â§ßÂπÖÂ•ñÂä±ÊúÄÂ∞ë‰ΩøÁî®ÁöÑÈÖçÂØπ
                        }
                        
                        bestPartnershipScore = Math.max(bestPartnershipScore, teamingScore);
                    }
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÂàÜÁªÑÊñπÂºèÔºåËøîÂõûÊûÅ‰ΩéÂàÜÊï∞
                    if (bestPartnershipScore === -100000) {
                        return -100000; // Ëøô‰∏™ÁªÑÂêà‰ºöÂØºËá¥Êê≠ÈÖçË∂ÖÊ†áÔºåÁõ¥Êé•ÊãíÁªù
                    }
                    
                    score += bestPartnershipScore;
                    
                    return score;
                }
                
                function backtrack(matchIndex) {
                    if (matchIndex === 15) {
                        return true; // ÊàêÂäüÊâæÂà∞ÂÆåÊï¥ÂÆâÊéí
                    }
                    
                    // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁªÑÂêàÂπ∂ÊåâÂÖ¨Âπ≥ÊÄßÊéíÂ∫è
                    const availableCombos = [];
                    for (const combo of allCombinations) {
                        const comboKey = combo.join(',');
                        if (used.has(comboKey)) continue;
                        
                        // Ê£ÄÊü•ËøûÁª≠ÊØîËµõÁ∫¶Êùü - Âä†Âº∫Áâà
                        let hasConsecutive = false;
                        let consecutivePlayer = -1;
                        for (const playerId of combo) {
                            if (lastMatch[playerId] === matchIndex - 1) {
                                hasConsecutive = true;
                                consecutivePlayer = playerId;
                                break;
                            }
                        }
                        if (hasConsecutive) {
                            // Ë∞ÉËØï‰ø°ÊÅØÔºöËÆ∞ÂΩïË¢´ÊãíÁªùÁöÑËøûÁª≠ÁªÑÂêà
                            if (matchIndex <= 5) { // Âè™Âú®ÂâçÂá†Âú∫ËÆ∞ÂΩïÔºåÈÅøÂÖçÊó•ÂøóËøáÂ§ö
                                console.log(`   ÊãíÁªùÁªÑÂêà[${combo.join(',')}]: Áé©ÂÆ∂${consecutivePlayer+1}‰ºöËøûÁª≠ÊØîËµõ`);
                            }
                            continue;
                        }
                        
                        // ËÆ°ÁÆóÂÖ¨Âπ≥ÊÄßÂàÜÊï∞
                        const fairnessScore = calculateFairnessScore(combo, matchIndex);
                        availableCombos.push({ combo, score: fairnessScore });
                    }
                    
                    // ÊåâÂÖ¨Âπ≥ÊÄßÂàÜÊï∞ÈôçÂ∫èÊéíÂ∫èÔºå‰ºòÂÖàÂ∞ùËØïÊõ¥ÂÖ¨Âπ≥ÁöÑÁªÑÂêà
                    availableCombos.sort((a, b) => b.score - a.score);
                    
                    // Â∞ùËØïÊúÄÂÖ¨Âπ≥ÁöÑÁªÑÂêà
                    for (const { combo, score } of availableCombos) {
                        // Ë∞ÉËØï‰ø°ÊÅØÔºöËÆ∞ÂΩïÈÄâÊã©ÁöÑÁªÑÂêà
                        if (matchIndex <= 5) { // Âè™Âú®ÂâçÂá†Âú∫ËÆ∞ÂΩï
                            console.log(`   Â∞ùËØïÁ¨¨${matchIndex + 1}Âú∫: [${combo.join(',')}] (Áé©ÂÆ∂${combo.map(id => id+1).join(',')}) ÂàÜÊï∞:${score.toFixed(1)}`);
                        }
                        
                        // Â∞ùËØïËøô‰∏™ÁªÑÂêà
                        schedule[matchIndex] = combo;
                        used.add(combo.join(','));
                        
                        // Êõ¥Êñ∞Áä∂ÊÄÅ
                        const oldLastMatch = [...lastMatch];
                        const oldMatchCount = [...matchCount];
                        for (const playerId of combo) {
                            lastMatch[playerId] = matchIndex;
                            matchCount[playerId]++;
                        }
                        
                        // ÈÄíÂΩíÂ∞ùËØï‰∏ã‰∏ÄÂú∫
                        if (backtrack(matchIndex + 1)) {
                            return true;
                        }
                        
                        // ÂõûÊ∫Ø
                        if (matchIndex <= 5) { // Âè™Âú®ÂâçÂá†Âú∫ËÆ∞ÂΩï
                            console.log(`   ÂõûÊ∫ØÁ¨¨${matchIndex + 1}Âú∫: [${combo.join(',')}] Â§±Ë¥•`);
                        }
                        schedule[matchIndex] = null;
                        used.delete(combo.join(','));
                        for (let i = 0; i < 6; i++) {
                            lastMatch[i] = oldLastMatch[i];
                            matchCount[i] = oldMatchCount[i];
                        }
                    }
                    
                    return false; // Êó†Ê≥ïÊâæÂà∞ÊúâÊïàÂÆâÊéí
                }
                
                if (backtrack(0)) {
                    return schedule;
                } else {
                    throw new Error('Êô∫ËÉΩÂõûÊ∫ØÁÆóÊ≥ïÂ§±Ë¥•ÔºöÊó†Ê≥ïÊâæÂà∞ÂÖ¨Âπ≥ÁöÑ6‰∫∫ÂÆâÊéí');
                }
            }
            
            console.log('üîÑ ‰ΩøÁî®ÂõûÊ∫ØÁÆóÊ≥ïÁîüÊàê6‰∫∫ÂÆâÊéí...');
            const selectedMatches = findValidSchedule();
            console.log('‚úÖ ÂõûÊ∫ØÁÆóÊ≥ïÊàêÂäüÁîüÊàêÂÆåÊï¥ÂÆâÊéíÔºÅ');
            
            // Á´ãÂç≥È™åËØÅÂõûÊ∫ØÁªìÊûúÁöÑÊ≠£Á°ÆÊÄß
            const quickCheck = Array(6).fill(0);
            selectedMatches.forEach(match => {
                match.forEach(playerId => quickCheck[playerId]++);
            });
            console.log('üîç ÂõûÊ∫ØÁÆóÊ≥ïÁªìÊûúÂø´ÈÄüÊ£ÄÊü•:', quickCheck);
            
            // ËØ¶ÁªÜÊä•ÂëäÊØè‰∫∫Âú∫Ê¨°
            for (let i = 0; i < 6; i++) {
                console.log(`   Áé©ÂÆ∂${i+1}: ${quickCheck[i]}Âú∫`);
                if (quickCheck[i] !== 10) {
                    console.error(`‚ùå Áé©ÂÆ∂${i+1}Âú∫Ê¨°ÈîôËØØÔºö${quickCheck[i]}Âú∫ÔºåÂ∫îËØ•10Âú∫`);
                }
            }
            
            if (!quickCheck.every(count => count === 10)) {
                console.error('‚ùå ÂõûÊ∫ØÁÆóÊ≥ïÁªìÊûúÈîôËØØÔºÅÊØè‰∫∫Âú∫Ê¨°:', quickCheck);
                console.error('ÊÄªÂú∫Ê¨°:', quickCheck.reduce((a, b) => a + b, 0), 'Â∫îËØ•ÊòØ60');
                throw new Error(`ÂõûÊ∫ØÁÆóÊ≥ï‰∫ßÁîü‰∫ÜÈîôËØØÁöÑÁªìÊûú: [${quickCheck.join(',')}]`);
            }
            
            // ‰∏•Ê†ºÊ£ÄÊü•ËøûÁª≠ÊØîËµõ - ÁªùÂØπ‰∏çËÉΩÊúâ‰ªª‰ΩïËøûÁª≠
            console.log('üîç ‰∏•Ê†ºÊ£ÄÊü•ËøûÁª≠ÊØîËµõ...');
            for (let playerId = 0; playerId < 6; playerId++) {
                const playerMatches = [];
                selectedMatches.forEach((match, index) => {
                    if (match.includes(playerId)) {
                        playerMatches.push(index);
                    }
                });
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâËøûÁª≠Âú∫Ê¨°
                for (let i = 1; i < playerMatches.length; i++) {
                    if (playerMatches[i] === playerMatches[i-1] + 1) {
                        console.error(`‚ùå Áé©ÂÆ∂${playerId+1}ËøûÁª≠ÊØîËµõÔºöÁ¨¨${playerMatches[i-1]+1}Âíå${playerMatches[i]+1}Âú∫`);
                        console.error('ËØ•Áé©ÂÆ∂ÊâÄÊúâÊØîËµõÂú∫Ê¨°:', playerMatches.map(m => m+1));
                        throw new Error(`ÂõûÊ∫ØÁÆóÊ≥ïÂ§±Ë¥•ÔºöÁé©ÂÆ∂${playerId+1}ÊúâËøûÁª≠ÊØîËµõ`);
                    }
                }
                
                console.log(`   Áé©ÂÆ∂${playerId+1}: Á¨¨${playerMatches.map(m => m+1).join(',')}Âú∫ ‚úì`);
            }
            
            // È™åËØÅÊØè‰∫∫Âú∫Ê¨°Êï∞ - ËØ¶ÁªÜË∞ÉËØï
            const playerCounts = Array(6).fill(0);
            const playerMatchDetails = Array(6).fill(null).map(() => []);
            
            selectedMatches.forEach((match, index) => {
                match.forEach(playerId => {
                    playerCounts[playerId]++;
                    playerMatchDetails[playerId].push(index + 1);
                });
            });
            
            console.log('üìä 6‰∫∫Êï∞Â≠¶ÊûÑÈÄ†È™åËØÅ - ÊØè‰∫∫Âú∫Ê¨°:', playerCounts);
            console.log('üìã ËØ¶ÁªÜÊØîËµõÂÆâÊéí:');
            for (let i = 0; i < 6; i++) {
                console.log(`   Áé©ÂÆ∂${i+1}: ${playerCounts[i]}Âú∫ - Á¨¨${playerMatchDetails[i].join(',')}Âú∫`);
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂú∫Ê¨°ÂàÜÈÖçÈîôËØØ
            const wrongCounts = [];
            for (let i = 0; i < 6; i++) {
                if (playerCounts[i] !== 10) {
                    wrongCounts.push(`Áé©ÂÆ∂${i+1}:${playerCounts[i]}Âú∫`);
                }
            }
            
            if (wrongCounts.length > 0) {
                console.error('‚ùå Âú∫Ê¨°ÂàÜÈÖçÈîôËØØ:', wrongCounts.join(', '));
                console.error('üîç Ë∞ÉËØï‰ø°ÊÅØ:');
                console.error(`   ÈÄâÊã©‰∫Ü${selectedMatches.length}Âú∫ÊØîËµõ`);
                console.error(`   ‰ΩøÁî®‰∫Ü${usedCombinations.size}‰∏™ÁªÑÂêà`);
                console.error(`   ÊÄªÂÖ±Êúâ${allCombinations.length}‰∏™ÂèØÁî®ÁªÑÂêà`);
                
                // Ê£ÄÊü•Âì™‰∫õÁªÑÂêàÊ≤°ÊúâË¢´‰ΩøÁî®
                const unusedCombos = allCombinations.filter(combo => !usedCombinations.has(combo.join(',')));
                if (unusedCombos.length > 0) {
                    console.error(`   Êú™‰ΩøÁî®ÁöÑÁªÑÂêà(${unusedCombos.length}‰∏™):`, unusedCombos);
                }
                
                throw new Error(`6‰∫∫Âú∫Ê¨°ÂàÜÈÖçÈîôËØØ: [${playerCounts.join(',')}], Â∫îËØ•ÊØè‰∫∫10Âú∫`);
            }
            
            // ÊúÄÁªàÁ°ÆËÆ§ÊâÄÊúâÁªÑÂêàÈÉΩË¢´‰ΩøÁî®ÔºàÂõûÊ∫ØÁÆóÊ≥ï‰øùËØÅ‰∫ÜËøô‰∏ÄÁÇπÔºâ
            console.log('‚úÖ ÂõûÊ∫ØÁÆóÊ≥ïÁ°Æ‰øùÊâÄÊúâ15‰∏™ÁªÑÂêàÈÉΩË¢´‰ΩøÁî®');
            
            // ËΩ¨Êç¢‰∏∫ÊØîËµõÊ†ºÂºè
            const matches = selectedMatches.map((match, index) => {
                // ÈöèÊú∫ÂàÜÁªÑ
                const shuffled = [...match].sort(() => Math.random() - 0.5);
                return {
                    team1: [players[shuffled[0]], players[shuffled[1]]],
                    team2: [players[shuffled[2]], players[shuffled[3]]],
                    score1: 0,
                    score2: 0,
                    matchIndex: index
                };
            });
            
            // ÊúÄÁªàÈ™åËØÅ - ÂåÖÊã¨‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏ÉÊ£ÄÊü•
            const isValid = validateMatchesStrictly(matches, 6, players, 10);
            if (!isValid) {
                throw new Error('6‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÊúÄÁªàÈ™åËØÅÂ§±Ë¥•');
            }
            
            // È™åËØÅ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏É
            validateRestDistribution(matches, players);
            
            console.log('‚úÖ 6‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÂÆåÊàêÔºöÊØè‰∫∫10Âú∫ÔºåÊó†ËøûÁª≠ÊØîËµõÔºå‰ºëÊÅØÊó∂Èó¥ÂÖ¨Âπ≥');
            return matches;
        }
        
        // 5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†Ëß£ÂÜ≥ÊñπÊ°à - ‰ΩøÁî®ÁÆóÊ≥ï‰øùËØÅÊ≠£Á°ÆÊÄß
        function generate5PlayerMathematicalSolution(players) {
            console.log('üéØ 5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÔºöÁ°Æ‰øùÊØè‰∫∫ÊÅ∞Â•Ω12Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠');
            
            // 5‰∫∫Êó∂ÔºåÊØèÂú∫4‰∫∫ÂèÇËµõ1‰∫∫‰ºëÊÅØÔºåÊÄªÂÖ±15Âú∫
            // ÊØè‰∫∫ÂèÇËµõ12Âú∫Ôºå‰ºëÊÅØ3Âú∫
            
            // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑ4‰∫∫ÁªÑÂêà C(5,4) = 5Ôºå‰ΩÜÊàë‰ª¨ÈúÄË¶Å15Âú∫
            // ÊâÄ‰ª•ÊØè‰∏™4‰∫∫ÁªÑÂêàË¶ÅÁî®3Ê¨°ÔºåÂØπÂ∫î‰∏çÂêåÁöÑÂàÜÁªÑÊñπÂºè
            const allCombinations = [];
            
            // 5‰∫∫‰∏≠ÈÄâ4‰∫∫ÁöÑÊâÄÊúâÁªÑÂêàÔºåÁîüÊàêÊ≠£Á°ÆÁöÑteam1/team2ÂàÜÁªÑ
            for (let restPlayer = 0; restPlayer < 5; restPlayer++) {
                const playingPlayers = [];
                for (let i = 0; i < 5; i++) {
                    if (i !== restPlayer) {
                        playingPlayers.push(i);
                    }
                }
                
                // 4‰∫∫ÁöÑ3ÁßçÂàÜÁªÑÊñπÂºèÔºåÊòéÁ°ÆÂÆö‰πâteam1Âíåteam2ÔºåÁ°Æ‰øùplayersÊï∞ÁªÑÈ°∫Â∫è‰∏éÂàÜÁªÑ‰∏ÄËá¥
                const [a, b, c, d] = playingPlayers;
                allCombinations.push({
                    players: [a, b, c, d], 
                    restPlayer: restPlayer,
                    team1: [a, b],
                    team2: [c, d]
                });
                allCombinations.push({
                    players: [a, c, b, d], 
                    restPlayer: restPlayer,
                    team1: [a, c],
                    team2: [b, d]
                });
                allCombinations.push({
                    players: [a, d, b, c], 
                    restPlayer: restPlayer,
                    team1: [a, d],
                    team2: [b, c]
                });
            }
            
            console.log(`5‰∫∫ÂÖ±Êúâ${allCombinations.length}Áßç4‰∫∫ÁªÑÂêàÔºàÂê´ÂàÜÁªÑÔºâ`);
            
            // È™åËØÅÁªÑÂêàÁöÑÊ≠£Á°ÆÊÄßÔºöÁ°Æ‰øùteam1Âíåteam2Ê≤°ÊúâÈáçÂ§çÁé©ÂÆ∂
            allCombinations.forEach((combo, index) => {
                const team1Players = combo.team1;
                const team2Players = combo.team2;
                const allPlayers = [...team1Players, ...team2Players];
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂ§çÁé©ÂÆ∂
                const uniquePlayers = [...new Set(allPlayers)];
                if (uniquePlayers.length !== 4) {
                    console.error(`‚ùå ÁªÑÂêà${index}ÊúâÈáçÂ§çÁé©ÂÆ∂ÔºÅ`, combo);
                    throw new Error(`ÁªÑÂêà${index}‰∏≠team1Âíåteam2ÊúâÈáçÂ§çÁé©ÂÆ∂`);
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´‰ºëÊÅØÁé©ÂÆ∂
                if (allPlayers.includes(combo.restPlayer)) {
                    console.error(`‚ùå ÁªÑÂêà${index}‰∏≠ÊØîËµõÁé©ÂÆ∂ÂåÖÂê´‰∫Ü‰ºëÊÅØÁé©ÂÆ∂ÔºÅ`, combo);
                    throw new Error(`ÁªÑÂêà${index}‰∏≠ÊØîËµõÁé©ÂÆ∂ÂåÖÂê´‰∫Ü‰ºëÊÅØÁé©ÂÆ∂`);
                }
            });
            console.log('‚úÖ ÊâÄÊúâÁªÑÂêàÈ™åËØÅÈÄöËøáÔºåÊó†ÈáçÂ§çÁé©ÂÆ∂');
            
            // ‰ΩøÁî®Ë¥™ÂøÉÁÆóÊ≥ïÈÄâÊã©Êó†ËøûÁª≠ÁöÑÈ°∫Â∫è
            const selectedMatches = [];
            const usedCombinations = new Set();
            const playerLastMatch = Array(5).fill(-999);
            const playerMatchCount = Array(5).fill(0);
            
            // ÂàùÂßãÂåñÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®Ôºà5‰∫∫Ê®°ÂºèÔºâ
            globalPartnershipManager = new PartnershipManager(5);
            
            for (let matchIndex = 0; matchIndex < 15; matchIndex++) {
                let bestCombo = null;
                let bestScore = -Infinity;
                
                for (const combo of allCombinations) {
                    const comboKey = combo.players.join(',') + '-' + combo.restPlayer;
                    if (usedCombinations.has(comboKey)) continue;
                    
                    // Ê£ÄÊü•Âú∫Ê¨°ÈôêÂà∂
                    let exceedsLimit = false;
                    for (const playerId of combo.players) {
                        if (playerMatchCount[playerId] >= 12) {
                            exceedsLimit = true;
                            break;
                        }
                    }
                    if (exceedsLimit) continue;
                    
                    // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∫∫ËøûÁª≠ÊØîËµõ
                    let hasConsecutive = false;
                    for (const playerId of combo.players) {
                        if (playerLastMatch[playerId] === matchIndex - 1) {
                            hasConsecutive = true;
                            break;
                        }
                    }
                    if (hasConsecutive) continue;
                    
                    // ËÆ°ÁÆó‰ºòÂÖàÁ∫ßÂàÜÊï∞ - Âº∫Âåñ‰ºëÊÅØÂÖ¨Âπ≥ÊÄß
                    let score = 0;
                    let minRestTime = Infinity;
                    let totalRestTime = 0;
                    
                    // ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºö‰ºòÂÖàÂÆâÊéíÊØîËµõÊ¨°Êï∞Â∞ëÁöÑ‰∫∫
                    for (const playerId of combo.players) {
                        const remaining = 12 - playerMatchCount[playerId];
                        score += remaining * 10000; // ÊûÅÈ´òÊùÉÈáç
                    }
                    
                    // Âº∫Âåñ‰ºëÊÅØÊó∂Èó¥Ê£ÄÊü•
                    for (const playerId of combo.players) {
                        const restTime = matchIndex - playerLastMatch[playerId];
                        minRestTime = Math.min(minRestTime, restTime);
                        totalRestTime += restTime;
                        
                        // Âº∫ÁÉàÊÉ©ÁΩö‰ºëÊÅØÊó∂Èó¥Áü≠ÁöÑÁªÑÂêà
                        if (restTime <= 1) {
                            score -= 100000; // ÊûÅÈáçÂ∫¶ÊÉ©ÁΩö
                        } else if (restTime === 2) {
                            score -= 10000;  // ÈáçÂ∫¶ÊÉ©ÁΩö
                        } else {
                            score += restTime * 1000; // È´òÂ•ñÂä±‰ºëÊÅØÊó∂Èó¥ÈïøÁöÑ
                        }
                    }
                    
                    // È¢ùÂ§ñÂ•ñÂä±ÊâÄÊúâ‰∫∫ÈÉΩ‰ºëÊÅØÂÖÖÂàÜÁöÑÁªÑÂêà
                    if (minRestTime >= 2) {
                        score += minRestTime * 5000;
                    }
                    
                        // Êñ∞Â¢ûÔºö‰ΩøÁî®ÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®Ôºà5‰∫∫Ê®°ÂºèÔºâ
                        const team1Players = combo.team1;
                        const team2Players = combo.team2;
                        
                        // Á°¨ÈôêÂà∂ÔºöÊ£ÄÊü•Êê≠ÈÖçÊòØÂê¶Ë∂ÖÊ†á
                        if (!globalPartnershipManager.canFormTeam(team1Players, team2Players)) {
                            continue; // Áõ¥Êé•Ë∑≥ËøáËøô‰∏™ÁªÑÂêàÔºå‰∏çÂÖÅËÆ∏Ë∂ÖÊ†á
                        }
                        
                        // Êê≠ÈÖç‰ºòÂÖàÁ∫ßËØÑÂàÜ - 5‰∫∫Ê®°ÂºèÂº∫ÂåñÂùáË°°ÊÄß
                        let partnershipScore = 0;
                        const team1Score = globalPartnershipManager.getPartnershipScore(team1Players[0], team1Players[1]);
                        const team2Score = globalPartnershipManager.getPartnershipScore(team2Players[0], team2Players[1]);
                        
                        // 5‰∫∫Ê®°Âºè‰∏ãÂ§ßÂπÖÊèêÂçáÊê≠ÈÖçÂùáË°°ÁöÑÈáçË¶ÅÊÄß
                        partnershipScore += team1Score * 50000; // Ë∂ÖÈ´òÊùÉÈáçÁ°Æ‰øùÂùáË°°
                        partnershipScore += team2Score * 50000;
                        
                        // È¢ùÂ§ñÂ•ñÂä±ÂåÖÂê´ÊúÄÂ∞ë‰ΩøÁî®ÈÖçÂØπÁöÑÁªÑÂêà
                        if (globalPartnershipManager.containsLeastUsedPair(team1Players, team2Players)) {
                            partnershipScore += 100000; // Ë∂ÖÈ´òÂ•ñÂä±ÊúÄÂ∞ë‰ΩøÁî®ÁöÑÈÖçÂØπ
                        }
                        
                        // Âº∫ÁÉàÊÉ©ÁΩöÊé•Ëøë‰∏äÈôêÁöÑÊê≠ÈÖçÁªÑÂêàÔºåË∂ÖÁ∫ßÂº∫ÂåñÊùÉÈáç
                        const team1Count = globalPartnershipManager.getCount(team1Players[0], team1Players[1]);
                        const team2Count = globalPartnershipManager.getCount(team2Players[0], team2Players[1]);
                        
                        // Ë∂ÖÁ∫ßÂº∫ÂäõÊÉ©ÁΩöÔºåÁ°Æ‰øùÊê≠ÈÖçÂùáË°°
                        if (team1Count >= 3) partnershipScore -= 1000000; // Ë∂ÖË∂ÖÈáçÂ∫¶ÊÉ©ÁΩö
                        if (team2Count >= 3) partnershipScore -= 1000000;
                        if (team1Count >= 2) partnershipScore -= 200000;  // Ë∂ÖÈáçÂ∫¶ÊÉ©ÁΩö
                        if (team2Count >= 2) partnershipScore -= 200000;
                        
                        // Â•ñÂä±Êê≠ÈÖçÊ¨°Êï∞Â∞ëÁöÑÁªÑÂêà
                        if (team1Count === 0) partnershipScore += 500000; // Ë∂ÖÈ´òÂ•ñÂä±‰ªéÊú™Êê≠ÈÖçÁöÑ
                        if (team2Count === 0) partnershipScore += 500000;
                        if (team1Count === 1) partnershipScore += 300000; // È´òÂ•ñÂä±Âè™Êê≠ÈÖç1Ê¨°ÁöÑ
                        if (team2Count === 1) partnershipScore += 300000;
                        
                        score += partnershipScore;
                    
                    // Âπ≥Ë°°‰ºëÊÅØÁöÑ‰∫∫ÁöÑÁä∂ÊÄÅ
                    const restPlayerRestTime = matchIndex - playerLastMatch[combo.restPlayer];
                    if (restPlayerRestTime <= 1) {
                        score += 1000; // ÈºìÂä±ËÆ©ÂàöÊØîËµõÁöÑ‰∫∫‰ºëÊÅØ
                    } else if (restPlayerRestTime >= 4) {
                        score -= 500;  // ÈÅøÂÖçÊüê‰∫∫‰ºëÊÅØËøá‰πÖ
                    }
                    
                    score += Math.random() * 100; // Â¢ûÂ§ßÈöèÊú∫Âõ†Â≠êÔºåÂ¢ûÂä†Â§öÊ†∑ÊÄß
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestCombo = combo;
                    }
                }
                
                if (!bestCombo) {
                    throw new Error(`5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†Â§±Ë¥•ÔºöÁ¨¨${matchIndex + 1}Âú∫Êó†ÂèØÁî®ÁªÑÂêà`);
                }
                
                // È™åËØÅÈÄâÊã©ÁöÑÁªÑÂêàÊ≤°ÊúâÈáçÂ§çÁé©ÂÆ∂
                const team1Names = [players[bestCombo.team1[0]], players[bestCombo.team1[1]]];
                const team2Names = [players[bestCombo.team2[0]], players[bestCombo.team2[1]]];
                const allMatchPlayers = [...team1Names, ...team2Names];
                const uniqueMatchPlayers = [...new Set(allMatchPlayers)];
                
                if (uniqueMatchPlayers.length !== 4) {
                    console.error(`‚ùå Á¨¨${matchIndex + 1}Âú∫ÊØîËµõÊúâÈáçÂ§çÁé©ÂÆ∂ÔºÅ`, {
                        team1: team1Names,
                        team2: team2Names,
                        bestCombo: bestCombo
                    });
                    throw new Error(`Á¨¨${matchIndex + 1}Âú∫ÊØîËµõ‰∏≠ÊúâÁé©ÂÆ∂ÈáçÂ§ç`);
                }
                
                // ËÆ∞ÂΩïÈÄâÊã©ÁöÑÁªÑÂêà
                selectedMatches.push({
                    team1: team1Names,
                    team2: team2Names,
                    score1: 0,
                    score2: 0,
                    matchIndex: matchIndex
                });
                usedCombinations.add(bestCombo.players.join(',') + '-' + bestCombo.restPlayer);
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®
                globalPartnershipManager.addTeams(bestCombo.team1, bestCombo.team2);
                
                // Êõ¥Êñ∞Áé©ÂÆ∂Áä∂ÊÄÅ
                for (const playerId of bestCombo.players) {
                    playerLastMatch[playerId] = matchIndex;
                    playerMatchCount[playerId]++;
                }
            }
            
            // È™åËØÅÊØè‰∫∫Âú∫Ê¨°Êï∞
            const finalPlayerCounts = Array(5).fill(0);
            selectedMatches.forEach(match => {
                // ‰ªématchÂØπË±°‰∏≠ÊèêÂèñÁé©ÂÆ∂Á¥¢ÂºïËøõË°åËÆ°Êï∞
                const team1Indices = [
                    players.indexOf(match.team1[0]),
                    players.indexOf(match.team1[1])
                ];
                const team2Indices = [
                    players.indexOf(match.team2[0]),
                    players.indexOf(match.team2[1])
                ];
                
                team1Indices.forEach(idx => { if (idx >= 0) finalPlayerCounts[idx]++; });
                team2Indices.forEach(idx => { if (idx >= 0) finalPlayerCounts[idx]++; });
            });
            
            console.log('üéØ 5‰∫∫ÊúÄÁªàÂú∫Ê¨°ÂàÜÈÖçÔºö', finalPlayerCounts);
            
            // È™åËØÅÊØè‰∫∫ÈÉΩÊòØ12Âú∫
            if (!finalPlayerCounts.every(count => count === 12)) {
                console.error('‚ùå 5‰∫∫Âú∫Ê¨°ÂàÜÈÖç‰∏çÂùáÔºÅÂÆûÈôÖÔºö', finalPlayerCounts, 'ÊúüÊúõÔºöÊØè‰∫∫12Âú∫');
                throw new Error(`5‰∫∫Âú∫Ê¨°ÂàÜÈÖçÈîôËØØÔºö[${finalPlayerCounts.join(',')}]ÔºåÊúüÊúõÊØè‰∫∫12Âú∫`);
            }
            
            // È™åËØÅÊê≠ÈÖçÂùáË°°ÊÄß
            console.log('üîç È™åËØÅ5‰∫∫Âú∫Êê≠ÈÖçÂùáË°°ÊÄß...');
            const partnershipStats = {};
            selectedMatches.forEach(match => {
                // ÁªüËÆ°team1ÁöÑÊê≠ÈÖç
                const team1Indices = [
                    players.indexOf(match.team1[0]),
                    players.indexOf(match.team1[1])
                ];
                const team2Indices = [
                    players.indexOf(match.team2[0]),
                    players.indexOf(match.team2[1])
                ];
                
                // ËÆ∞ÂΩïÊê≠ÈÖçÁªüËÆ°
                const addPartnership = (indices) => {
                    if (indices[0] >= 0 && indices[1] >= 0) {
                        const key = `${Math.min(indices[0], indices[1])}-${Math.max(indices[0], indices[1])}`;
                        partnershipStats[key] = (partnershipStats[key] || 0) + 1;
                    }
                };
                
                addPartnership(team1Indices);
                addPartnership(team2Indices);
            });
            
            // Ê£ÄÊü•Êê≠ÈÖçÂùáË°°ÊÄß
            const counts = Object.values(partnershipStats);
            const minCount = Math.min(...counts);
            const maxCount = Math.max(...counts);
            
            console.log('üìä 5‰∫∫Âú∫Êê≠ÈÖçÁªüËÆ°Ôºö', partnershipStats);
            console.log(`üìè Êê≠ÈÖçËåÉÂõ¥ÔºöÊúÄÂ∞ë${minCount}Ê¨°ÔºåÊúÄÂ§ö${maxCount}Ê¨°`);
            
            // 5‰∫∫Âú∫‰∏•Ê†ºÊ£ÄÊü•ÔºöÊØèÂØπËá≥Â∞ë2Ê¨°ÔºåÊúÄÂ§ö3Ê¨°
            let hasUnbalanced = false;
            Object.entries(partnershipStats).forEach(([key, count]) => {
                const [id1, id2] = key.split('-').map(Number);
                const name1 = players[id1];
                const name2 = players[id2];
                
                if (count < 2) {
                    console.error(`‚ùå Êê≠ÈÖç‰∏çË∂≥: ${name1} + ${name2} = ${count}Ê¨° (Â∫îËØ•Ëá≥Â∞ë2Ê¨°)`);
                    hasUnbalanced = true;
                } else if (count > 3) {
                    console.error(`‚ùå Êê≠ÈÖçËøáÂ§ö: ${name1} + ${name2} = ${count}Ê¨° (Â∫îËØ•ÊúÄÂ§ö3Ê¨°)`);
                    hasUnbalanced = true;
                }
            });
            
            if (hasUnbalanced || minCount < 2 || maxCount > 3) {
                console.error(`‚ùå 5‰∫∫Âú∫Êê≠ÈÖç‰∏çÂùáË°°ÔºÅÊúÄÂ∞ë${minCount}Ê¨°ÔºåÊúÄÂ§ö${maxCount}Ê¨°`);
                throw new Error(`Êê≠ÈÖç‰∏çÂùáË°°ÔºöÊúâÊê≠ÈÖçÂ∞ë‰∫é2Ê¨°ÊàñÂ§ö‰∫é3Ê¨°ÔºåÈúÄË¶ÅÈáçÊñ∞ÁîüÊàê`);
            } else {
                console.log('‚úÖ 5‰∫∫Âú∫Êê≠ÈÖçÂùáË°°ÔºåÊØèÂØπÈÉΩÂú®2-3Ê¨°ËåÉÂõ¥ÂÜÖ');
            }
            
            console.log('‚úÖ 5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†ÂÆåÊàêÔºöÊØè‰∫∫ÊÅ∞Â•Ω12Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠ÔºåÊê≠ÈÖçÁõ∏ÂØπÂùáË°°');
            return selectedMatches;
        }
        
        // È™åËØÅ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏ÉÁöÑÂÖ¨Âπ≥ÊÄß
        function validateRestDistribution(matches, players) {
            console.log('üîç È™åËØÅ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏É...');
            
            const playerMatches = {};
            players.forEach(player => {
                playerMatches[player] = [];
            });
            
            // Êî∂ÈõÜÊØè‰∏™‰∫∫ÂèÇ‰∏éÁöÑÊØîËµõÂú∫Ê¨°
            matches.forEach((match, index) => {
                [...match.team1, ...match.team2].forEach(player => {
                    if (playerMatches[player]) {
                        playerMatches[player].push(index);
                    }
                });
            });
            
            // Ê£ÄÊü•ÊØè‰∏™‰∫∫ÁöÑ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏É
            let hasRestIssue = false;
            for (const player of players) {
                const matchList = playerMatches[player];
                const restPeriods = [];
                
                // ËÆ°ÁÆó‰ºëÊÅØÈó¥Èöî
                for (let i = 1; i < matchList.length; i++) {
                    const restTime = matchList[i] - matchList[i-1] - 1;
                    if (restTime > 0) {
                        restPeriods.push(restTime);
                    }
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâËøáÈïøÁöÑ‰ºëÊÅØÊó∂Èó¥
                const maxRest = Math.max(...restPeriods, 0);
                const avgRest = restPeriods.length > 0 ? restPeriods.reduce((a, b) => a + b, 0) / restPeriods.length : 0;
                
                console.log(`   ${player}: ‰ºëÊÅØÈó¥Èöî [${restPeriods.join(',')}], ÊúÄÈïø${maxRest}Âú∫, Âπ≥Âùá${avgRest.toFixed(1)}Âú∫`);
                
                if (maxRest >= 4) {
                    console.warn(`   ‚ö†Ô∏è ${player}ÊúÄÈïø‰ºëÊÅØ${maxRest}Âú∫ÔºåÂèØËÉΩ‰∏çÂ§üÂÖ¨Âπ≥`);
                    hasRestIssue = true;
                }
                
                // Ê£ÄÊü•ÂºÄÂßãÂíåÁªìÊùüÁöÑ‰ºëÊÅØÊó∂Èó¥
                const firstMatch = matchList[0];
                const lastMatch = matchList[matchList.length - 1];
                if (firstMatch >= 3) {
                    console.warn(`   ‚ö†Ô∏è ${player}Ââç${firstMatch}Âú∫ÈÉΩÂú®‰ºëÊÅØ`);
                    hasRestIssue = true;
                }
                if (lastMatch <= matches.length - 4) {
                    console.warn(`   ‚ö†Ô∏è ${player}ÊúÄÂêé${matches.length - 1 - lastMatch}Âú∫ÈÉΩÂú®‰ºëÊÅØ`);
                    hasRestIssue = true;
                }
            }
            
            if (hasRestIssue) {
                console.warn('‚ö†Ô∏è ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏ÉÂ≠òÂú®‰∏çÂÖ¨Âπ≥Áé∞Ë±°Ôºå‰ΩÜÂú®ÂèØÊé•ÂèóËåÉÂõ¥ÂÜÖ');
            } else {
                console.log('‚úÖ ‰ºëÊÅØÊó∂Èó¥ÂàÜÂ∏ÉÂÖ¨Âπ≥');
            }
        }
        
        // ÊúÄ‰∏•Ê†ºÁöÑÈ™åËØÅÂáΩÊï∞
        function validateMatchesStrictly(matches, playerCount, players, targetPerPlayer) {
            const playerMatches = {};
            
            // ÁªüËÆ°ÊØè‰∏™‰∫∫ÁöÑÊØîËµõ
            players.forEach(player => {
                playerMatches[player] = [];
            });
            
            matches.forEach((match, index) => {
                [...match.team1, ...match.team2].forEach(player => {
                    if (playerMatches[player]) {
                        playerMatches[player].push(index);
                    }
                });
            });
            
            // Ê£ÄÊü•Âú∫Ê¨°
            for (const player of players) {
                const count = playerMatches[player].length;
                if (count !== targetPerPlayer) {
                    console.error(`‚ùå ${player}Âú∫Ê¨°ÈîôËØØÔºö${count}Âú∫ÔºåÂ∫îËØ•${targetPerPlayer}Âú∫`);
                    return false;
                }
            }
            
            // Ê£ÄÊü•ËøûÁª≠ÊØîËµõ - Â¢ûÂº∫Áâà
            for (const player of players) {
                const matches = playerMatches[player];
                let consecutiveCount = 1;
                let maxConsecutive = 1;
                let consecutiveSequences = [];
                
                for (let i = 1; i < matches.length; i++) {
                    if (matches[i] === matches[i-1] + 1) {
                        consecutiveCount++;
                        maxConsecutive = Math.max(maxConsecutive, consecutiveCount);
                        
                        // ËÆ∞ÂΩïËøûÁª≠Â∫èÂàó
                        if (consecutiveCount === 2) {
                            consecutiveSequences.push([matches[i-1], matches[i]]);
                        } else {
                            consecutiveSequences[consecutiveSequences.length - 1].push(matches[i]);
                        }
                        
                        console.error(`‚ùå ${player}ËøûÁª≠ÊØîËµõÔºöÁ¨¨${matches[i-1]+1}Âíå${matches[i]+1}Âú∫`);
                        return false;
                    } else {
                        consecutiveCount = 1;
                    }
                }
                
                // Êä•ÂëäËøûÁª≠ÊÉÖÂÜµ
                if (consecutiveSequences.length > 0) {
                    console.error(`‚ùå ${player}Êúâ${consecutiveSequences.length}‰∏™ËøûÁª≠Â∫èÂàóÔºåÊúÄÈïøËøûÁª≠${maxConsecutive}Âú∫`);
                    consecutiveSequences.forEach((seq, index) => {
                        console.error(`   Â∫èÂàó${index+1}: Á¨¨${seq.map(m => m+1).join(',')}Âú∫`);
                    });
                }
            }
            
            console.log('‚úÖ ‰∏•Ê†ºÈ™åËØÅÈÄöËøáÔºöÂú∫Ê¨°Ê≠£Á°ÆÔºåÊó†ËøûÁª≠ÊØîËµõ');
            return true;
        }

        // ÁªùÂØπ‰øùËØÅÂÖ¨Âπ≥ÁöÑÂ§áÁî®ÁÆóÊ≥ï - ÊâøËÆ§ÊâãÂ∑•È¢ÑËÆæÂ§±Ë¥•ÔºåÁõ¥Êé•‰ΩøÁî®ÁÆóÊ≥ï
        function generateGuaranteedFairMatches(playerCount, players) {
            console.warn('üö® ÊâãÂ∑•È¢ÑËÆæÂÆâÊéíÂ≠òÂú®Áº∫Èô∑ÔºåÁõ¥Êé•‰ΩøÁî®ÁÆóÊ≥ïÁîüÊàê');
            
            // Áõ¥Êé•‰ΩøÁî®ÁÆÄÂçï‰ΩÜÂèØÈù†ÁöÑÈöèÊú∫ÁîüÊàêÁÆóÊ≥ï
            return generateSimpleMatches(playerCount, players);
        }

        // È™åËØÅÈ¢ÑËÆæÂÆâÊéíÁöÑÂÖ¨Âπ≥ÊÄß
        function validatePresetArrangement(matches, playerCount, description) {
            console.log(`üîç È™åËØÅ${description}ÁöÑÂÖ¨Âπ≥ÊÄß:`);
            
            // Ëé∑ÂèñÊâÄÊúâÁé©ÂÆ∂ÂêçÂçï
            const allPlayers = new Set();
            matches.forEach(match => {
                match.team1.forEach(player => allPlayers.add(player));
                match.team2.forEach(player => allPlayers.add(player));
            });
            
            const playerMatches = {};
            
            // ÁªüËÆ°ÊØè‰∏™‰∫∫ÂèÇ‰∏éÁöÑÊØîËµõ
            allPlayers.forEach(player => {
                playerMatches[player] = [];
                matches.forEach((match, index) => {
                    if ([...match.team1, ...match.team2].includes(player)) {
                        playerMatches[player].push(index);
                    }
                });
            });
            
            // Ê£ÄÊü•Âú∫Ê¨°ÂàÜÈÖçÂíåËøûÁª≠ÊØîËµõ
            let hasError = false;
            const expectedMatches = playerCount === 6 ? 10 : 12;
            const maxConsecutiveOverall = 1;
            
            Object.keys(playerMatches).forEach(player => {
                const playerMatchList = playerMatches[player];
                const matchCount = playerMatchList.length;
                
                console.log(`  ${player}: ÂèÇ‰∏é${matchCount}Âú∫ÊØîËµõ (Á¨¨${playerMatchList.map(i => i+1).join(',')}Âú∫)`);
                
                // Ê£ÄÊü•Âú∫Ê¨°Êï∞Èáè
                if (matchCount !== expectedMatches) {
                    console.error(`    ‚ùå Âú∫Ê¨°ÈîôËØØÔºÅÂ∫îËØ•${expectedMatches}Âú∫ÔºåÂÆûÈôÖ${matchCount}Âú∫`);
                    hasError = true;
                }
                
                // Ê£ÄÊü•ËøûÁª≠ÊØîËµõ
                let maxConsecutive = 1;
                let currentConsecutive = 1;
                let consecutiveSequences = [];
                let currentSequence = [playerMatchList[0]];
                
                for (let i = 1; i < playerMatchList.length; i++) {
                    if (playerMatchList[i] === playerMatchList[i-1] + 1) {
                        currentConsecutive++;
                        currentSequence.push(playerMatchList[i]);
                        maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                    } else {
                        if (currentSequence.length > 1) {
                            consecutiveSequences.push([...currentSequence]);
                        }
                        currentConsecutive = 1;
                        currentSequence = [playerMatchList[i]];
                    }
                }
                
                // Ê£ÄÊü•ÊúÄÂêé‰∏Ä‰∏™Â∫èÂàó
                if (currentSequence.length > 1) {
                    consecutiveSequences.push(currentSequence);
                }
                
                if (maxConsecutive > 1) {
                    console.error(`    ‚ùå ËøûÁª≠ÊØîËµõ${maxConsecutive}Âú∫: ${consecutiveSequences.map(seq => `Á¨¨${seq[0]+1}-${seq[seq.length-1]+1}Âú∫`).join(', ')}`);
                    hasError = true;
                } else {
                    console.log(`    ‚úÖ Êó†ËøûÁª≠ÊØîËµõÔºåÂú∫Ê¨°Ê≠£Á°Æ`);
                }
            });
            
            // È™åËØÅÊÄª‰ΩìÁªüËÆ°
            const totalMatches = Object.values(playerMatches).reduce((sum, matches) => sum + matches.length, 0);
            const expectedTotal = matches.length * 4; // ÊØèÂú∫ÊØîËµõ4‰∫∫ÂèÇ‰∏é
            
            if (totalMatches !== expectedTotal) {
                console.error(`‚ùå ÊÄªÂèÇËµõ‰∫∫Ê¨°ÈîôËØØÔºÅÊúüÊúõ${expectedTotal}ÔºåÂÆûÈôÖ${totalMatches}`);
                hasError = true;
            }
            
            if (hasError) {
                console.error(`‚ùå ${description}È™åËØÅÂ§±Ë¥•ÔºÅ`);
                return false;
            } else {
                console.log(`‚úÖ ${description}È™åËØÅÂÆåÂÖ®ÈÄöËøáÔºöÂú∫Ê¨°ÂàÜÈÖçÊ≠£Á°ÆÔºåÊó†ËøûÁª≠ÊØîËµõÔºÅ`);
                return true;
            }
        }

        // ÁîüÊàêÁÆÄÂçïÁöÑÊØîËµõÂÆâÊéíÔºàÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°àÔºâ
        function generateSimpleMatches(playerCount, players) {
            const matches = [];
            const combinations = [];
            
            // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑ4‰∫∫ÁªÑÂêà
            for (let i = 0; i < playerCount; i++) {
                for (let j = i + 1; j < playerCount; j++) {
                    for (let k = 0; k < playerCount; k++) {
                        if (k !== i && k !== j) {
                            for (let l = k + 1; l < playerCount; l++) {
                                if (l !== i && l !== j) {
                                    combinations.push({
                                        team1: [players[i], players[j]],
                                        team2: [players[k], players[l]]
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            // ÈöèÊú∫ÈÄâÊã©15Âú∫ÊØîËµõ
            const shuffled = combinations.sort(() => Math.random() - 0.5);
            for (let i = 0; i < Math.min(15, shuffled.length); i++) {
                matches.push({
                    team1: shuffled[i].team1,
                    team2: shuffled[i].team2,
                    score1: 0,
                    score2: 0,
                    matchIndex: i
                });
            }
            
            console.log(`ÁîüÊàêÁÆÄÂçïÂÆâÊéíÔºö${matches.length}Âú∫ÊØîËµõ`);
            return matches;
        }

        // ÁîüÊàê5‰∫∫15Âú∫ÊØîËµõÔºàÊØè‰∫∫12Âú∫ÔºåÈÅøÂÖçËøûÁª≠ÊØîËµõÔºâ
        // ÁîüÊàê5‰∫∫15Âú∫ÊØîËµõÔºàÊØè‰∫∫12Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2-3Ê¨°Ôºâ
        function generate5PlayerMatches(players) {
            return generateSimple5PlayerSchedule(players);
        }
        
        // 5‰∫∫‰∏ìÁî®‰∏•Ê†ºÁÆóÊ≥ï
        function generateStrictFivePlayerSchedule(players) {
            console.log('üéØ 5‰∫∫Ê®°ÂºèÔºö15Âú∫ÊØîËµõÔºåÊØè‰∫∫ÂøÖÈ°ª12Âú∫ÔºåÁªùÂØπÊó†ËøûÁª≠');
            
            const targetMatches = 15;
            const targetPerPlayer = 12;
            const playerCount = 5;
            
            // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑ4‰∫∫ÁªÑÂêàÔºà‰ªé5‰∫∫‰∏≠ÈÄâ4‰∫∫Ôºâ
            const allCombinations = [];
            for (let i = 0; i < playerCount; i++) {
                for (let j = i + 1; j < playerCount; j++) {
                    for (let k = j + 1; k < playerCount; k++) {
                        for (let l = k + 1; l < playerCount; l++) {
                            // 4‰∫∫ÁªÑÂêàÔºåÂâ©‰∏ã1‰∫∫‰ºëÊÅØ
                            const playingPlayers = [i, j, k, l];
                            const restingPlayer = [0, 1, 2, 3, 4].find(p => !playingPlayers.includes(p));
                            
                            // ÁîüÊàêËøô4‰∫∫ÁöÑÊâÄÊúâÂàÜÁªÑÊñπÂºè
                            const groupings = [
                                { team1: [i, j], team2: [k, l], players: playingPlayers, resting: restingPlayer },
                                { team1: [i, k], team2: [j, l], players: playingPlayers, resting: restingPlayer },
                                { team1: [i, l], team2: [j, k], players: playingPlayers, resting: restingPlayer }
                            ];
                            
                            allCombinations.push(...groupings);
                        }
                    }
                }
            }
            
            console.log(`5‰∫∫Ê®°ÂºèÔºö${allCombinations.length}ÁßçÁªÑÂêàÂèØÈÄâ`);
            
            // Â§öÊ¨°Â∞ùËØïÁîüÊàêÂÆåÁæéÂÆâÊéí
            for (let attempt = 0; attempt < 2000; attempt++) {
                const matches = [];
                const playerLastMatch = Array(playerCount).fill(-999);
                const playerMatchCount = Array(playerCount).fill(0);
                const usedCombinations = new Set();
                
                let success = true;
                
                for (let matchIndex = 0; matchIndex < targetMatches; matchIndex++) {
                    const validCombos = [];
                    
                    // ‰∏•Ê†ºÁ≠õÈÄâÂèØÁî®ÁªÑÂêà
                    for (const combo of allCombinations) {
                        const comboKey = combo.players.slice().sort().join(',') + '_' + combo.team1.slice().sort().join(',') + '_' + combo.team2.slice().sort().join(',');
                        if (usedCombinations.has(comboKey)) continue;
                        
                        // ‰∏•Ê†ºÊ£ÄÊü•Âú∫Ê¨°ÈôêÂà∂
                        let exceedsLimit = false;
                        for (const playerId of combo.players) {
                            if (playerMatchCount[playerId] >= targetPerPlayer) {
                                exceedsLimit = true;
                                break;
                            }
                        }
                        if (exceedsLimit) continue;
                        
                        // ‰∏•Ê†ºÊ£ÄÊü•ËøûÁª≠ÊØîËµõ - ÁªùÂØπ‰∏çÂÖÅËÆ∏‰ªª‰Ωï‰∫∫ËøûÁª≠
                        let hasConsecutive = false;
                        for (const playerId of combo.players) {
                            if (playerLastMatch[playerId] === matchIndex - 1) {
                                hasConsecutive = true;
                                break;
                            }
                        }
                        if (hasConsecutive) continue;
                        
                        // Ê£ÄÊü•‰ºëÊÅØÁöÑ‰∫∫ÊòØÂê¶‰πü‰ºöËøûÁª≠‰ºëÊÅØÂ§™‰πÖ
                        const restingPlayerId = combo.resting;
                        if (playerLastMatch[restingPlayerId] < matchIndex - 3 && playerMatchCount[restingPlayerId] < targetPerPlayer) {
                            // Â¶ÇÊûúÊüê‰∫∫Â∑≤Áªè‰ºëÊÅØË∂ÖËøá3Âú∫‰∏îËøòÈúÄË¶ÅÊØîËµõÔºå‰ºòÂÖàËÆ©‰ªñÊØîËµõ
                            continue;
                        }
                        
                        validCombos.push(combo);
                    }
                    
                    if (validCombos.length === 0) {
                        success = false;
                        break;
                    }
                    
                    // ÈÄâÊã©ÊúÄ‰ºòÁªÑÂêà
                    let bestCombo = null;
                    let bestScore = -Infinity;
                    
                    for (const combo of validCombos) {
                        let score = 0;
                        
                        // ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºö‰ºòÂÖàÂÆâÊéíÊØîËµõÊ¨°Êï∞Â∞ëÁöÑ‰∫∫
                        for (const playerId of combo.players) {
                            const remaining = targetPerPlayer - playerMatchCount[playerId];
                            score += remaining * 10000; // ÊûÅÈ´òÊùÉÈáç
                        }
                        
                        // Ê¨°‰ºòÂÖàÁ∫ßÔºö‰ºòÂÖàÂÆâÊéí‰ºëÊÅØ‰πÖÁöÑ‰∫∫
                        for (const playerId of combo.players) {
                            const restTime = matchIndex - playerLastMatch[playerId];
                            score += Math.min(restTime * 1000, 5000);
                        }
                        
                        // Êñ∞Â¢ûÔºöÈòüÂèãÊê≠ÈÖçÂπ≥Ë°°ÊÄßÊ£ÄÊü•
                        let partnershipPenalty = 0;
                        const team1Partners = combo.team1;
                        const team2Partners = combo.team2;
                        
                        // Ê£ÄÊü•Â∑≤ÊúâÊØîËµõ‰∏≠Ëøô‰∫õÊê≠ÈÖçÂá∫Áé∞ÁöÑÈ¢ëÁéá
                        for (let i = 0; i < matchIndex; i++) {
                            const previousMatch = matches[i];
                            if (previousMatch) {
                                // Ê£ÄÊü•Èòü‰ºç1ÁöÑÊê≠ÈÖçÊòØÂê¶ÈáçÂ§ç
                                const prevTeam1Names = previousMatch.team1.map(name => 
                                    players.findIndex(p => p === name));
                                const prevTeam2Names = previousMatch.team2.map(name => 
                                    players.findIndex(p => p === name));
                                
                                // Â¶ÇÊûúÂΩìÂâçÁªÑÂêàÁöÑÈòü‰ºçÊê≠ÈÖç‰∏é‰πãÂâçÁöÑÂÆåÂÖ®Áõ∏ÂêåÔºåÁªô‰∫àÈáçÂ∫¶ÊÉ©ÁΩö
                                if ((team1Partners[0] === prevTeam1Names[0] && team1Partners[1] === prevTeam1Names[1]) ||
                                    (team1Partners[0] === prevTeam1Names[1] && team1Partners[1] === prevTeam1Names[0])) {
                                    partnershipPenalty += 3000; // ÈáçÂ∫¶ÊÉ©ÁΩöÈáçÂ§çÊê≠ÈÖç
                                }
                                if ((team2Partners[0] === prevTeam2Names[0] && team2Partners[1] === prevTeam2Names[1]) ||
                                    (team2Partners[0] === prevTeam2Names[1] && team2Partners[1] === prevTeam2Names[0])) {
                                    partnershipPenalty += 3000; // ÈáçÂ∫¶ÊÉ©ÁΩöÈáçÂ§çÊê≠ÈÖç
                                }
                            }
                        }
                        
                        score -= partnershipPenalty; // ÂáèÂéªÊê≠ÈÖçÈáçÂ§çÁöÑÊÉ©ÁΩöÂàÜ
                        
                        // Âπ≥Ë°°‰ºëÊÅØÂàÜÈÖç
                        const restingPlayerId = combo.resting;
                        const restingPlayerMatches = playerMatchCount[restingPlayerId];
                        if (restingPlayerMatches < targetPerPlayer) {
                            // Â¶ÇÊûú‰ºëÊÅØÁöÑ‰∫∫ËøòÈúÄË¶ÅÊØîËµõÔºåÁ®çÂæÆÈôç‰ΩéÂàÜÊï∞
                            const remaining = targetPerPlayer - restingPlayerMatches;
                            score -= remaining * 100;
                        }
                        
                        // Â∞èÁöÑÈöèÊú∫Âõ†Â≠êÔºàÂáèÂ∞ëÈöèÊú∫ÊÄßÔºåËÆ©ÁÆóÊ≥ïÊõ¥ÂÄæÂêë‰∫éÂùáË°°Êê≠ÈÖçÔºâ
                        score += Math.random() * 5;
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestCombo = combo;
                        }
                    }
                    
                    if (bestCombo) {
                        matches.push({
                            team1: [players[bestCombo.team1[0]], players[bestCombo.team1[1]]],
                            team2: [players[bestCombo.team2[0]], players[bestCombo.team2[1]]],
                            score1: 0,
                            score2: 0,
                            matchIndex: matchIndex
                        });
                        
                        // Êõ¥Êñ∞Áä∂ÊÄÅ
                        for (const playerId of bestCombo.players) {
                            playerLastMatch[playerId] = matchIndex;
                            playerMatchCount[playerId]++;
                        }
                        
                        const comboKey = bestCombo.players.slice().sort().join(',') + '_' + bestCombo.team1.slice().sort().join(',') + '_' + bestCombo.team2.slice().sort().join(',');
                        usedCombinations.add(comboKey);
                    } else {
                        success = false;
                        break;
                    }
                }
                
                // Â¶ÇÊûúÁîüÊàêÊàêÂäüÔºåËøõË°åÊúÄ‰∏•Ê†ºÁöÑÈ™åËØÅ
                if (success && matches.length === targetMatches) {
                    const isValid = validateMatchesStrictly(matches, playerCount, players, targetPerPlayer);
                    if (isValid) {
                        console.log(`‚úÖ 5‰∫∫ÂÆåÁæéÂÆâÊéíÁîüÊàêÊàêÂäüÔºÅÂ∞ùËØï${attempt + 1}Ê¨°`);
                        return matches;
                    }
                }
                
                // ÊØè100Ê¨°Â∞ùËØïËæìÂá∫ËøõÂ∫¶
                if ((attempt + 1) % 100 === 0) {
                    console.log(`üîÑ 5‰∫∫ÂÆâÊéíÂ∞ùËØïËøõÂ∫¶Ôºö${attempt + 1}/2000`);
                }
            }
            
            console.error('‚ùå 5‰∫∫Ê®°Âºè2000Ê¨°Â∞ùËØïÈÉΩÂ§±Ë¥•‰∫ÜÔºÅ');
            throw new Error('Êó†Ê≥ïÁîüÊàêÁ¨¶ÂêàË¶ÅÊ±ÇÁöÑ5‰∫∫ÊØîËµõÂÆâÊéí');
        }
        
        // ÊòæÁ§∫Êê≠ÈÖçÁªüËÆ°
        function displayPartnershipStats() {
            const activePlayers = getActivePlayers();
            const activePlayerCount = activePlayers.length;
            console.log('ü§ù ÈòüÂèãÊê≠ÈÖçÁªüËÆ°Ôºö');
            
            // ÁªüËÆ°ÂÆûÈôÖÊê≠ÈÖçÊÉÖÂÜµ
            const partnershipStats = {};
            for (let i = 0; i < activePlayerCount; i++) {
                for (let j = i + 1; j < activePlayerCount; j++) {
                    partnershipStats[`${i}-${j}`] = 0;
                }
            }
            
            matchSchedule.forEach((match, index) => {
                // ÁªüËÆ°Èòü‰ºç1ÁöÑÊê≠ÈÖç
                const team1Ids = match.team1.map(name => 
                    activePlayers.findIndex(p => p.name === name));
                const team2Ids = match.team2.map(name => 
                    activePlayers.findIndex(p => p.name === name));
                
                if (team1Ids.length === 2 && team1Ids[0] !== -1 && team1Ids[1] !== -1) {
                    const key = `${Math.min(team1Ids[0], team1Ids[1])}-${Math.max(team1Ids[0], team1Ids[1])}`;
                    partnershipStats[key] = (partnershipStats[key] || 0) + 1;
                }
                
                if (team2Ids.length === 2 && team2Ids[0] !== -1 && team2Ids[1] !== -1) {
                    const key = `${Math.min(team2Ids[0], team2Ids[1])}-${Math.max(team2Ids[0], team2Ids[1])}`;
                    partnershipStats[key] = (partnershipStats[key] || 0) + 1;
                }
            });
            
            console.log('ÊØèÂØπÊê≠ÈÖçÊ¨°Êï∞Ôºö');
            Object.entries(partnershipStats).forEach(([key, count]) => {
                const [id1, id2] = key.split('-').map(Number);
                const name1 = activePlayers[id1]?.name || `Áé©ÂÆ∂${id1+1}`;
                const name2 = activePlayers[id2]?.name || `Áé©ÂÆ∂${id2+1}`;
                console.log(`  ${name1} + ${name2}: ${count}Ê¨°`);
            });
            
            const counts = Object.values(partnershipStats);
            const minCount = Math.min(...counts);
            const maxCount = Math.max(...counts);
            const avgCount = counts.reduce((a, b) => a + b, 0) / counts.length;
            
            console.log(`Êê≠ÈÖçÂùáË°°ÊÄß: ÊúÄÂ∞ë${minCount}Ê¨°, ÊúÄÂ§ö${maxCount}Ê¨°, Âπ≥Âùá${avgCount.toFixed(1)}Ê¨°`);
            
            // Ê†πÊçÆ‰∫∫Êï∞Ë∞ÉÊï¥ÂùáË°°ÊÄßÊ†áÂáÜ
            const currentPlayerCount = activePlayers.length;
            const targetPerPair = currentPlayerCount === 6 ? 2 : 2.4; // ÁêÜËÆ∫Êê≠ÈÖçÊ¨°Êï∞
            
            if (currentPlayerCount === 6) {
                // 6‰∫∫Ê®°ÂºèÔºöÊõ¥‰∏•Ê†ºÁöÑÊ†áÂáÜÔºåÊØèÂØπÂ∫îËØ•Êê≠ÈÖç2Ê¨°
                if (maxCount - minCount <= 1 && minCount >= 1 && maxCount <= 2) {
                    console.log('‚úÖ Êê≠ÈÖçÈùûÂ∏∏ÂùáË°°ÔºÅ');
                    return true;
                } else {
                    console.log('‚ö†Ô∏è 6‰∫∫Ê®°ÂºèÊê≠ÈÖç‰∏çÂ§üÂùáË°°ÔºåÈúÄË¶Å‰ºòÂåñ');
                    
                    // ËØ¶ÁªÜÂàÜÊûêÈóÆÈ¢ò
                    Object.entries(partnershipStats).forEach(([key, count]) => {
                        const [id1, id2] = key.split('-').map(Number);
                        const name1 = activePlayers[id1]?.name || `Áé©ÂÆ∂${id1+1}`;
                        const name2 = activePlayers[id2]?.name || `Áé©ÂÆ∂${id2+1}`;
                        
                        if (count === 0) {
                            console.warn(`‚ùå Êú™Êê≠ÈÖç: ${name1} + ${name2} = 0Ê¨° (Â∫îËØ•2Ê¨°)`);
                        } else if (count === 1) {
                            console.warn(`‚ö†Ô∏è Êê≠ÈÖç‰∏çË∂≥: ${name1} + ${name2} = 1Ê¨° (Â∫îËØ•2Ê¨°)`);
                        } else if (count > 2) {
                            console.warn(`‚ùå Êê≠ÈÖçËøáÂ§ö: ${name1} + ${name2} = ${count}Ê¨° (Â∫îËØ•2Ê¨°)`);
                        }
                    });
                    
                    return false;
                }
            } else {
                // 5‰∫∫Ê®°ÂºèÔºöÁõ∏ÂØπÂÆΩÊùæÁöÑÊ†áÂáÜ
                if (maxCount - minCount <= 2) {
                    console.log('‚úÖ Êê≠ÈÖçÂü∫Êú¨ÂùáË°°ÔºÅ');
                    return true;
                } else {
                    console.log('‚ö†Ô∏è Êê≠ÈÖç‰∏çÂ§üÂùáË°°ÔºåÈúÄË¶Å‰ºòÂåñ');
                    return false;
                }
            }
        }

        // È™åËØÅ15Âú∫ÊØîËµõÁöÑÂÖ¨Âπ≥ÊÄß
        function validateMatchFairness() {
            console.log('üè∏ È™åËØÅ15Âú∫ÊØîËµõÂÖ¨Âπ≥ÊÄßÔºö');
            const activePlayers = getActivePlayers();
            const validationPlayerCount = activePlayers.length;
            
            // È¶ñÂÖàÈ™åËØÅÂü∫Á°ÄÂú∫Ê¨°ÂàÜÈÖç
            const basicMatchCounts = {};
            activePlayers.forEach(player => {
                basicMatchCounts[player.name] = 0;
            });
            
            // ÁªüËÆ°ÊØè‰∏™Áé©ÂÆ∂ÁöÑÂú∫Ê¨°
            matchSchedule.forEach((match, index) => {
                const allPlayingPlayers = [...match.team1, ...match.team2];
                allPlayingPlayers.forEach(playerName => {
                    if (basicMatchCounts[playerName] !== undefined) {
                        basicMatchCounts[playerName]++;
                    }
                });
            });
            
            // Ê£ÄÊü•Âú∫Ê¨°ÂàÜÈÖç
            const expectedPerPlayer = validationPlayerCount === 6 ? 10 : 12;
            const basicCounts = Object.values(basicMatchCounts);
            const basicMin = Math.min(...basicCounts);
            const basicMax = Math.max(...basicCounts);
            
            console.log('üìä Âü∫Á°ÄÂú∫Ê¨°È™åËØÅ:', basicMatchCounts);
            
            if (basicMin !== expectedPerPlayer || basicMax !== expectedPerPlayer) {
                const wrongPlayers = [];
                Object.entries(basicMatchCounts).forEach(([name, count]) => {
                    if (count !== expectedPerPlayer) {
                        wrongPlayers.push(`${name}:${count}Âú∫`);
                    }
                });
                throw new Error(`Âü∫Á°ÄÂú∫Ê¨°ÂàÜÈÖçÈîôËØØÔºö${wrongPlayers.join(', ')}ÔºåÂ∫îËØ•ÊØè‰∫∫${expectedPerPlayer}Âú∫`);
            }
            
            // ÊòæÁ§∫Êê≠ÈÖçÁªüËÆ°
            displayPartnershipStats();
            
            // È¢ùÂ§ñÊ£ÄÊü•ÔºöÊâæÂá∫Êê≠ÈÖçË∂ÖÊ†áÁöÑÁªÑÂêà
            console.log('üîç Êê≠ÈÖçË∂ÖÊ†áÊ£ÄÊü•Ôºö');
            const partnershipStats = {};
            for (let i = 0; i < validationPlayerCount; i++) {
                for (let j = i + 1; j < validationPlayerCount; j++) {
                    partnershipStats[`${i}-${j}`] = 0;
                }
            }
            
            matchSchedule.forEach((match, index) => {
                const team1Ids = match.team1.map(name => 
                    activePlayers.findIndex(p => p.name === name));
                const team2Ids = match.team2.map(name => 
                    activePlayers.findIndex(p => p.name === name));
                
                if (team1Ids.length === 2 && team1Ids[0] !== -1 && team1Ids[1] !== -1) {
                    const key = `${Math.min(team1Ids[0], team1Ids[1])}-${Math.max(team1Ids[0], team1Ids[1])}`;
                    partnershipStats[key] = (partnershipStats[key] || 0) + 1;
                }
                
                if (team2Ids.length === 2 && team2Ids[0] !== -1 && team2Ids[1] !== -1) {
                    const key = `${Math.min(team2Ids[0], team2Ids[1])}-${Math.max(team2Ids[0], team2Ids[1])}`;
                    partnershipStats[key] = (partnershipStats[key] || 0) + 1;
                }
            });
            
            const maxAllowed = validationPlayerCount === 5 ? 3 : 2;
            let hasOverLimit = false;
            
            Object.entries(partnershipStats).forEach(([key, count]) => {
                const [id1, id2] = key.split('-').map(Number);
                const name1 = activePlayers[id1]?.name || `Áé©ÂÆ∂${id1+1}`;
                const name2 = activePlayers[id2]?.name || `Áé©ÂÆ∂${id2+1}`;
                
                if (count > maxAllowed) {
                    console.error(`‚ùå Ë∂ÖÊ†áÊê≠ÈÖç: ${name1} + ${name2} = ${count}Ê¨° (ÊúÄÂ§öÂ∫îËØ•${maxAllowed}Ê¨°)`);
                    hasOverLimit = true;
                } else if (count === 0) {
                    console.warn(`‚ö†Ô∏è Êú™Êê≠ÈÖç: ${name1} + ${name2} = 0Ê¨°`);
                }
            });
            
            if (!hasOverLimit) {
                console.log('‚úÖ ÊâÄÊúâÊê≠ÈÖçÈÉΩÂú®ÈôêÂà∂ËåÉÂõ¥ÂÜÖ');
            }
            
            // Ê£ÄÊü•Êê≠ÈÖçÂùáË°°ÊÄßÔºåÂ¶ÇÊûú‰∏çÂùáË°°ÂàôÊäõÂá∫ÈîôËØØËÆ©ÁÆóÊ≥ïÈáçÊñ∞ÁîüÊàê
            displayPartnershipStats();
            
            // È¢ùÂ§ñÊ£ÄÊü•Êê≠ÈÖçÂùáË°°ÊÄß
            const counts = Object.values(partnershipStats);
            const minCount = Math.min(...counts);
            const maxCount = Math.max(...counts);
            
            // 6‰∫∫Ê®°Âºè‰∏ãÔºåÁêÜËÆ∫‰∏äÊØèÂØπÂ∫îËØ•Êê≠ÈÖç2Ê¨°ÔºåÂÖÅËÆ∏¬±1ÁöÑÂ∑ÆË∑ù
            // 5‰∫∫Ê®°Âºè‰∏ãÔºåÁêÜËÆ∫‰∏äÊØèÂØπÂ∫îËØ•Êê≠ÈÖç2.4Ê¨°ÔºåÂÖÅËÆ∏ËæÉÂ§ßÂ∑ÆË∑ù
            const detectedPlayerCount = Object.keys(partnershipStats).length > 10 ? 6 : 5;
            const maxAllowedGap = detectedPlayerCount === 6 ? 1 : 2; // 6‰∫∫Ê®°ÂºèÊõ¥‰∏•Ê†º
            
            if (maxCount - minCount > maxAllowedGap) {
                // ÊâæÂá∫ÂÖ∑‰Ωì‰∏çÂùáË°°ÁöÑÈÖçÂØπ
                const imbalancedPairs = [];
                Object.entries(partnershipStats).forEach(([key, count]) => {
                    const [id1, id2] = key.split('-').map(Number);
                    if (detectedPlayerCount === 6 && (count === 0 || count > 2)) {
                        imbalancedPairs.push(`Áé©ÂÆ∂${id1+1}+Áé©ÂÆ∂${id2+1}:${count}Ê¨°`);
                    } else if (detectedPlayerCount === 5 && (count < 1 || count > 3)) {
                        imbalancedPairs.push(`Áé©ÂÆ∂${id1+1}+Áé©ÂÆ∂${id2+1}:${count}Ê¨°`);
                    }
                });
                
                throw new Error(`Êê≠ÈÖçÂàÜÈÖç‰∏çÂ§üÂùáË°°ÔºöÊúÄÂ§ßÂ∑ÆË∑ù${maxCount - minCount}Ê¨°Ôºå‰∏çÂùáË°°ÈÖçÂØπÔºö${imbalancedPairs.join(', ')}`);
            }
            
                const playerMatchCounts = {};
            const playerPartners = {};
            const playerConsecutive = {};
            
            // ÂàùÂßãÂåñÁªüËÆ°
            activePlayers.forEach(player => {
                    playerMatchCounts[player.name] = 0;
                playerPartners[player.name] = {};
                playerConsecutive[player.name] = [];
                });
                
            // ÁªüËÆ°ÊØè‰∏™Áé©ÂÆ∂ÁöÑÂèÇËµõÊ¨°Êï∞ÂíåÊê≠Ê°£ÊÉÖÂÜµ
            matchSchedule.forEach((match, matchIndex) => {
                    const playingPlayers = [...match.team1, ...match.team2];
                
                    playingPlayers.forEach(playerName => {
                    if (playerMatchCounts[playerName] !== undefined) {
                        playerMatchCounts[playerName]++;
                        playerConsecutive[playerName].push(matchIndex);
                    }
                });
                
                // ÁªüËÆ°Êê≠Ê°£ÂÖ≥Á≥ª
                match.team1.forEach(player1 => {
                    match.team1.forEach(player2 => {
                        if (player1 !== player2) {
                            if (!playerPartners[player1][player2]) {
                                playerPartners[player1][player2] = 0;
                            }
                            playerPartners[player1][player2]++;
                        }
                    });
                });
                
                match.team2.forEach(player1 => {
                    match.team2.forEach(player2 => {
                        if (player1 !== player2) {
                            if (!playerPartners[player1][player2]) {
                                playerPartners[player1][player2] = 0;
                            }
                            playerPartners[player1][player2]++;
                        }
                    });
                });
            });
            
            console.log('üìä ÂèÇËµõÁªüËÆ°:', playerMatchCounts);
            
            // ËØ¶ÁªÜÊ£ÄÊü•ÊØè‰∏™Áé©ÂÆ∂ÁöÑÂú∫Ê¨°Êï∞
            Object.entries(playerMatchCounts).forEach(([playerName, count]) => {
                if (count !== expectedMatches) {
                    console.error(`‚ùå ${playerName}: ${count}Âú∫ÔºåÂ∫îËØ•${expectedMatches}Âú∫`);
                    
                    // ÊâæÂá∫ËØ•Áé©ÂÆ∂ÂèÇ‰∏éÁöÑÂÖ∑‰ΩìÂú∫Ê¨°
                    const playerMatches = [];
                    matchSchedule.forEach((match, index) => {
                        const playingPlayers = [...match.team1, ...match.team2];
                        if (playingPlayers.includes(playerName)) {
                            playerMatches.push(index + 1);
                        }
                    });
                    console.error(`   ${playerName}ÂèÇ‰∏éÁöÑÂú∫Ê¨°: Á¨¨${playerMatches.join(', ')}Âú∫`);
                }
            });
            console.log('ü§ù Êê≠Ê°£ÁªüËÆ°:', playerPartners);
            
            // Ê£ÄÊü•ÂèÇËµõÊ¨°Êï∞ÂÖ¨Âπ≥ÊÄß
                const matchCounts = Object.values(playerMatchCounts);
                const minMatches = Math.min(...matchCounts);
                const maxMatches = Math.max(...matchCounts);
                
            const expectedMatches = playerCount === 5 ? 12 : 10;
            
            if (minMatches === maxMatches && minMatches === expectedMatches) {
                console.log(`‚úÖ ÂÆåÂÖ®ÂÖ¨Âπ≥ÔºöÊØè‰∫∫ÈÉΩÂèÇÂä†${minMatches}Âú∫ÊØîËµõ`);
            } else {
                console.log(`‚ö†Ô∏è ÂèÇËµõÊ¨°Êï∞ËåÉÂõ¥Ôºö${minMatches}-${maxMatches}Âú∫ÔºåÊúüÊúõ${expectedMatches}Âú∫`);
                
                // ÂàóÂá∫ÊâÄÊúâÂú∫Ê¨°‰∏çÊ≠£Á°ÆÁöÑÁé©ÂÆ∂
                const incorrectPlayers = [];
                Object.entries(playerMatchCounts).forEach(([playerName, count]) => {
                    if (count !== expectedMatches) {
                        incorrectPlayers.push(`${playerName}:${count}Âú∫`);
                    }
                });
                
                console.error(`‚ùå Âú∫Ê¨°ÂàÜÈÖçÈîôËØØÔºö${incorrectPlayers.join(', ')}`);
                throw new Error(`Âú∫Ê¨°ÂàÜÈÖç‰∏çÂùáÂåÄÔºö${incorrectPlayers.join(', ')}ÔºåÈúÄË¶ÅÈáçÊñ∞ÁîüÊàê`);
            }
            
            // Ê£ÄÊü•ËøûÁª≠ÊØîËµõÊÉÖÂÜµ
            Object.keys(playerConsecutive).forEach(playerName => {
                const matches = playerConsecutive[playerName];
                let maxConsecutive = 1;
                let currentConsecutive = 1;
                let consecutiveSequences = [];
                let currentSequence = [matches[0]];
                
                for (let i = 1; i < matches.length; i++) {
                    if (matches[i] === matches[i-1] + 1) {
                        currentConsecutive++;
                        currentSequence.push(matches[i]);
                        maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                    } else {
                        if (currentSequence.length > 1) {
                            consecutiveSequences.push([...currentSequence]);
                        }
                        currentConsecutive = 1;
                        currentSequence = [matches[i]];
                    }
                }
                
                // Ê£ÄÊü•ÊúÄÂêé‰∏Ä‰∏™Â∫èÂàó
                if (currentSequence.length > 1) {
                    consecutiveSequences.push(currentSequence);
                }
                
                console.log(`${playerName} ÊúÄÂ§ßËøûÁª≠ÊØîËµõÔºö${maxConsecutive}Âú∫`);
                if (consecutiveSequences.length > 0) {
                    console.log(`  ËøûÁª≠ÊØîËµõÂ∫èÂàó:`, consecutiveSequences.map(seq => `Á¨¨${seq[0]+1}-${seq[seq.length-1]+1}Âú∫`).join(', '));
                }
                
                // Â¶ÇÊûúÊúâ‰∫∫ËøûÁª≠3Âú∫‰ª•‰∏äÔºåÂèëÂá∫Ë≠¶Âëä
                if (maxConsecutive >= 3) {
                    console.warn(`‚ö†Ô∏è ${playerName} ËøûÁª≠ÊØîËµõ${maxConsecutive}Âú∫Ôºå‰∏çÂ§üÂÖ¨Âπ≥ÔºÅ`);
                }
            });
        }
        

        // Êõ¥Êñ∞Áé©ÂÆ∂ÊòæÁ§∫
        function updatePlayersDisplay() {
            const playersContainer = document.getElementById('playersNames');
            const activePlayers = getActivePlayers();
            const playerNames = activePlayers.map(player => player.name);
            playersContainer.textContent = playerNames.join(' ‚Ä¢ ');
            
            // Êõ¥Êñ∞Ê†áÈ¢ò‰∏≠ÁöÑ‰∫∫Êï∞ÊòæÁ§∫
            const headerSubtitle = document.querySelector('.header p');
            if (headerSubtitle) {
                const playerCount = activePlayers.length;
                if (playerCount === 6) {
                    headerSubtitle.textContent = '6‰∫∫ËΩÆËΩ¨Âà∂ - 15Âú∫ÊØîËµõÔºåÊØè‰∫∫10Âú∫';
                } else if (playerCount === 5) {
                    headerSubtitle.textContent = '5‰∫∫ËΩÆËΩ¨Âà∂ - 15Âú∫ÊØîËµõÔºåÊØè‰∫∫12Âú∫';
                } else {
                    headerSubtitle.textContent = `${playerCount}‰∫∫ËΩÆËΩ¨Âà∂ - ËØ∑ÈÄâÊã©5‰∫∫Êàñ6‰∫∫`;
                }
            }
            
            // Êõ¥Êñ∞Áé©ÂÆ∂Á≠õÈÄâÂô®
            updatePlayerFilterButtons();
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂Á≠õÈÄâÂô®ÊåâÈíÆ
        function updatePlayerFilterButtons() {
            const container = document.getElementById('playerFilterButtons');
            const activePlayers = getActivePlayers();
            
            if (!container) return;
            
            container.innerHTML = '';
            
            activePlayers.forEach(player => {
                const button = document.createElement('button');
                button.className = 'player-filter-btn';
                button.textContent = player.name;
                
                // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÈÄâ‰∏≠
                if (selectedPlayers.has(player.name)) {
                    button.classList.add('selected');
                }
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                button.onclick = () => {
                    togglePlayerFilter(player.name);
                };
                
                container.appendChild(button);
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠‰ªª‰ΩïÁé©ÂÆ∂ÔºåÊòæÁ§∫ÊèêÁ§∫
            if (selectedPlayers.size === 0 && activePlayers.length > 0) {
                const hint = document.createElement('div');
                hint.className = 'filter-hint';
                hint.style.cssText = `
                    color: #999;
                    font-size: 0.8rem;
                    text-align: center;
                    margin-top: 5px;
                    font-style: italic;
                `;
                hint.textContent = 'ÁÇπÂáªÁé©ÂÆ∂ÂêçÂ≠óËøõË°åÁ≠õÈÄâ';
                container.appendChild(hint);
            }
        }

        // ÊòæÁ§∫Áé©ÂÆ∂ÈÖçÁΩÆÂºπÊ°Ü
        function showPlayerConfigModal() {
            updatePlayerConfigDisplay();
            updateFairnessDescription();
            document.getElementById('playerConfigModal').classList.add('active');
        }

        // ÂÖ≥Èó≠Áé©ÂÆ∂ÈÖçÁΩÆÂºπÊ°Ü
        function closePlayerConfigModal() {
            document.getElementById('playerConfigModal').classList.remove('active');
        }

        // Ëá™Âä®Ê£ÄÊµãÂπ∂Êõ¥Êñ∞ÊØîËµõÊ®°Âºè
        function updateGameMode() {
            const activeCount = getActivePlayers().length;
            const modeText = document.getElementById('currentModeText');
            
            if (activeCount === 5) {
                modeText.textContent = '5‰∫∫ÊØîËµõÊ®°Âºè - 15Âú∫ÊØîËµõÔºåÊØè‰∫∫12Âú∫';
            } else if (activeCount === 6) {
                modeText.textContent = '6‰∫∫ÊØîËµõÊ®°Âºè - 15Âú∫ÊØîËµõÔºåÊØè‰∫∫10Âú∫';
            } else if (activeCount < 5) {
                modeText.textContent = `ÂΩìÂâç${activeCount}‰∫∫ - ËØ∑Ëá≥Â∞ëÈÄâÊã©5‰∫∫ÂèÇËµõ`;
            } else {
                modeText.textContent = `ÂΩìÂâç${activeCount}‰∫∫ - ËØ∑ÈÄâÊã©5‰∫∫Êàñ6‰∫∫ÂèÇËµõ`;
            }
            
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂ÈÖçÁΩÆÊòæÁ§∫
        function updatePlayerConfigDisplay() {
            const container = document.getElementById('playerListConfig');
            container.innerHTML = '';
            
            playerConfig.forEach((player, index) => {
                const playerItem = document.createElement('div');
                const isSelected = selectedPlayers.has(player.name);
                playerItem.className = `player-item ${player.active ? 'active' : 'inactive'}`;
                
                // Â¶ÇÊûúÁé©ÂÆ∂ÊøÄÊ¥ªÔºåÊ∑ªÂä†Á≠õÈÄâÂäüËÉΩ
                if (player.active) {
                    playerItem.classList.add('filterable');
                    if (isSelected) {
                        playerItem.classList.add('selected-filter');
                    }
                }
                
                playerItem.innerHTML = `
                    <div class="player-avatar">${player.avatar}</div>
                    <div class="player-info">
                        <input type="text" class="player-name-input" value="${player.name}" 
                               onchange="updatePlayerName(${index}, this.value)"
                               ${!player.active ? 'disabled' : ''}>
                        <div class="player-status">
                            ${player.active ? '‚úÖ ÂèÇËµõ‰∏≠' : '‚ùå Êú™ÂèÇËµõ'}
                            ${isSelected ? ' üîç Â∑≤Á≠õÈÄâ' : ''}
                        </div>
                    </div>
                    <button class="player-toggle ${player.active ? 'active' : 'inactive'}" 
                            onclick="togglePlayer(${index})"
                            ${index >= currentPlayerCount ? 'disabled' : ''}>
                        ${player.active ? 'ÂèÇËµõ' : '‰ºëÊÅØ'}
                    </button>
                `;
                
                // ‰∏∫ÊøÄÊ¥ªÁöÑÁé©ÂÆ∂Ê∑ªÂä†ÁÇπÂáªÁ≠õÈÄâÂäüËÉΩ
                if (player.active) {
                    playerItem.addEventListener('click', (e) => {
                        // ÈÅøÂÖçÁÇπÂáªËæìÂÖ•Ê°ÜÂíåÊåâÈíÆÊó∂Ëß¶Âèë
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
                            return;
                        }
                        togglePlayerFilter(player.name);
                    });
                }
                
                container.appendChild(playerItem);
            });
            
            // Êõ¥Êñ∞Á≠õÈÄâÁä∂ÊÄÅÊòæÁ§∫
            updateFilterStatus();
            
            // Êõ¥Êñ∞ÊØîËµõÊ®°ÂºèÊòæÁ§∫
            updateGameMode();
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂ÂßìÂêç
        function updatePlayerName(index, newName) {
            if (newName.trim()) {
                playerConfig[index].name = newName.trim();
                // Êõ¥Êñ∞Â§¥ÂÉè
                playerConfig[index].avatar = newName.trim().charAt(0).toUpperCase();
            }
        }

        // Êõ¥Êñ∞ÊØîËµõ‰∏≠Áé©ÂÆ∂ÂêçÂ≠óÁöÑÈ´ò‰∫ÆÁä∂ÊÄÅ
        function updatePlayerHighlights() {
            const playerNameSpans = document.querySelectorAll('.clickable-player-name');
            
            playerNameSpans.forEach(span => {
                const playerName = span.textContent;
                const isSelected = selectedPlayers.has(playerName);
                
                if (isSelected) {
                    span.classList.add('selected');
                } else {
                    span.classList.remove('selected');
                }
            });
        }

        // Á≠õÈÄâÂäüËÉΩÁõ∏ÂÖ≥ÂáΩÊï∞
        
        // ÂàáÊç¢Áé©ÂÆ∂Á≠õÈÄâÁä∂ÊÄÅ
        function togglePlayerFilter(playerName) {
            if (selectedPlayers.has(playerName)) {
                selectedPlayers.delete(playerName);
            } else {
                selectedPlayers.add(playerName);
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updatePlayerConfigDisplay();
            updatePlayerFilterButtons(); // Êõ¥Êñ∞Á≠õÈÄâÂô®ÊåâÈíÆÁä∂ÊÄÅ
            updatePlayerHighlights(); // Êõ¥Êñ∞ÊØîËµõ‰∏≠Áé©ÂÆ∂ÂêçÂ≠óÁöÑÈ´ò‰∫ÆÁä∂ÊÄÅ
            applyMatchFilter();
            updateFilterStatus();
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÁ≠õÈÄâ
        function clearAllFilters() {
            selectedPlayers.clear();
            updatePlayerConfigDisplay();
            updatePlayerFilterButtons(); // Êõ¥Êñ∞Á≠õÈÄâÂô®ÊåâÈíÆÁä∂ÊÄÅ
            updatePlayerHighlights(); // Êõ¥Êñ∞ÊØîËµõ‰∏≠Áé©ÂÆ∂ÂêçÂ≠óÁöÑÈ´ò‰∫ÆÁä∂ÊÄÅ
            applyMatchFilter();
            updateFilterStatus();
        }
        
        // Êõ¥Êñ∞Á≠õÈÄâÁä∂ÊÄÅÊòæÁ§∫
        function updateFilterStatus() {
            const filterStatus = document.getElementById('filterStatus');
            const clearFilterBtn = document.getElementById('clearFilterBtn');
            
            if (selectedPlayers.size === 0) {
                filterStatus.style.display = 'none';
                if (clearFilterBtn) clearFilterBtn.style.display = 'none';
                return;
            }
            
            const selectedNames = Array.from(selectedPlayers);
            const filteredMatches = getFilteredMatches();
            
            // ÊòæÁ§∫Á≠õÈÄâÁä∂ÊÄÅ
            filterStatus.style.display = 'block';
            filterStatus.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div>
                        üîç Á≠õÈÄâÊù°‰ª∂Ôºö<strong>${selectedNames.join(' + ')}</strong>
                        <span class="filter-match-count">ÔºàÊòæÁ§∫ ${filteredMatches.length} Âú∫ÊØîËµõÔºâ</span>
                    </div>
                    <button class="filter-clear-btn" onclick="clearAllFilters()">‚úñÔ∏è Ê∏ÖÈô§Á≠õÈÄâ</button>
                </div>
            `;
            
            // ÊòæÁ§∫È°∂ÈÉ®Ê∏ÖÈô§ÊåâÈíÆ
            if (clearFilterBtn) clearFilterBtn.style.display = 'block';
        }
        
        // Ëé∑ÂèñÁ≠õÈÄâÂêéÁöÑÊØîËµõÂàóË°®
        function getFilteredMatches() {
            if (selectedPlayers.size === 0) {
                return matchSchedule;
            }
            
            return matchSchedule.filter(match => {
                const allPlayersInMatch = [...match.team1, ...match.team2];
                // Ê£ÄÊü•ÊØîËµõ‰∏≠ÊòØÂê¶ÂêåÊó∂ÂåÖÂê´ÊâÄÊúâÈÄâ‰∏≠ÁöÑÁé©ÂÆ∂
                return Array.from(selectedPlayers).every(playerName => 
                    allPlayersInMatch.includes(playerName)
                );
            });
        }
        
        // Â∫îÁî®ÊØîËµõÁ≠õÈÄâ
        function applyMatchFilter() {
            const filteredMatches = getFilteredMatches();
            const matchItems = document.querySelectorAll('.preview-match');
            
            matchSchedule.forEach((match, index) => {
                const matchItem = matchItems[index];
                if (matchItem) {
                    if (filteredMatches.includes(match)) {
                        matchItem.classList.remove('filtered-out');
                    } else {
                        matchItem.classList.add('filtered-out');
                    }
                }
            });

            // Â¶ÇÊûúÊúâÁ≠õÈÄâÊù°‰ª∂‰ΩÜÊ≤°ÊúâÂåπÈÖçÁöÑÊØîËµõÔºåÊòæÁ§∫ÊèêÁ§∫
            if (selectedPlayers.size > 0 && filteredMatches.length === 0) {
                showNoMatchesHint();
            } else {
                hideNoMatchesHint();
            }
        }

        // ÊòæÁ§∫Êó†ÂåπÈÖçÊØîËµõÊèêÁ§∫
        function showNoMatchesHint() {
            const container = document.getElementById('matchesPreview');
            let hintDiv = document.getElementById('noMatchesHint');
            
            if (!hintDiv) {
                hintDiv = document.createElement('div');
                hintDiv.id = 'noMatchesHint';
                hintDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 255, 255, 0.95);
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                    text-align: center;
                    z-index: 1000;
                    max-width: 300px;
                `;
                container.appendChild(hintDiv);
            }
            
            const selectedNames = Array.from(selectedPlayers);
            hintDiv.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 15px;">üîç</div>
                <div style="font-weight: bold; margin-bottom: 10px; color: #dc3545;">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊØîËµõ</div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                    Ê≤°ÊúâÊØîËµõÂêåÊó∂ÂåÖÂê´Ôºö<strong>${selectedNames.join(' + ')}</strong>
                </div>
                <button onclick="clearAllFilters()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
                    Ê∏ÖÈô§Á≠õÈÄâÊù°‰ª∂
                </button>
            `;
            hintDiv.style.display = 'block';
        }

        // ÈöêËóèÊó†ÂåπÈÖçÊØîËµõÊèêÁ§∫
        function hideNoMatchesHint() {
            const hintDiv = document.getElementById('noMatchesHint');
            if (hintDiv) {
                hintDiv.style.display = 'none';
            }
        }

        // ÂàáÊç¢Áé©ÂÆ∂ÂèÇËµõÁä∂ÊÄÅ
        function togglePlayer(index) {
            if (index < currentPlayerCount) {
                playerConfig[index].active = !playerConfig[index].active;
                updatePlayerConfigDisplay();
                updateFairnessDescription();
            }
        }

        // Êõ¥Êñ∞ÂÖ¨Âπ≥ÊÄßÊèèËø∞
        function updateFairnessDescription() {
            const activeCount = getActivePlayers().length;
            const descElement = document.getElementById('fairnessDescription');
            
            if (activeCount === 5) {
                descElement.innerHTML = `
                    ‚Ä¢ <strong>5‰∫∫Ê®°Âºè</strong>Ôºö15Âú∫ÊØîËµõÔºåÊØè‰∫∫ÂèÇÂä†12Âú∫<br>
                    ‚Ä¢ <strong>Êê≠Ê°£ÂàÜÈÖç</strong>ÔºöÊØè‰∫∫ÈÉΩËÉΩ‰∏éÂÖ∂‰ªñ4‰∫∫Êê≠Ê°£<br>
                    ‚Ä¢ <strong>‰ºëÊÅØÂàÜÂ∏É</strong>ÔºöÊØè‰∫∫ÊÄªÂÖ±‰ºëÊÅØ3Âú∫ÔºåÂùáÂåÄÂàÜÂ∏É<br>
                    ‚Ä¢ <strong>ÊØîËµõÂº∫Â∫¶</strong>ÔºöÈÄÇ‰∏≠ÔºåÂÆåÂÖ®ÂÖ¨Âπ≥ÂàÜÈÖç
                `;
            } else if (activeCount === 6) {
                descElement.innerHTML = `
                    ‚Ä¢ <strong>6‰∫∫Ê®°Âºè</strong>Ôºö16Âú∫ÊØîËµõÔºåÊØè‰∫∫ÂèÇÂä†10-11Âú∫<br>
                    ‚Ä¢ <strong>Êê≠Ê°£ÂàÜÈÖç</strong>Ôºö13‰∏™Êê≠Ê°£ÁªÑÂêà2Ê¨°Ôºå2‰∏™Êê≠Ê°£ÁªÑÂêà3Ê¨°<br>
                    ‚Ä¢ <strong>‰ºëÊÅØÂàÜÂ∏É</strong>ÔºöÊØè‰∫∫‰ºëÊÅØ5-6Âú∫ÔºåÂêàÁêÜÂàÜÊï£<br>
                    ‚Ä¢ <strong>ÊØîËµõÊó∂Èïø</strong>Ôºö2Â∞èÊó∂40ÂàÜÈíüÔºåÊúÄ‰ºòÂÖ¨Âπ≥ÊÄß
                `;
            } else {
                descElement.innerHTML = `
                    ‚Ä¢ <strong>ÂΩìÂâç${activeCount}‰∫∫</strong>ÔºöËØ∑ÈÄâÊã©5‰∫∫Êàñ6‰∫∫ËøõË°åÊØîËµõ<br>
                    ‚Ä¢ Á≥ªÁªüÂ∞ÜËá™Âä®ÁîüÊàêÊúÄÂÖ¨Âπ≥ÁöÑËΩÆÊç¢ÂÆâÊéí
                `;
            }
        }

        // ‰øùÂ≠òÁé©ÂÆ∂ÈÖçÁΩÆ
        function savePlayerConfig() {
            const activeCount = getActivePlayers().length;
            
            if (activeCount < 5 || activeCount > 6) {
                showAlert('ËØ∑Á°Æ‰øùÂèÇËµõ‰∫∫Êï∞‰∏∫5‰∫∫Êàñ6‰∫∫ÔºÅ', '‚ö†Ô∏è ÂèÇËµõ‰∫∫Êï∞ÈîôËØØ', 'warning');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂêç
            const activeNames = getActivePlayers().map(p => p.name.trim());
            const uniqueNames = [...new Set(activeNames)];
            if (activeNames.length !== uniqueNames.length) {
                showAlert('ÂèÇËµõ‰∫∫Âëò‰∏≠ÊúâÈáçÂêçÔºåËØ∑‰øÆÊîπÂêéÂÜç‰øùÂ≠òÔºÅ', '‚ö†Ô∏è ÂßìÂêçÈáçÂ§ç', 'warning');
                return;
            }
            
            closePlayerConfigModal();
            updatePlayersDisplay();
            
            // ‰øùÂ≠òÁé©ÂÆ∂ÈÖçÁΩÆÂà∞‰∫ëÁ´Ø
            savePlayerConfigToCloud();
            
            // ÈáçÊñ∞ÁîüÊàêÊØîËµõÂÆâÊéí
            generateRandomMatches();
            updateMatchDisplay();
            hideFinalRanking();
            
            window.lastActionType = 'update_players';
            if (saveToSync) saveToSync();
            
            showAlert(`‚úÖ ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÂà∞‰∫ëÁ´ØÔºÅ\n\nÂΩìÂâç${activeCount}‰∫∫ÂèÇËµõÊ®°ÂºèÂ∑≤ÁîüÊïà`, 'ÈÖçÁΩÆÊàêÂäü', 'success');
        }

        // ‰øùÂ≠òÁé©ÂÆ∂ÈÖçÁΩÆÂà∞‰∫ëÁ´Ø
        function savePlayerConfigToCloud() {
            if (!gameClass) {
                console.log('‰∫ëÁ´ØÂ≠òÂÇ®Êú™ÂàùÂßãÂåñÔºå‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®');
                localStorage.setItem('playerConfig', JSON.stringify(playerConfig));
                return;
            }
            
            try {
                const configData = {
                    playerConfig: playerConfig,
                    timestamp: Date.now(),
                    lastUpdatedBy: window.currentUserId || 'anonymous'
                };
                
                // ‰øùÂ≠òÂà∞LeanCloud
                const configObject = new gameClass();
                configObject.set('type', 'playerConfig');
                configObject.set('data', configData);
                configObject.save().then(() => {
                    console.log('‚úÖ Áé©ÂÆ∂ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÂà∞‰∫ëÁ´Ø');
                }).catch(error => {
                    console.error('‚ùå ‰∫ëÁ´Ø‰øùÂ≠òÂ§±Ë¥•:', error);
                    // ÈôçÁ∫ßÂà∞Êú¨Âú∞Â≠òÂÇ®
                    localStorage.setItem('playerConfig', JSON.stringify(playerConfig));
                });
                
            } catch (error) {
                console.error('‚ùå ‰∫ëÁ´Ø‰øùÂ≠òÂºÇÂ∏∏:', error);
                localStorage.setItem('playerConfig', JSON.stringify(playerConfig));
            }
        }

        // ‰ªé‰∫ëÁ´ØÂä†ËΩΩÁé©ÂÆ∂ÈÖçÁΩÆ
        function loadPlayerConfigFromCloud() {
            if (!gameClass) {
                console.log('‰∫ëÁ´ØÂ≠òÂÇ®Êú™ÂàùÂßãÂåñÔºå‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®');
                const saved = localStorage.getItem('playerConfig');
                if (saved) {
                    try {
                        playerConfig = JSON.parse(saved);
                        updatePlayerConfigDisplay();
                        updatePlayersDisplay();
                        console.log('‚úÖ ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁé©ÂÆ∂ÈÖçÁΩÆ');
                    } catch (error) {
                        console.error('‚ùå Êú¨Âú∞ÈÖçÁΩÆËß£ÊûêÂ§±Ë¥•:', error);
                    }
                }
                return;
            }
            
            try {
                const query = new AV.Query(gameClass);
                query.equalTo('type', 'playerConfig');
                query.descending('updatedAt');
                query.first().then(result => {
                    if (result) {
                        const configData = result.get('data');
                        if (configData && configData.playerConfig) {
                            playerConfig = configData.playerConfig;
                            updatePlayerConfigDisplay();
                            updatePlayersDisplay();
                            console.log('‚úÖ ‰ªé‰∫ëÁ´ØÂä†ËΩΩÁé©ÂÆ∂ÈÖçÁΩÆ');
                        }
                    } else {
                        console.log('‰∫ëÁ´ØÊó†ÈÖçÁΩÆÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ');
                    }
                }).catch(error => {
                    console.error('‚ùå ‰∫ëÁ´ØÂä†ËΩΩÂ§±Ë¥•:', error);
                    // Â∞ùËØïÊú¨Âú∞Â≠òÂÇ®
                    const saved = localStorage.getItem('playerConfig');
                    if (saved) {
                        try {
                            playerConfig = JSON.parse(saved);
                            updatePlayerConfigDisplay();
                            updatePlayersDisplay();
                            console.log('‚úÖ ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁé©ÂÆ∂ÈÖçÁΩÆ');
                        } catch (error) {
                            console.error('‚ùå Êú¨Âú∞ÈÖçÁΩÆËß£ÊûêÂ§±Ë¥•:', error);
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå ‰∫ëÁ´ØÂä†ËΩΩÂºÇÂ∏∏:', error);
            }
        }

        // ÊòæÁ§∫ÊØîËµõÂÆâÊéíÂèØËßÜÂåñ
        function showScheduleVisualization() {
            if (matchSchedule.length === 0) {
                showAlert('ËØ∑ÂÖàÁîüÊàêÊØîËµõÂÆâÊéíÔºÅ', '‚ö†Ô∏è ÊöÇÊó†ÊØîËµõÊï∞ÊçÆ', 'warning');
                return;
            }
            
            generateScheduleVisualization();
            document.getElementById('scheduleModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÊØîËµõÂÆâÊéíÂèØËßÜÂåñ
        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
        }

        // ÁîüÊàêÊØîËµõÂÆâÊéíÂèØËßÜÂåñ
        function generateScheduleVisualization() {
            const activePlayers = getActivePlayers();
            const overviewContainer = document.getElementById('scheduleOverview');
            const summaryContainer = document.getElementById('scheduleSummary');
            
            // ÁîüÊàêËØ¶ÁªÜÊØîËµõÂÆâÊéí
            let overviewHTML = '';
            
            // Ê∑ªÂä†Âõæ‰æã
            overviewHTML += `
                <div class="schedule-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>ÊØîËµõ‰∏≠</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc3545;"></div>
                        <span>‰ºëÊÅØ‰∏≠</span>
                    </div>
                </div>
            `;
            
            // ÁîüÊàêÊØè‰∏™‰∫∫ÁöÑÊØîËµõÂÆâÊéíË°®Ê†º
            overviewHTML += '<div class="player-schedule-grid">';
            
            // Ë°®Â§¥
            overviewHTML += '<div class="schedule-header">';
            overviewHTML += '<div class="schedule-player-name">ÂßìÂêç</div>';
            for (let round = 1; round <= 3; round++) {
                for (let match = 1; match <= 5; match++) {
                    overviewHTML += `<div class="schedule-cell" style="background: #f8f9fa; color: #666; font-size: 0.6rem;">R${round}M${match}</div>`;
                }
            }
            overviewHTML += '</div>';
            
            // ÊØè‰∏™Áé©ÂÆ∂ÁöÑË°å
            activePlayers.forEach(player => {
                overviewHTML += `<div class="schedule-player-name">${player.name}</div>`;
                
            for (let round = 0; round < 3; round++) {
                for (let match = 0; match < 5; match++) {
                        const matchData = matchSchedule[round][match];
                        const isPlaying = [...matchData.team1, ...matchData.team2].includes(player.name);
                        
                        if (isPlaying) {
                            overviewHTML += `<div class="schedule-cell playing">‚öΩ</div>`;
                        } else {
                            overviewHTML += `<div class="schedule-cell resting">üí§</div>`;
                        }
                    }
                }
            });
            
            overviewHTML += '</div>';
            
            // ËØ¶ÁªÜÊØîËµõÂÆâÊéí
            for (let round = 0; round < 3; round++) {
                overviewHTML += `
                    <div class="schedule-round">
                        <div class="schedule-round-title">Á¨¨${round + 1}ËΩÆÊØîËµõ</div>
                        <div class="schedule-matches">
                `;
                
                for (let match = 0; match < 5; match++) {
                    const matchData = matchSchedule[round][match];
                    const allPlayers = activePlayers.map(p => p.name);
                    const playingPlayers = [...matchData.team1, ...matchData.team2];
                    const restingPlayers = allPlayers.filter(p => !playingPlayers.includes(p));
                    
                    overviewHTML += `
                        <div class="schedule-match">
                            <div class="match-teams">
                                ${matchData.team1.join(' + ')} VS ${matchData.team2.join(' + ')}
                            </div>
                            <div class="match-rest">
                                ‰ºëÊÅØÔºö${restingPlayers.join(', ')}
                            </div>
                        </div>
                    `;
                }
                
                overviewHTML += '</div></div>';
            }
            
            overviewContainer.innerHTML = overviewHTML;
            
            // ÁîüÊàêÁªüËÆ°ÊëòË¶Å
            const stats = calculatePlayerStats();
            let summaryHTML = '<div style="font-weight: 600; margin-bottom: 10px;">üìä ÂèÇËµõÁªüËÆ°ÊëòË¶Å</div>';
            
            summaryHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
            
            activePlayers.forEach(player => {
                const playerStats = stats[player.name];
                summaryHTML += `
                    <div style="background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">${player.name}</div>
                        <div style="font-size: 0.8rem; color: #666;">
                            ÊØîËµõÔºö${playerStats.totalMatches} Âú∫<br>
                            ‰ºëÊÅØÔºö${playerStats.totalRests} Âú∫<br>
                            Êê≠Ê°£Ôºö${playerStats.partners.length} ‰∫∫
                        </div>
                    </div>
                `;
            });
            
            summaryHTML += '</div>';
            
            // Ê∑ªÂä†ÂÖ¨Âπ≥ÊÄßÂàÜÊûê
            summaryHTML += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">';
            summaryHTML += '<div style="font-weight: 600; margin-bottom: 8px;">‚öñÔ∏è ÂÖ¨Âπ≥ÊÄßÂàÜÊûê</div>';
            
            const matchCounts = Object.values(stats).map(s => s.totalMatches);
            const restCounts = Object.values(stats).map(s => s.totalRests);
            
            const minMatches = Math.min(...matchCounts);
            const maxMatches = Math.max(...matchCounts);
            const minRests = Math.min(...restCounts);
            const maxRests = Math.max(...restCounts);
            
            summaryHTML += `
                <div style="font-size: 0.85rem; color: #495057;">
                    ‚Ä¢ ÊØîËµõÂú∫Ê¨°ËåÉÂõ¥Ôºö${minMatches} - ${maxMatches} Âú∫<br>
                    ‚Ä¢ ‰ºëÊÅØÂú∫Ê¨°ËåÉÂõ¥Ôºö${minRests} - ${maxRests} Âú∫<br>
                    ‚Ä¢ ÂÖ¨Âπ≥ÊÄßËØÑÁ∫ßÔºö${maxMatches - minMatches <= 1 ? '‚úÖ ‰ºòÁßÄ' : '‚ö†Ô∏è ÈúÄË¶Å‰ºòÂåñ'}
                </div>
            `;
            
            summaryHTML += '</div>';
            
            summaryContainer.innerHTML = summaryHTML;
        }

        // ËÆ°ÁÆóÁé©ÂÆ∂ÁªüËÆ°Êï∞ÊçÆ
        function calculatePlayerStats() {
            const activePlayers = getActivePlayers();
            const stats = {};
            
            activePlayers.forEach(player => {
                stats[player.name] = {
                    totalMatches: 0,
                    totalRests: 0,
                    partners: new Set(),
                    opponents: new Set()
                };
            });
            
            for (let round = 0; round < 3; round++) {
                for (let match = 0; match < 5; match++) {
                    const matchData = matchSchedule[round][match];
                    const allPlayers = activePlayers.map(p => p.name);
                    const playingPlayers = [...matchData.team1, ...matchData.team2];
                    
                    // ÁªüËÆ°ÊØîËµõÂíå‰ºëÊÅØ
                    allPlayers.forEach(playerName => {
                        if (playingPlayers.includes(playerName)) {
                            stats[playerName].totalMatches++;
                } else {
                            stats[playerName].totalRests++;
                        }
                    });
                    
                    // ÁªüËÆ°Êê≠Ê°£ÂÖ≥Á≥ª
                    matchData.team1.forEach(player1 => {
                        matchData.team1.forEach(player2 => {
                            if (player1 !== player2) {
                                stats[player1].partners.add(player2);
                            }
                        });
                        matchData.team2.forEach(opponent => {
                            stats[player1].opponents.add(opponent);
                        });
                    });
                    
                    matchData.team2.forEach(player1 => {
                        matchData.team2.forEach(player2 => {
                            if (player1 !== player2) {
                                stats[player1].partners.add(player2);
                            }
                        });
                        matchData.team1.forEach(opponent => {
                            stats[player1].opponents.add(opponent);
                        });
                    });
                }
            }
            
            // ËΩ¨Êç¢Set‰∏∫Êï∞ÁªÑ
            Object.keys(stats).forEach(playerName => {
                stats[playerName].partners = Array.from(stats[playerName].partners);
                stats[playerName].opponents = Array.from(stats[playerName].opponents);
            });
            
            return stats;
        }

        // Êõ¥Êñ∞15Âú∫ÊØîËµõÊòæÁ§∫ - Áõ¥Êé•Âπ≥Èì∫
        function updateMatchDisplay() {
            const container = document.getElementById('matchesPreview');
            container.innerHTML = '';
            
            // Ê∏ÖÈô§ÂàùÂßãÂä†ËΩΩÊèêÁ§∫
            const initialLoading = document.getElementById('initialLoading');
            if (initialLoading) {
                initialLoading.remove();
            }
            
            if (!matchSchedule || matchSchedule.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ËØ∑ÂÖàÁîüÊàêÊØîËµõÂÆâÊéí</div>';
                return;
            }
            
            // Áõ¥Êé•Âπ≥Èì∫ÊâÄÊúâ15Âú∫ÊØîËµõ
            const allMatchesDiv = document.createElement('div');
            allMatchesDiv.className = 'all-matches-container';
            allMatchesDiv.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 10px;
                margin: 20px 0;
            `;
            
            matchSchedule.forEach((matchData, matchIndex) => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'preview-match';
                matchDiv.onclick = () => openMatchScore(matchIndex);
                
                const score1 = matchData.score1;
                const score2 = matchData.score2;
                
                if (score1 > 0 || score2 > 0) {
                    matchDiv.classList.add('completed');
                }
                
                // ÂàõÂª∫ÂèØÁÇπÂáªÁöÑÁé©ÂÆ∂ÂêçÂ≠ó
                const createClickablePlayerNames = (players) => {
                    return players.map(playerName => {
                        const isSelected = selectedPlayers.has(playerName);
                        return `<span class="clickable-player-name ${isSelected ? 'selected' : ''}" onclick="event.stopPropagation(); togglePlayerFilter('${playerName}')">${playerName}</span>`;
                    }).join(' + ');
                };
                
                matchDiv.innerHTML = `
                    <div class="match-text">
                        <div style="font-weight: bold; margin-bottom: 5px;">Á¨¨${matchIndex + 1}Âú∫ÊØîËµõ</div>
                        <div>${createClickablePlayerNames(matchData.team1)} VS ${createClickablePlayerNames(matchData.team2)}</div>
                    </div>
                    <span class="match-score ${score1 > 0 || score2 > 0 ? 'has-score' : ''}" onclick="event.stopPropagation(); openMatchScore(${matchIndex})">${score1} : ${score2}</span>
                `;
                
                allMatchesDiv.appendChild(matchDiv);
            });
            
            container.appendChild(allMatchesDiv);
            
            // Â∫îÁî®Á≠õÈÄâÔºàÂª∂ËøüÊâßË°åÔºåÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞Ôºâ
            setTimeout(() => {
                applyMatchFilter();
                updateFilterStatus();
            }, 0);
        }

        // Êõ¥Êñ∞ÊØîËµõÊñáÊú¨
        function updateMatchTexts() {
            const matchTexts = document.querySelectorAll('.preview-match .match-text');
            matchTexts.forEach((textElement, index) => {
                const round = Math.floor(index / 5);
                const match = index % 5;
                const matchData = matchSchedule[round] && matchSchedule[round][match];
                
                if (matchData) {
                    textElement.textContent = `${matchData.team1.join(' + ')} VS ${matchData.team2.join(' + ')}`;
                }
            });
        }

        // ÂÖ®Â±ÄÂèòÈáèÂ£∞Êòé
        let gameClass = null;

        // LeanCloudÂÆûÊó∂ÂêåÊ≠•ÔºàÂõΩÂÜÖÊúÄ‰Ω≥ÊñπÊ°àÔºâ
        function initSimpleJsonSync() {
            // LeanCloudÈÖçÁΩÆÔºàÊºîÁ§∫ÈÖçÁΩÆÔºåÊÇ®ÂèØ‰ª•ÂàõÂª∫Ëá™Â∑±ÁöÑÔºâ
            const leancloudConfig = {
                appId: 'sHFMtBnumqNruNtqiQFGNuah-gzGzoHsz',
                appKey: 'OQLGQDKCo48oayq0OAnd8g5K',
                serverURL: 'https://shfmtbnu.lc-cn-n1-shared.com'
            };
            
            let lastSyncTime = 0;
            
            // ÂàùÂßãÂåñLeanCloud
            async function init() {
                try {
                    // Ê£ÄÊü• AV ÊòØÂê¶ÂèØÁî®
                    if (typeof AV === 'undefined') {
                        throw new Error('LeanCloud SDK Êú™Âä†ËΩΩ');
                    }
                    
                    showLoading('Ê≠£Âú®ËøûÊé•‰∫ëÁ´Ø...', 'ËøûÊé•LeanCloudÂÆûÊó∂Êï∞ÊçÆÂ∫ì');
                    
                    // ÂàùÂßãÂåñLeanCloud
                    AV.init(leancloudConfig);
                    
                    // ÂàõÂª∫Êï∞ÊçÆÁ±ª
                    gameClass = AV.Object.extend('BadmintonGame');
                    
                    // ‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ
                    await loadFromCloud();
                    
                    // ËÆæÁΩÆÂÆûÊó∂ÁõëÂê¨
                    setupRealtimeListener();
                    
                    isConnected = true;
                    hideLoading();
                    showSyncNotification('üéâ LeanCloudËøûÊé•ÊàêÂäüÔºÅÂÆûÊó∂ÂêåÊ≠•Â∑≤ÂºÄÂêØ');
                    
                } catch (error) {
                    console.error('LeanCloudËøûÊé•Â§±Ë¥•:', error);
                    isConnected = false;
                    hideLoading();
                    
                    // ‰ΩøÁî®ÊºîÁ§∫Ê®°Âºè
                    initDemoMode();
                    
                    showSyncNotification('‚ö†Ô∏è LeanCloudËøûÊé•Â§±Ë¥•Ôºå‰ΩøÁî®ÊºîÁ§∫Ê®°ÂºèÔºàÊï∞ÊçÆ‰ªÖÊú¨Âú∞‰øùÂ≠òÔºâ', 'warning');
                }
            }
            
            // ÊºîÁ§∫Ê®°ÂºèÔºàÊ®°ÊãüÂÆûÊó∂ÂêåÊ≠•Ôºâ
            function initDemoMode() {
                debugLog('ÂêØÂä®ÊºîÁ§∫Ê®°Âºè');
                
                // Á°Æ‰øùÊúâÊØîËµõÊï∞ÊçÆ
                if (!matchSchedule || matchSchedule.length === 0) {
                    debugLog('ÁîüÊàêÊºîÁ§∫ÊØîËµõÊï∞ÊçÆ');
                    generateRandomMatches();
                }
                
                debugLog('Êõ¥Êñ∞ÊòæÁ§∫');
                updatePlayersDisplay();
                updateMatchDisplay();
                
                // Ê®°ÊãüÂÆûÊó∂ÂêåÊ≠•ÁöÑÊú¨Âú∞ÁâàÊú¨
                let syncData = {
                    matchSchedule: matchSchedule,
                    timestamp: Date.now(),
                    lastUpdatedBy: window.currentUserId
                };
                
                // ‰øùÂ≠òÂáΩÊï∞
                saveToSync = function() {
                    syncData = {
                        matchSchedule: matchSchedule,
                        finalRankingVisible: document.getElementById('finalRanking').style.display !== 'none',
                        timestamp: Date.now(),
                        lastUpdatedBy: window.currentUserId,
                        actionType: window.lastActionType
                    };
                    
                    // ‰øùÂ≠òÂà∞localStorage
                    localStorage.setItem('badminton-realtime-demo', JSON.stringify(syncData));
                    
                    showSyncNotification('üìä ÊØîÂàÜÂ∑≤Êõ¥Êñ∞ÔºàÊºîÁ§∫Ê®°ÂºèÔºâ');
                    
                    // Ê®°ÊãüÂÖ∂‰ªñÁî®Êà∑ÁöÑÊõ¥Êñ∞ÈÄöÁü•
                    setTimeout(() => {
                        const actions = {
                            'score_update': 'üìä Ê®°ÊãüÔºöÂÖ∂‰ªñ‰∫∫ÁúãÂà∞‰∫ÜÊØîÂàÜÊõ¥Êñ∞',
                            'regenerate_matches': 'üé≤ Ê®°ÊãüÔºöÂÖ∂‰ªñ‰∫∫ÁúãÂà∞‰∫ÜÈáçÊñ∞ÂºÄÂßã',
                            'show_ranking': 'üèÜ Ê®°ÊãüÔºöÂÖ∂‰ªñ‰∫∫ÁúãÂà∞‰∫ÜÊéíÂêç'
                        };
                        showSyncNotification(actions[window.lastActionType] || 'üìä Ê®°ÊãüÂêåÊ≠•ÂÆåÊàê');
                    }, 2000);
                };
                
                // Ê£ÄÊü•Êú¨Âú∞Êï∞ÊçÆ
                try {
                    const stored = localStorage.getItem('badminton-realtime-demo');
                    if (stored) {
                        const data = JSON.parse(stored);
                        if (data.matchSchedule) {
                            matchSchedule = data.matchSchedule;
                            updateMatchDisplay();
                            
                            if (data.finalRankingVisible) {
                                document.getElementById('finalRanking').style.display = 'block';
                            }
                            
                            showSyncNotification('üìä Âä†ËΩΩ‰∫Ü‰πãÂâçÁöÑÊØîËµõÊï∞ÊçÆ');
                        }
                    }
                } catch (e) {
                    console.log('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•');
                }
            }
            
            // ‰øùÂ≠òÂà∞LeanCloudÔºàÊõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩïÔºâ
            async function save() {
                if (!gameClass) {
                    console.log('LeanCloudÊú™ÂàùÂßãÂåñÔºå‰ΩøÁî®ÊºîÁ§∫Ê®°Âºè');
                return;
            }

                try {
                    showLoading('Ê≠£Âú®ÂêåÊ≠•...', '‰øùÂ≠òÊØîÂàÜÂà∞‰∫ëÁ´ØÊï∞ÊçÆÂ∫ì');
                    
                    const gameData = {
                        matchSchedule: matchSchedule,
                        finalRankingVisible: document.getElementById('finalRanking').style.display !== 'none',
                        timestamp: Date.now(),
                        lastUpdatedBy: window.currentUserId,
                        actionType: window.lastActionType || 'score_update'
                    };
                    
                    // ÂÖàÊü•ÊâæÁé∞ÊúâËÆ∞ÂΩï
                    const query = new AV.Query(gameClass);
                    query.equalTo('gameId', 'current_game');
                    const results = await query.find();
                    
                    let gameObject;
                    if (results.length > 0) {
                        // Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
                        gameObject = results[0];
                    } else {
                        // ÂàõÂª∫Êñ∞ËÆ∞ÂΩï
                        gameObject = new gameClass();
                        gameObject.set('gameId', 'current_game');
                    }
                    
                    gameObject.set('data', gameData);
                    await gameObject.save();
                    
                    lastSyncTime = gameData.timestamp;
                    hideLoading();
                    showSyncNotification('‚òÅÔ∏è ÊØîÂàÜÂ∑≤ÂÆûÊó∂ÂêåÊ≠•');
                    
                } catch (error) {
                    console.error('LeanCloud‰øùÂ≠òÂ§±Ë¥•:', error);
                    hideLoading();
                    showSyncNotification('‚ùå ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú');
                }
            }
            
            // ‰ªéLeanCloudÂä†ËΩΩÊï∞ÊçÆ
            async function loadFromCloud() {
                if (!gameClass) return;
                
                try {
                    showLoading('Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...', '‰ªé‰∫ëÁ´ØËé∑ÂèñÊúÄÊñ∞ÊØîÂàÜÊï∞ÊçÆ');
                    
                    const query = new AV.Query(gameClass);
                    query.equalTo('gameId', 'current_game');
                    query.descending('updatedAt');
                    query.limit(1);
                    
                    const results = await query.find();
                    
                    if (results.length > 0) {
                        const gameData = results[0].get('data');
                        
                        if (gameData && gameData.matchSchedule) {
                            matchSchedule = gameData.matchSchedule;
                            lastSyncTime = gameData.timestamp || 0;
                            updateMatchDisplay();
                            
                            if (gameData.finalRankingVisible) {
                                document.getElementById('finalRanking').style.display = 'block';
                            }
                            
                            hideLoading();
                            showSyncNotification('üìä ‰∫ëÁ´ØÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
                        } else {
                            hideLoading();
                            generateRandomMatches();
                            updateMatchDisplay();
                            showSyncNotification('üé≤ ÁîüÊàê‰∫ÜÊñ∞ÁöÑÊØîËµõÂÆâÊéí');
                        }
                    } else {
                        // ‰∫ëÁ´ØÊ≤°ÊúâÊï∞ÊçÆÔºåÁîüÊàêÊñ∞ÊØîËµõ
                        hideLoading();
                        generateRandomMatches();
                        updateMatchDisplay();
                        showSyncNotification('üé≤ ÁîüÊàê‰∫ÜÊñ∞ÁöÑÊØîËµõÂÆâÊéí');
                    }
                    
                } catch (error) {
                    console.error('LeanCloudÂä†ËΩΩÂ§±Ë¥•:', error);
                    hideLoading();
                    generateRandomMatches();
                    updateMatchDisplay();
                    showSyncNotification('‚ö†Ô∏è Âä†ËΩΩÂ§±Ë¥•ÔºåÁîüÊàêÊñ∞ÊØîËµõ');
                }
            }
            
            // ËÆæÁΩÆÂÆûÊó∂ÁõëÂê¨Ôºà‰ΩøÁî®ËΩÆËØ¢Á°Æ‰øùÂèØÈù†ÊÄßÔºâ
            function setupRealtimeListener() {
                if (!gameClass) return;
                
                // ÊØè10ÁßíÊ£ÄÊü•‰∫ëÁ´ØÊõ¥Êñ∞ÔºàÈôç‰ΩéÈ¢ëÁéáÈÅøÂÖçË∂ÖËøáLeanCloudÈôêÂà∂Ôºâ
                setInterval(async () => {
                    try {
                        const query = new AV.Query(gameClass);
                        query.equalTo('gameId', 'current_game');
                        query.descending('updatedAt');
                        query.limit(1);
                        
                        const results = await query.find();
                        
                        if (results.length > 0) {
                            const gameData = results[0].get('data');
                            
                            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞Êï∞ÊçÆ
                            if (gameData && gameData.timestamp > lastSyncTime && 
                                gameData.lastUpdatedBy !== window.currentUserId) {
                                
                                lastSyncTime = gameData.timestamp;
                                
                                // Êõ¥Êñ∞ÊØîËµõÊï∞ÊçÆ
                                matchSchedule = gameData.matchSchedule;
                                updateMatchDisplay();
                                
                                // Êõ¥Êñ∞ÊéíÂêçÊòæÁ§∫Áä∂ÊÄÅ
                                if (gameData.finalRankingVisible) {
                                    document.getElementById('finalRanking').style.display = 'block';
                                } else {
                                    document.getElementById('finalRanking').style.display = 'none';
                                }
                                
                                // ÊòæÁ§∫ÂÆûÊó∂Êõ¥Êñ∞ÊèêÁ§∫ - Êõ¥ÊòéÊòæÁöÑÈÄöÁü•
                                const actions = {
                                    'score_update': 'üî• Êúâ‰∫∫‰øÆÊîπ‰∫ÜÊØîÂàÜÔºÅ',
                                    'regenerate_matches': 'üé≤ Êúâ‰∫∫ÈáçÊñ∞ÂºÄÂßã‰∫ÜÊØîËµõ',
                                    'show_ranking': 'üèÜ Êúâ‰∫∫Êü•Áúã‰∫ÜÊéíÂêç',
                                    'hide_ranking': '‚ùå Êúâ‰∫∫ÂÖ≥Èó≠‰∫ÜÊéíÂêç'
                                };
                                
                                const notificationMessage = actions[gameData.actionType] || 'üìä ÂÆûÊó∂Êï∞ÊçÆÊõ¥Êñ∞';
                                showSyncNotification(notificationMessage);
                                
                                // Â¶ÇÊûúÊòØÊØîÂàÜÊõ¥Êñ∞ÔºåÊòæÁ§∫Êõ¥ÊòéÊòæÁöÑÊèêÁ§∫
                                if (gameData.actionType === 'score_update') {
                                    showAlert('üî• Êúâ‰∫∫‰øÆÊîπ‰∫ÜÊØîÂàÜÔºÅ\n\nÈ°µÈù¢Êï∞ÊçÆÂ∑≤Ëá™Âä®Êõ¥Êñ∞', 'ÊØîÂàÜÊõ¥Êñ∞ÊèêÈÜí', 'info');
                                }
                            }
                        }
                        
                    } catch (error) {
                        console.log('ÂÆûÊó∂Ê£ÄÊü•Â§±Ë¥•:', error);
                    }
                }, 10000); // ÊØè10ÁßíÊ£ÄÊü•‰∏ÄÊ¨°ÔºåÈôç‰ΩéÈ¢ëÁéáÈÅøÂÖçË∂ÖËøá‰ΩøÁî®ÈôêÂà∂
                
                showSyncNotification('üî• ÂÆûÊó∂ÁõëÂê¨Â∑≤ÂºÄÂêØÔºà10ÁßíÊ£ÄÊü•Ôºâ');
            }
            
            
            init();
            return save;
        }

        // ÊâìÂºÄÊØîÂàÜÈÄâÊã©Âô®
        function openMatchScore(matchIndex) {
            selectedRound = 0; // ‰∏çÂÜç‰ΩøÁî®ËΩÆÊ¨°Ê¶ÇÂøµ
            selectedMatch = matchIndex;
            
            const matchData = matchSchedule[matchIndex];
            if (!matchData) return;

            team1Score = matchData.score1;
            team2Score = matchData.score2;
            team1ScoreSet = matchData.score1 > 0;
            team2ScoreSet = matchData.score2 > 0;

            document.getElementById('advancedScoreTitle').textContent = `Á¨¨${matchIndex + 1}Âú∫ÊØîËµõ`;
            document.getElementById('team1Name').textContent = matchData.team1.join(' + ');
            document.getElementById('team2Name').textContent = matchData.team2.join(' + ');

            createScoreWheel('scoreWheel1', team1Score);
            createScoreWheel('scoreWheel2', team2Score);
            updateScoreStatus();

            document.getElementById('advancedScoreModal').classList.add('active');
        }

        // ÂàõÂª∫ÊØîÂàÜËΩÆÊí≠Ôºà0-25ÂàÜÔºåÊîØÊåÅ‰∏äÊãâÂø´ÈÄüÂà∞ËææÈ´òÂàÜÔºâ
        function createScoreWheel(wheelId, currentScore) {
            const wheel = document.getElementById(wheelId);
            wheel.innerHTML = '';

            // Êîπ‰∏∫0-21ÂàÜËåÉÂõ¥ÔºàÁæΩÊØõÁêÉÊ†áÂáÜÔºâ
            for (let i = 0; i <= 21; i++) {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                scoreItem.textContent = i;
                scoreItem.onclick = () => selectWheelScore(wheelId, i);
                wheel.appendChild(scoreItem);
            }

            setWheelPosition(wheelId, currentScore);
        }

        // ËÆæÁΩÆËΩÆÊí≠‰ΩçÁΩÆ
        function setWheelPosition(wheelId, score) {
            const wheel = document.getElementById(wheelId);
            const items = wheel.children;
            
            const offset = -score * 40 + 40;
            wheel.style.transform = `translateY(${offset}px)`;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const distance = Math.abs(i - score);
                
                item.classList.remove('center', 'adjacent', 'distant');
                
                if (distance === 0) {
                    item.classList.add('center');
                } else if (distance === 1) {
                    item.classList.add('adjacent');
                } else {
                    item.classList.add('distant');
                }
            }
        }

        // ÈÄâÊã©ÂàÜÊï∞
        function selectWheelScore(wheelId, score) {
            if (wheelId === 'scoreWheel1') {
                team1Score = score;
                team1ScoreSet = true;
            } else {
                team2Score = score;
                team2ScoreSet = true;
            }

            setWheelPosition(wheelId, score);
            updateScoreStatus();
        }

        // Ëß¶Êë∏Â§ÑÁêÜÔºà‰ºòÂåñ‰∏äÊãâÊìç‰ΩúÔºåÊîØÊåÅÂø´ÈÄüÂà∞ËææÈ´òÂàÜÔºâ
        function handleTouchStart(event, teamIndex) {
            event.preventDefault();
            touchStartY = event.touches[0].clientY;
            isDragging = true;
        }

        function handleTouchMove(event, teamIndex) {
            if (!isDragging) return;
            event.preventDefault();
            
            const currentY = event.touches[0].clientY;
            const deltaY = touchStartY - currentY;
            
            // ‰ºòÂåñÁÅµÊïèÂ∫¶Ôºö‰∏äÊãâÊó∂Êõ¥ÁÅµÊïèÔºå‰æø‰∫éÂø´ÈÄüÂà∞Ëææ21ÂàÜÁ≠âÈ´òÂàÜ
            let sensitivity = 40;
            if (deltaY > 0) { // ‰∏äÊãâÊó∂Èôç‰ΩéÁÅµÊïèÂ∫¶ÔºåÊõ¥ÂÆπÊòìÊªëÂä®
                sensitivity = 30;
            }
            
            const scoreChange = Math.round(deltaY / sensitivity);
            if (Math.abs(scoreChange) >= 1) {
                const currentScore = teamIndex === 0 ? team1Score : team2Score;
                // Êõ¥Êñ∞‰∏∫0-25ÂàÜËåÉÂõ¥
                const newScore = Math.max(0, Math.min(21, currentScore + scoreChange));
                
                selectWheelScore(teamIndex === 0 ? 'scoreWheel1' : 'scoreWheel2', newScore);
                touchStartY = currentY;
            }
        }

        function handleTouchEnd(event, teamIndex) {
            isDragging = false;
        }

        function handleMouseDown(event, teamIndex) {
            event.preventDefault();
            touchStartY = event.clientY;
            isDragging = true;
        }

        function handleMouseMove(event, teamIndex) {
            if (!isDragging) return;
            event.preventDefault();
            
            const currentY = event.clientY;
            const deltaY = touchStartY - currentY;
            
            // ‰ºòÂåñÈº†Ê†áÊªöÂä®ÁÅµÊïèÂ∫¶Ôºö‰∏äÊªëÊó∂Êõ¥ÁÅµÊïè
            let sensitivity = 40;
            if (deltaY > 0) { // ‰∏äÊªëÊó∂Èôç‰ΩéÁÅµÊïèÂ∫¶ÔºåÊõ¥ÂÆπÊòìÊªëÂä®
                sensitivity = 30;
            }
            
            const scoreChange = Math.round(deltaY / sensitivity);
            if (Math.abs(scoreChange) >= 1) {
                const currentScore = teamIndex === 0 ? team1Score : team2Score;
                // Êõ¥Êñ∞‰∏∫0-25ÂàÜËåÉÂõ¥
                const newScore = Math.max(0, Math.min(21, currentScore + scoreChange));
                
                selectWheelScore(teamIndex === 0 ? 'scoreWheel1' : 'scoreWheel2', newScore);
                touchStartY = currentY;
            }
        }

        function handleMouseUp(event, teamIndex) {
            isDragging = false;
        }

        // Â§ÑÁêÜÊªöËΩÆ‰∫ã‰ª∂ÔºåÊîØÊåÅÂêë‰∏äÂêë‰∏ãÊªöÂä®
        function handleWheelScroll(event, teamIndex) {
            event.preventDefault();
            event.stopPropagation();
            
            const currentScore = teamIndex === 0 ? team1Score : team2Score;
            let newScore = currentScore;
            
            // Âêë‰∏äÊªöÂä®ÔºàdeltaY < 0ÔºâÂ¢ûÂä†ÂàÜÊï∞ÔºåÂêë‰∏ãÊªöÂä®ÔºàdeltaY > 0ÔºâÂáèÂ∞ëÂàÜÊï∞
            if (event.deltaY < 0) {
                // Âêë‰∏äÊªöÂä®ÔºåÂ¢ûÂä†ÂàÜÊï∞
                newScore = Math.min(21, currentScore + 1);
            } else if (event.deltaY > 0) {
                // Âêë‰∏ãÊªöÂä®ÔºåÂáèÂ∞ëÂàÜÊï∞
                newScore = Math.max(0, currentScore - 1);
            }
            
            if (newScore !== currentScore) {
                selectWheelScore(teamIndex === 0 ? 'scoreWheel1' : 'scoreWheel2', newScore);
            }
        }

        // Êõ¥Êñ∞ÊØîÂàÜÁä∂ÊÄÅ
        function updateScoreStatus() {
            const statusElement = document.getElementById('scoreStatus');
            const saveBtn = document.getElementById('saveScoresBtn');

            if (team1ScoreSet && team2ScoreSet) {
                statusElement.textContent = `ÊØîÂàÜËÆæÁΩÆÂÆåÊàêÔºö${team1Score} : ${team2Score}`;
                statusElement.className = 'score-status complete';
                saveBtn.disabled = false;
            } else if (team1ScoreSet) {
                statusElement.textContent = `Â∑¶‰æßÂ∑≤ËÆæÁΩÆÔºö${team1Score}ÂàÜÔºåËØ∑ËÆæÁΩÆÂè≥‰æßÊØîÂàÜ`;
                statusElement.className = 'score-status';
                saveBtn.disabled = true;
            } else if (team2ScoreSet) {
                statusElement.textContent = `Âè≥‰æßÂ∑≤ËÆæÁΩÆÔºö${team2Score}ÂàÜÔºåËØ∑ËÆæÁΩÆÂ∑¶‰æßÊØîÂàÜ`;
                statusElement.className = 'score-status';
                saveBtn.disabled = true;
            } else {
                statusElement.textContent = 'ËØ∑ÊªëÂä®„ÄÅÊªöËΩÆÊàñÁÇπÂáªÊï∞Â≠óËÆæÁΩÆÂèåÊñπÊØîÂàÜÔºà0-21ÂàÜÔºåÊîØÊåÅÂêë‰∏äÊªöÂä®Ôºâ';
                statusElement.className = 'score-status';
                saveBtn.disabled = true;
            }
        }

        // ‰øùÂ≠òÊØîÂàÜ
        function saveMatchScores() {
            if (!team1ScoreSet || !team2ScoreSet) {
                showAlert('ËØ∑‰∏∫ÂèåÊñπÈòü‰ºçÈÉΩËÆæÁΩÆÊØîÂàÜÔºÅ', '‚ö†Ô∏è ËÆæÁΩÆ‰∏çÂÆåÊï¥', 'warning');
                return;
            }

            const matchData = matchSchedule[selectedMatch];
            matchData.score1 = team1Score;
            matchData.score2 = team2Score;

            updateMatchDisplay();
            closeAdvancedScoreModal();
            
            window.lastActionType = 'score_update';
            if (saveToSync) saveToSync();
            
            showAlert(`Á¨¨${selectedMatch + 1}Âú∫ÊØîÂàÜÂ∑≤‰øùÂ≠òÔºö${team1Score} : ${team2Score}`, '‚úÖ ‰øùÂ≠òÊàêÂäü', 'success');
        }

        // ÂÖ≥Èó≠ÊØîÂàÜÈÄâÊã©Âô®
        function closeAdvancedScoreModal() {
            document.getElementById('advancedScoreModal').classList.remove('active');
            team1ScoreSet = false;
            team2ScoreSet = false;
        }

        // ÈáçÊñ∞ÂºÄÂßãÊØîËµõ
        function regenerateMatches() {
            showConfirm(
                'Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÊØîËµõÂêóÔºü\nËøôÂ∞ÜÈáçÊñ∞ÈöèÊú∫ÂÆâÊéíÈòüÂèãÂπ∂Ê∏ÖÈô§ÊâÄÊúâÊØîÂàÜ„ÄÇ',
                'üé≤ ÈáçÊñ∞ÂºÄÂßãÊØîËµõ',
                () => {
                    generateRandomMatches();
                    updatePlayersDisplay();
                    updateMatchDisplay();
                    hideFinalRanking();
                    
                    window.lastActionType = 'regenerate_matches';
                    if (saveToSync) saveToSync();
                    
                    showAlert('üéâ ÊØîËµõÂ∑≤ÈáçÊñ∞ÂÆâÊéíÔºÅ', 'ÂÆâÊéíÂÆåÊàê', 'success');
                }
            );
        }

        // ÊòæÁ§∫ÊéíÂêç
        function showFinalRanking() {
            const incompleteMatches = [];
            
            matchSchedule.forEach((matchData, matchIndex) => {
                if (matchData.score1 === 0 && matchData.score2 === 0) {
                        incompleteMatches.push({
                        matchIndex: matchIndex,
                        matchData: matchData
                    });
                }
            });

            // ‰øÆÊîπÈÄªËæëÔºöÂÖÅËÆ∏Êü•Áúã‰∏¥Êó∂ÊéíÂêçÔºå‰ΩÜÊèê‰æõÊèêÁ§∫‰ø°ÊÅØ
            if (incompleteMatches.length > 0) {
                const completedMatches = matchSchedule.length - incompleteMatches.length;
                showAlert(
                    `ÂΩìÂâçÊòæÁ§∫‰∏¥Êó∂ÊéíÂêçÔºàÂü∫‰∫éÂ∑≤ÂÆåÊàêÁöÑ ${completedMatches} Âú∫ÊØîËµõÔºâ\n\nËøòÊúâ ${incompleteMatches.length} Âú∫ÊØîËµõÊú™ËÆ∞ÂΩïÊØîÂàÜÔºåÊéíÂêçÂèØËÉΩ‰ºöÂèëÁîüÂèòÂåñ„ÄÇ`,
                    'üìä ‰∏¥Êó∂ÊéíÂêç',
                    'info'
                );
            }

            calculateAndDisplayResults(incompleteMatches.length > 0);
            document.getElementById('finalRanking').style.display = 'block';
            
            window.lastActionType = 'show_ranking';
            if (saveToSync) saveToSync();
        }

        // ÈöêËóèÊéíÂêç
        function hideFinalRanking() {
            document.getElementById('finalRanking').style.display = 'none';
            window.lastActionType = 'hide_ranking';
            if (saveToSync) saveToSync();
        }

        // ËÆ°ÁÆóÊéíÂêç
        function calculateAndDisplayResults(isTemporary = false) {
            const activePlayers = getActivePlayers();
            const playerStats = {};
            
            activePlayers.forEach(player => {
                playerStats[player.name] = {
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    totalOpponentScore: 0
                };
            });

            // ÁªüËÆ°Â∑≤ÂÆåÊàêÊØîËµõÁöÑÊï∞Èáè
            let completedMatches = 0;
            matchSchedule.forEach(match => {
                    if (match.score1 > 0 || match.score2 > 0) {
                        completedMatches++;
                        match.team1.forEach(player => {
                        if (playerStats[player]) {
                            playerStats[player].totalScore += match.score1;
                            playerStats[player].totalOpponentScore += match.score2;
                            if (match.score1 > match.score2) {
                                playerStats[player].wins += 1;
                            } else if (match.score1 < match.score2) {
                                playerStats[player].losses += 1;
                            }
                            }
                        });

                        match.team2.forEach(player => {
                        if (playerStats[player]) {
                            playerStats[player].totalScore += match.score2;
                            playerStats[player].totalOpponentScore += match.score1;
                            if (match.score2 > match.score1) {
                                playerStats[player].wins += 1;
                            } else if (match.score2 < match.score1) {
                                playerStats[player].losses += 1;
                            }
                            }
                        });
                    }
            });

            const sortedPlayers = Object.entries(playerStats).sort((a, b) => {
                if (b[1].wins !== a[1].wins) return b[1].wins - a[1].wins;
                return (b[1].totalScore - b[1].totalOpponentScore) - (a[1].totalScore - a[1].totalOpponentScore);
            });

            const resultsGrid = document.getElementById('resultsGrid');
            
            // Ê†πÊçÆÊòØÂê¶‰∏∫‰∏¥Êó∂ÊéíÂêçÊòæÁ§∫‰∏çÂêåÁöÑÊ†áÈ¢ò
            const headerTitle = isTemporary ? 
                `<div style="text-align: center; margin-bottom: 10px; color: #f39c12; font-weight: bold;">
                    üìä ‰∏¥Êó∂ÊéíÂêç (Âü∫‰∫éÂ∑≤ÂÆåÊàêÁöÑ ${completedMatches}/${matchSchedule.length} Âú∫ÊØîËµõ)
                </div>` : '';
            
            resultsGrid.innerHTML = headerTitle + `
                <div class="result-row header">
                    <div class="rank-cell">ÊéíÂêç</div>
                    <div class="name-cell">ÂßìÂêç</div>
                    <div class="score-cell">ËÉúÂú∫</div>
                    <div class="score-cell">Ë¥üÂú∫</div>
                    <div class="score-cell">ÂáÄËÉúÂàÜ</div>
                </div>
            `;

            sortedPlayers.forEach(([player, stats], index) => {
                const row = document.createElement('div');
                row.className = `result-row ${index === 0 ? 'winner' : ''}`;
                
                const netScore = stats.totalScore - stats.totalOpponentScore;
                const netScoreClass = netScore > 0 ? 'net-score-positive' : 
                                   netScore < 0 ? 'net-score-negative' : 'net-score-zero';
                
                row.innerHTML = `
                    <div class="rank-cell">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : index + 1}</div>
                    <div class="name-cell">${player}</div>
                    <div class="score-cell">${stats.wins}</div>
                    <div class="score-cell">${stats.losses}</div>
                    <div class="score-cell ${netScoreClass}">${netScore > 0 ? '+' : ''}${netScore}</div>
                `;
                resultsGrid.appendChild(row);
            });
        }

        // ÂºπÊ°ÜÂáΩÊï∞
        function showDialog(options) {
            const dialog = document.getElementById('customDialog');
            const icon = document.getElementById('dialogIcon');
            const iconText = document.getElementById('dialogIconText');
            const title = document.getElementById('dialogTitle');
            const message = document.getElementById('dialogMessage');
            const buttons = document.getElementById('dialogButtons');

            const iconMap = {
                info: { text: '‚ÑπÔ∏è', class: 'info' },
                warning: { text: '‚ö†Ô∏è', class: 'warning' },
                success: { text: '‚úÖ', class: 'success' },
                error: { text: '‚ùå', class: 'error' },
                question: { text: '‚ùì', class: 'info' }
            };

            const iconConfig = iconMap[options.type] || iconMap.info;
            iconText.textContent = iconConfig.text;
            icon.className = `dialog-icon ${iconConfig.class}`;

            title.textContent = options.title || 'ÊèêÁ§∫';
            message.textContent = options.message || '';

            buttons.innerHTML = '';
            if (options.buttons && options.buttons.length > 0) {
                options.buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = `dialog-btn ${btn.class || 'dialog-btn-secondary'}`;
                    button.textContent = btn.text;
                    button.onclick = () => {
                        closeDialog();
                        if (btn.onClick) btn.onClick();
                    };
                    buttons.appendChild(button);
                });
            } else {
                const okButton = document.createElement('button');
                okButton.className = 'dialog-btn dialog-btn-primary';
                okButton.textContent = 'Á°ÆÂÆö';
                okButton.onclick = () => {
                    closeDialog();
                    if (options.onOk) options.onOk();
                };
                buttons.appendChild(okButton);
            }

            dialog.classList.add('active');
        }

        function closeDialog() {
            document.getElementById('customDialog').classList.remove('active');
        }

        function showAlert(message, title = 'ÊèêÁ§∫', type = 'info', onOk = null) {
            showDialog({
                type: type,
                title: title,
                message: message,
                onOk: onOk
            });
        }

        function showConfirm(message, title = 'Á°ÆËÆ§', onConfirm = null, onCancel = null) {
            showDialog({
                type: 'question',
                title: title,
                message: message,
                buttons: [
                    {
                        text: 'ÂèñÊ∂à',
                        class: 'dialog-btn-secondary',
                        onClick: onCancel
                    },
                    {
                        text: 'Á°ÆÂÆö',
                        class: 'dialog-btn-primary',
                        onClick: onConfirm
                    }
                ]
            });
        }

        // LoadingÂáΩÊï∞
        function showLoading(text = 'Ê≠£Âú®ËøûÊé•‰∫ëÁ´Ø...', subtitle = 'Ê≠£Âú®‰ªéLeanCloud‰∫ëÁ´ØÂä†ËΩΩÊúÄÊñ∞Êï∞ÊçÆ') {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = overlay.querySelector('.loading-text');
            const subtitleEl = overlay.querySelector('.loading-subtitle');
            
            textEl.textContent = text;
            subtitleEl.innerHTML = subtitle;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ÂêåÊ≠•ÈÄöÁü•
        function showSyncNotification(message, type = 'success') {
            let notification = document.getElementById('syncNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'syncNotification';
                notification.className = 'sync-notification';
                document.body.appendChild(notification);
            }
            
            // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆ‰∏çÂêåÁöÑËÉåÊôØÈ¢úËâ≤
            if (type === 'warning' || message.includes('Â§±Ë¥•') || message.includes('ÊºîÁ§∫Ê®°Âºè')) {
                notification.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
            } else {
                notification.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
            }
            
            notification.textContent = message;
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(-50%) translateY(0)';
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-20px)';
            }, 4000); // Âª∂ÈïøÂà∞4ÁßíÔºåËÆ©Áî®Êà∑ÊúâË∂≥Â§üÊó∂Èó¥ÁúãÂà∞
        }


        // Èò≤Ê≠¢‰∏ãÊãâÂà∑Êñ∞
        function preventPullToRefresh() {
            let startY = 0;
            
            document.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
            }, { passive: false });
            
            document.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                
                if (window.scrollY === 0 && deltaY > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.body.style.overscrollBehavior = 'none';
            document.documentElement.style.overscrollBehavior = 'none';
        }

        // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
        function debugLog(message) {
            console.log(`üè∏ [Debug] ${message}`);
        }

        // Ê£ÄÊü•ÂøÖË¶ÅÁöÑÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
        function checkRequiredElements() {
            const requiredIds = ['playersNames', 'matchesPreview', 'loadingOverlay'];
            const missing = [];
            
            requiredIds.forEach(id => {
                if (!document.getElementById(id)) {
                    missing.push(id);
                }
            });
            
            if (missing.length > 0) {
                console.error('Áº∫Â∞ëÂøÖË¶ÅÂÖÉÁ¥†:', missing);
                return false;
            }
            return true;
        }

        // ÁâàÊú¨Ê£ÄÊü•ÂíåÁºìÂ≠òÁ†¥Âùè
        function checkVersionAndCache() {
            const currentVersion = '1.3.1';
            const lastVersion = localStorage.getItem('app_version');
            const lastCheck = localStorage.getItem('last_version_check');
            const now = Date.now();
            
            // ÊòæÁ§∫ÂΩìÂâçÁâàÊú¨‰ø°ÊÅØ
            console.log(`üè∏ ÂΩìÂâçÁâàÊú¨: ${currentVersion}`);
            
            // Â¶ÇÊûúÁâàÊú¨‰∏çÂåπÈÖçÊàñËÄÖË∂ÖËøá1Â∞èÊó∂Ê≤°Ê£ÄÊü•ÔºåÂº∫Âà∂Âà∑Êñ∞ÁºìÂ≠ò
            if (lastVersion !== currentVersion || !lastCheck || (now - parseInt(lastCheck)) > 3600000) {
                console.log('üîÑ Ê£ÄÊµãÂà∞ÁâàÊú¨Êõ¥Êñ∞ÊàñÁºìÂ≠òËøáÊúüÔºåÊ∏ÖÁêÜÁºìÂ≠ò...');
                
                // Ê∏ÖÁêÜÊâÄÊúâÁõ∏ÂÖ≥ÁºìÂ≠ò
                localStorage.removeItem('app_version');
                localStorage.removeItem('last_version_check');
                
                // Ê∏ÖÁêÜ Service Worker ÁºìÂ≠òÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        registrations.forEach(registration => {
                            registration.unregister();
                        });
                    });
                }
                
                // Ê∏ÖÁêÜÊµèËßàÂô®ÁºìÂ≠ò
                if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                    });
                }
                
                // Êõ¥Êñ∞ÁâàÊú¨‰ø°ÊÅØ
                localStorage.setItem('app_version', currentVersion);
                localStorage.setItem('last_version_check', now.toString());
                
                // Â¶ÇÊûúÊòØÁâàÊú¨Êõ¥Êñ∞ÔºåÊòæÁ§∫ÊèêÁ§∫Âπ∂Âª∫ËÆÆÂà∑Êñ∞
                if (lastVersion && lastVersion !== currentVersion) {
                    showSyncNotification(`üéâ Á≥ªÁªüÂ∑≤Êõ¥Êñ∞Âà∞ v${currentVersion}ÔºÅ‰∏∫Ëé∑ÂæóÊúÄ‰Ω≥‰ΩìÈ™åÔºåÂª∫ËÆÆÂà∑Êñ∞È°µÈù¢`);
                    
                    // 3ÁßíÂêéËá™Âä®Âà∑Êñ∞
                    setTimeout(() => {
                        if (confirm('Ê£ÄÊµãÂà∞Á≥ªÁªüÊõ¥Êñ∞ÔºåÊòØÂê¶Á´ãÂç≥Âà∑Êñ∞È°µÈù¢Ëé∑ÂèñÊúÄÊñ∞ÂäüËÉΩÔºü')) {
                            location.reload(true); // Âº∫Âà∂‰ªéÊúçÂä°Âô®ÈáçÊñ∞Âä†ËΩΩ
                        }
                    }, 3000);
                }
            } else {
                localStorage.setItem('last_version_check', now.toString());
            }
        }

        // ÂÆâÂÖ®ÁöÑÂàùÂßãÂåñÂáΩÊï∞
        function safeInit() {
            try {
                debugLog('ÂºÄÂßãÂàùÂßãÂåñÈ°µÈù¢');
                
                // È¶ñÂÖàÊ£ÄÊü•ÁâàÊú¨ÂíåÁºìÂ≠ò
                checkVersionAndCache();
                
                // Ê£ÄÊü•ÂøÖË¶ÅÂÖÉÁ¥†
                if (!checkRequiredElements()) {
                    console.error('È°µÈù¢ÂÖÉÁ¥†Ê£ÄÊü•Â§±Ë¥•');
                    return;
                }
                
                debugLog('ÂàùÂßãÂåñ‰∫ëÁ´ØÂêåÊ≠•');
                // ÂÖàÂàùÂßãÂåñ‰∫ëÁ´ØËøûÊé•ÔºåËøôÊ†∑ÂèØ‰ª•‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ
                saveToSync = initSimpleJsonSync();
                
                debugLog('Âä†ËΩΩÁé©ÂÆ∂ÈÖçÁΩÆ');
                loadPlayerConfigFromCloud();
                
                debugLog('Êõ¥Êñ∞Áé©ÂÆ∂ÊòæÁ§∫');
                updatePlayersDisplay();
                
                // Ê≥®ÊÑèÔºöÊØîËµõÊï∞ÊçÆÁöÑÁîüÊàê/Âä†ËΩΩÁé∞Âú®Âú® initSimpleJsonSync() ÁöÑ init() ÂáΩÊï∞‰∏≠Â§ÑÁêÜ
                // Â¶ÇÊûú‰∫ëÁ´ØËøûÊé•ÊàêÂäüÔºå‰ºö‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ
                // Â¶ÇÊûú‰∫ëÁ´ØËøûÊé•Â§±Ë¥•Ôºå‰ºöÂú®ÊºîÁ§∫Ê®°Âºè‰∏≠ÁîüÊàêÊñ∞Êï∞ÊçÆ
                
                debugLog('ËÆæÁΩÆÈò≤Âà∑Êñ∞');
                preventPullToRefresh();
                
                debugLog('ÂàùÂßãÂåñÂÆåÊàê');
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØÁªôÁî®Êà∑
                const container = document.getElementById('matchesPreview');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #f8d7da; border-radius: 10px; color: #721c24; margin: 20px 0;">
                            <h3>‚ö†Ô∏è ÂàùÂßãÂåñÂ§±Ë¥•</h3>
                            <p>È°µÈù¢Âä†ËΩΩÂá∫Áé∞ÈóÆÈ¢òÔºåËØ∑Âà∑Êñ∞ÈáçËØï</p>
                            <p style="font-size: 0.8rem; margin-top: 10px;">ÈîôËØØ‰ø°ÊÅØ: ${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Âà∑Êñ∞È°µÈù¢
                            </button>
                        </div>
                    `;
                }
            }
        }

        // ÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®
        class PartnershipManager {
            constructor(playerCount) {
                this.playerCount = playerCount;
                this.maxCount = playerCount === 5 ? 3 : 2; // 5‰∫∫Ê®°Âºè3Ê¨°Ôºå6‰∫∫Ê®°Âºè2Ê¨°
                this.targetCount = playerCount === 5 ? 3 : 2; // 5‰∫∫Ê®°ÂºèÁêÜËÆ∫3Ê¨°Ôºå6‰∫∫Ê®°ÂºèÁêÜËÆ∫2Ê¨°
                this.minCount = playerCount === 5 ? 2 : 1; // 5‰∫∫Ê®°ÂºèÊúÄÂ∞ë2Ê¨°Ôºå6‰∫∫Ê®°ÂºèÊúÄÂ∞ë1Ê¨°
                this.partnerships = {};
                this.reset();
            }
            
            reset() {
                this.partnerships = {};
                for (let i = 0; i < this.playerCount; i++) {
                    for (let j = i + 1; j < this.playerCount; j++) {
                        this.partnerships[`${i}-${j}`] = 0;
                    }
                }
                console.log(`ü§ù Êê≠ÈÖçÁÆ°ÁêÜÂô®ÈáçÁΩÆ (${this.playerCount}‰∫∫Ê®°ÂºèÔºåÊØèÂØπÊúÄÂ§ö${this.maxCount}Ê¨°)`);
            }
            
            getPartnershipKey(player1, player2) {
                return `${Math.min(player1, player2)}-${Math.max(player1, player2)}`;
            }
            
            getCount(player1, player2) {
                const key = this.getPartnershipKey(player1, player2);
                return this.partnerships[key] || 0;
            }
            
            canPartner(player1, player2) {
                const count = this.getCount(player1, player2);
                return count < this.maxCount;
            }
            
            addPartnership(player1, player2) {
                const key = this.getPartnershipKey(player1, player2);
                this.partnerships[key] = (this.partnerships[key] || 0) + 1;
                const newCount = this.partnerships[key];
                
                if (newCount > this.maxCount) {
                    console.error(`‚ùå Êê≠ÈÖçË∂ÖÊ†á: Áé©ÂÆ∂${player1+1} + Áé©ÂÆ∂${player2+1} = ${newCount}Ê¨° (ÊúÄÂ§ö${this.maxCount}Ê¨°)`);
                }
                
                return newCount;
            }
            
            canFormTeam(team1, team2) {
                // Ê£ÄÊü•‰∏§‰∏™Èòü‰ºçÁöÑÊê≠ÈÖçÊòØÂê¶ÈÉΩÂú®ÈôêÂà∂ÂÜÖ
                return this.canPartner(team1[0], team1[1]) && this.canPartner(team2[0], team2[1]);
            }
            
            addTeams(team1, team2) {
                this.addPartnership(team1[0], team1[1]);
                this.addPartnership(team2[0], team2[1]);
            }
            
            getPartnershipScore(player1, player2) {
                const count = this.getCount(player1, player2);
                const remaining = this.maxCount - count;
                const deficit = this.targetCount - count; // ‰∏éÁõÆÊ†áÁöÑÂ∑ÆË∑ù
                
                // ËÆ°ÁÆó‰ºòÂÖàÁ∫ßÂàÜÊï∞ - Âº∫ÁÉàÂÄæÂêë‰∫éËææÂà∞ÁõÆÊ†áÊê≠ÈÖçÊ¨°Êï∞
                let score = remaining * 2000; // Âü∫Á°ÄÂàÜÊï∞
                
                if (count === 0) {
                    score += 20000; // ÊûÅÂ§ßÊèêÂçá‰ªéÊú™Êê≠ÈÖçËøáÁöÑÊùÉÈáç
                } else if (count < this.targetCount) {
                    // ‰Ωé‰∫éÁõÆÊ†áÊ¨°Êï∞ÔºåÁªô‰∫àÂ•ñÂä±ÔºåÂ∑ÆË∑ùË∂äÂ§ßÂ•ñÂä±Ë∂äÂ§ö
                    score += deficit * 8000;
                } else if (count === this.targetCount) {
                    score += 1000; // Â∑≤ËææÂà∞ÁõÆÊ†áÔºåÂ∞èÂπÖÂ•ñÂä±
                } else if (count < this.maxCount) {
                    score -= (count - this.targetCount) * 3000; // Ë∂ÖËøáÁõÆÊ†á‰ΩÜÊú™Ëææ‰∏äÈôêÔºåÁªô‰∫àÊÉ©ÁΩö
                } else {
                    score -= 50000; // ‰∏•ÈáçÊÉ©ÁΩöË∂ÖÊ†áÊê≠ÈÖç
                }
                
                return score;
            }
            
            // Ëé∑ÂèñÊê≠ÈÖçÂàÜÂ∏ÉÁöÑÂùáË°°ÊÄßËØÑÂàÜ
            getBalanceScore() {
                const counts = Object.values(this.partnerships);
                const nonZeroCounts = counts.filter(c => c > 0);
                
                if (nonZeroCounts.length === 0) return 0;
                
                const min = Math.min(...nonZeroCounts);
                const max = Math.max(...nonZeroCounts);
                const avg = nonZeroCounts.reduce((a, b) => a + b, 0) / nonZeroCounts.length;
                
                // ËÆ°ÁÆóÊ†áÂáÜÂ∑Æ
                const variance = nonZeroCounts.reduce((acc, val) => acc + Math.pow(val - avg, 2), 0) / nonZeroCounts.length;
                const stdDev = Math.sqrt(variance);
                
                // ÂùáË°°ÊÄßÂàÜÊï∞ÔºöË∂äÂ∞èË∂äÂ•ΩÔºàÊ†áÂáÜÂ∑ÆË∂äÂ∞èÔºåÂàÜÂ∏ÉË∂äÂùáÂåÄÔºâ
                return { min, max, avg, stdDev, balance: max - min };
            }
            
            // Ëé∑ÂèñÊúÄÂ∞ëÊê≠ÈÖçÊ¨°Êï∞ÁöÑÊâÄÊúâÁªÑÂêà
            getLeastUsedPairs() {
                const minCount = Math.min(...Object.values(this.partnerships));
                const leastUsed = [];
                
                Object.entries(this.partnerships).forEach(([key, count]) => {
                    if (count === minCount) {
                        const [id1, id2] = key.split('-').map(Number);
                        leastUsed.push([id1, id2]);
                    }
                });
                
                return leastUsed;
            }
            
            // Ëé∑Âèñ‰Ωé‰∫éÁõÆÊ†áÊê≠ÈÖçÊ¨°Êï∞ÁöÑÊâÄÊúâÁªÑÂêà
            getUnderTargetPairs() {
                const underTarget = [];
                
                Object.entries(this.partnerships).forEach(([key, count]) => {
                    if (count < this.targetCount) {
                        const [id1, id2] = key.split('-').map(Number);
                        underTarget.push([id1, id2]);
                    }
                });
                
                return underTarget;
            }
            
            // Ê£ÄÊü•Êüê‰∏™Êê≠ÈÖçÁªÑÂêàÊòØÂê¶ÂåÖÂê´ÊúÄÂ∞ë‰ΩøÁî®ÁöÑÈÖçÂØπ
            containsLeastUsedPair(team1, team2) {
                const leastUsed = this.getLeastUsedPairs();
                
                for (const [id1, id2] of leastUsed) {
                    // Ê£ÄÊü•team1ÊòØÂê¶ÂåπÈÖç
                    if ((team1[0] === id1 && team1[1] === id2) || (team1[0] === id2 && team1[1] === id1)) {
                        return true;
                    }
                    // Ê£ÄÊü•team2ÊòØÂê¶ÂåπÈÖç
                    if ((team2[0] === id1 && team2[1] === id2) || (team2[0] === id2 && team2[1] === id1)) {
                        return true;
                    }
                }
                
                return false;
            }
            
            // Ê£ÄÊü•Êüê‰∏™Êê≠ÈÖçÁªÑÂêàÊòØÂê¶ÂåÖÂê´‰Ωé‰∫éÁõÆÊ†áÁöÑÈÖçÂØπ
            containsUnderTargetPair(team1, team2) {
                const underTarget = this.getUnderTargetPairs();
                
                for (const [id1, id2] of underTarget) {
                    // Ê£ÄÊü•team1ÊòØÂê¶ÂåπÈÖç
                    if ((team1[0] === id1 && team1[1] === id2) || (team1[0] === id2 && team1[1] === id1)) {
                        return true;
                    }
                    // Ê£ÄÊü•team2ÊòØÂê¶ÂåπÈÖç
                    if ((team2[0] === id1 && team2[1] === id2) || (team2[0] === id2 && team2[1] === id1)) {
                        return true;
                    }
                }
                
                return false;
            }

            printStats() {
                console.log('ü§ù ÂΩìÂâçÊê≠ÈÖçÁªüËÆ°Ôºö');
                Object.entries(this.partnerships).forEach(([key, count]) => {
                    const [id1, id2] = key.split('-').map(Number);
                    let status = '';
                    if (count === 0) {
                        status = ' ‚ùåÊú™Êê≠ÈÖç';
                    } else if (count < this.targetCount) {
                        status = ' ‚ö†Ô∏è‰∏çË∂≥';
                    } else if (count === this.targetCount) {
                        status = ' ‚úÖÁêÜÊÉ≥';
                    } else if (count <= this.maxCount) {
                        status = ' üî∏ÂÅèÂ§ö';
                    } else {
                        status = ' ‚ùåË∂ÖÊ†á';
                    }
                    
                    console.log(`  Áé©ÂÆ∂${id1+1} + Áé©ÂÆ∂${id2+1}: ${count}Ê¨°${status}`);
                });
                
                const balance = this.getBalanceScore();
                console.log(`üìä ÂùáË°°ÊÄß: ÊúÄÂ∞ë${balance.min}Ê¨°, ÊúÄÂ§ö${balance.max}Ê¨°, Âπ≥Âùá${balance.avg.toFixed(1)}Ê¨°, Â∑ÆË∑ù${balance.balance}Ê¨°`);
                console.log(`üéØ ÁõÆÊ†á: ÊØèÂØπÊê≠ÈÖç${this.targetCount}Ê¨°, ÊúÄÂ§ö${this.maxCount}Ê¨°`);
            }
        }
        
        // ÂÖ®Â±ÄÊê≠ÈÖçÁÆ°ÁêÜÂô®ÂÆû‰æã
        let globalPartnershipManager = null;

        // ===========================================
        // ÂÖ®Êñ∞ÁöÑÁÆÄÂçïÂàÜÈÖçÁÆóÊ≥ï
        // ===========================================

        // 6‰∫∫Ê®°ÂºèÔºöÊØè‰∫∫10Âú∫ÔºåÊØèÂØπÊê≠ÈÖçÊÅ∞Â•Ω2Ê¨°
        function generateSimple6PlayerSchedule(players) {
            console.log('üéØ Êñ∞ÁÆóÊ≥ïÔºö6‰∫∫Ê®°Âºè - ÊØè‰∫∫10Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2Ê¨°');
            
            // 6‰∫∫15Âú∫ÁöÑÊï∞Â≠¶È™åËØÅÔºö
            // - ÊÄªÂÖ±15Âú∫ÊØîËµõÔºåÊØèÂú∫4‰∫∫ÔºåÂÖ±60‰∫∫Ê¨°
            // - 6‰∫∫Âπ≥ÂùáÔºö60√∑6=10Âú∫/‰∫∫ ‚úì
            // - ÊÄªÂÖ±15ÁßçÊê≠ÈÖçÂÖ≥Á≥ªÔºàC(6,2)=15Ôºâ
            // - ÊØèÂú∫‰∫ßÁîü2‰∏™Êê≠ÈÖçÔºåÂÖ±30‰∏™Êê≠ÈÖçÂÆû‰æã
            // - Âπ≥ÂùáÊØèÂØπÔºö30√∑15=2Ê¨°Êê≠ÈÖç ‚úì
            
            const matchTemplates = generate6PlayerOptimalMatches();
            
            // Â∞ÜÊï∞Â≠óÊ®°ÊùøËΩ¨Êç¢‰∏∫Áé©ÂÆ∂ÂêçÂ≠ó
            const matches = matchTemplates.map((template, index) => ({
                team1: [players[template.team1[0]], players[template.team1[1]]],
                team2: [players[template.team2[0]], players[template.team2[1]]],
                score1: 0,
                score2: 0,
                matchIndex: index
            }));
            
            console.log(`‚úÖ 6‰∫∫ÂÆåÁæéÂÆâÊéíÁîüÊàêÂÆåÊàêÔºö${matches.length}Âú∫ÊØîËµõ`);
            return matches;
        }

        // 5‰∫∫Ê®°ÂºèÔºöÊØè‰∫∫12Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2-3Ê¨°
        function generateSimple5PlayerSchedule(players) {
            console.log('üéØ Êñ∞ÁÆóÊ≥ïÔºö5‰∫∫Ê®°Âºè - ÊØè‰∫∫12Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2-3Ê¨°');
            
            // 5‰∫∫15Âú∫ÁöÑÊï∞Â≠¶È™åËØÅÔºö
            // - ÊÄªÂÖ±15Âú∫ÊØîËµõÔºåÊØèÂú∫4‰∫∫ÔºåÂÖ±60‰∫∫Ê¨°
            // - 5‰∫∫Âπ≥ÂùáÔºö60√∑5=12Âú∫/‰∫∫ ‚úì
            // - ÊÄªÂÖ±10ÁßçÊê≠ÈÖçÂÖ≥Á≥ªÔºàC(5,2)=10Ôºâ
            // - ÊØèÂú∫‰∫ßÁîü2‰∏™Êê≠ÈÖçÔºåÂÖ±30‰∏™Êê≠ÈÖçÂÆû‰æã
            // - Âπ≥ÂùáÊØèÂØπÔºö30√∑10=3Ê¨°Êê≠ÈÖçÔºåÂÆûÈôÖ‰ºöÊòØ2-3Ê¨° ‚úì
            
            const schedule = generate5PlayerOptimalMatches();
            return convertScheduleToMatches(schedule, players);
        }

        // ÁîüÊàê6‰∫∫ÊúÄ‰ºòÊØîËµõÂÆâÊéí - ‰ΩøÁî®ÁÆóÊ≥ïÁîüÊàêÁ°Æ‰øùÊï∞Â≠¶Ê≠£Á°Æ
        function generate6PlayerOptimalMatches() {
            console.log('üìä 6‰∫∫Ê®°ÂºèÁÆóÊ≥ïÊûÑÈÄ†ÂºÄÂßã...');
            
            // ‰ΩøÁî®Á≥ªÁªüÂåñÁÆóÊ≥ïÁîüÊàêÁ°Æ‰øùÊØè‰∫∫10Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2Ê¨°ÁöÑÂÆâÊéí
            const matches = [];
            const playerCounts = Array(6).fill(0);
            const partnerships = {};
            
            // ÂàùÂßãÂåñÊê≠ÈÖçËÆ°Êï∞Âô®
            for (let i = 0; i < 6; i++) {
                for (let j = i + 1; j < 6; j++) {
                    partnerships[`${i}-${j}`] = 0;
                }
            }
            
            // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑÊØîËµõÁªÑÂêàÔºà15Áßç4‰∫∫ÁªÑÂêàÔºâ
            const allMatches = [];
            for (let i = 0; i < 6; i++) {
                for (let j = i + 1; j < 6; j++) {
                    for (let k = j + 1; k < 6; k++) {
                        for (let l = k + 1; l < 6; l++) {
                            // 4‰∫∫ÁªÑÂêà[i,j,k,l]ÁöÑ3ÁßçÂàÜÈòüÊñπÂºè
                            allMatches.push({ team1: [i,j], team2: [k,l], players: [i,j,k,l] });
                            allMatches.push({ team1: [i,k], team2: [j,l], players: [i,j,k,l] });
                            allMatches.push({ team1: [i,l], team2: [j,k], players: [i,j,k,l] });
                        }
                    }
                }
            }
            
            console.log(`ÊÄªÂÖ±Êúâ${allMatches.length}ÁßçÂèØËÉΩÁöÑÊØîËµõÂÆâÊéí`);
            
            // ‰ΩøÁî®Ë¥™ÂøÉÁÆóÊ≥ïÈÄâÊã©15Âú∫ÊØîËµõÔºåÁ°Æ‰øùÊØè‰∫∫10Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2Ê¨°
            for (let round = 0; round < 15; round++) {
                let bestMatch = null;
                let bestScore = -Infinity;
                
                for (const match of allMatches) {
                    // Ê£ÄÊü•ËøôÂú∫ÊØîËµõÊòØÂê¶‰ºöËÆ©‰ªª‰Ωï‰∫∫Ë∂ÖËøá10Âú∫
                    const wouldExceed = match.players.some(p => playerCounts[p] >= 10);
                    if (wouldExceed) continue;
                    
                    // Ê£ÄÊü•Êê≠ÈÖçÊòØÂê¶‰ºöË∂ÖËøá2Ê¨°
                    const team1Key = `${Math.min(match.team1[0], match.team1[1])}-${Math.max(match.team1[0], match.team1[1])}`;
                    const team2Key = `${Math.min(match.team2[0], match.team2[1])}-${Math.max(match.team2[0], match.team2[1])}`;
                    
                    if (partnerships[team1Key] >= 2 || partnerships[team2Key] >= 2) continue;
                    
                    // ËÆ°ÁÆóËøôÂú∫ÊØîËµõÁöÑ‰ºòÂÖàÁ∫ßÂàÜÊï∞
                    let score = 0;
                    
                    // ‰ºòÂÖàÈÄâÊã©ËÆ©ÂèÇËµõÊ¨°Êï∞Â∞ëÁöÑ‰∫∫ÂèÇËµõ
                    match.players.forEach(p => {
                        score += (10 - playerCounts[p]) * 100;
                    });
                    
                    // ‰ºòÂÖàÈÄâÊã©Êê≠ÈÖçÊ¨°Êï∞Â∞ëÁöÑÁªÑÂêà
                    score += (2 - partnerships[team1Key]) * 1000;
                    score += (2 - partnerships[team2Key]) * 1000;
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = match;
                    }
                }
                
                if (!bestMatch) {
                    throw new Error(`Á¨¨${round + 1}Âú∫ÊØîËµõÊó†Ê≥ïÂÆâÊéí`);
                }
                
                // Ê∑ªÂä†ËøôÂú∫ÊØîËµõ
                matches.push(bestMatch);
                
                // Êõ¥Êñ∞ËÆ°Êï∞Âô®
                bestMatch.players.forEach(p => playerCounts[p]++);
                const team1Key = `${Math.min(bestMatch.team1[0], bestMatch.team1[1])}-${Math.max(bestMatch.team1[0], bestMatch.team1[1])}`;
                const team2Key = `${Math.min(bestMatch.team2[0], bestMatch.team2[1])}-${Math.max(bestMatch.team2[0], bestMatch.team2[1])}`;
                partnerships[team1Key]++;
                partnerships[team2Key]++;
                
                console.log(`Á¨¨${round + 1}Âú∫: [${bestMatch.team1.join(',')}] vs [${bestMatch.team2.join(',')}], ÂΩìÂâçÂú∫Ê¨°: [${playerCounts.join(',')}]`);
            }
            
            // È™åËØÅËøô‰∏™ÂÆâÊéí
            if (!validatePerfect6PlayerMatches(matches)) {
                throw new Error('6‰∫∫ÁÆóÊ≥ïÁîüÊàêÈ™åËØÅÂ§±Ë¥•');
            }
            
            console.log('‚úÖ 6‰∫∫ÁÆóÊ≥ïÁîüÊàêÈ™åËØÅÈÄöËøá');
            return matches;
        }
        
        // È™åËØÅ6‰∫∫ÂÆåÁæéÂÆâÊéí
        function validatePerfect6PlayerMatches(matches) {
            console.log('üîç È™åËØÅ6‰∫∫ÂÆåÁæéÂÆâÊéí...');
            
            // ÁªüËÆ°ÊØè‰∫∫ÂèÇ‰∏éÊ¨°Êï∞
            const playerCounts = Array(6).fill(0);
            // ÁªüËÆ°ÊØèÂØπÊê≠ÈÖçÊ¨°Êï∞
            const partnerships = {};
            for (let i = 0; i < 6; i++) {
                for (let j = i + 1; j < 6; j++) {
                    partnerships[`${i}-${j}`] = 0;
                }
            }
            
            matches.forEach(match => {
                // ÁªüËÆ°ÂèÇ‰∏éÊ¨°Êï∞
                match.team1.forEach(p => playerCounts[p]++);
                match.team2.forEach(p => playerCounts[p]++);
                
                // ÁªüËÆ°Êê≠ÈÖçÊ¨°Êï∞
                const key1 = `${Math.min(match.team1[0], match.team1[1])}-${Math.max(match.team1[0], match.team1[1])}`;
                const key2 = `${Math.min(match.team2[0], match.team2[1])}-${Math.max(match.team2[0], match.team2[1])}`;
                partnerships[key1]++;
                partnerships[key2]++;
            });
            
            // Ê£ÄÊü•ÊØè‰∫∫ÊòØÂê¶ÈÉΩÊòØ10Âú∫
            const allTen = playerCounts.every(count => count === 10);
            if (!allTen) {
                console.error(`‚ùå Âú∫Ê¨°ÂàÜÈÖçÈîôËØØÔºö[${playerCounts.join(',')}]ÔºåÂ∫îËØ•ÊØè‰∫∫10Âú∫`);
                return false;
            }
            
            // Ê£ÄÊü•ÊØèÂØπÊòØÂê¶ÈÉΩÊòØ2Ê¨°Êê≠ÈÖç
            const allTwo = Object.values(partnerships).every(count => count === 2);
            if (!allTwo) {
                console.error('‚ùå Êê≠ÈÖçÂàÜÈÖçÈîôËØØÔºö');
                Object.entries(partnerships).forEach(([key, count]) => {
                    if (count !== 2) {
                        console.error(`  ${key}: ${count}Ê¨°ÔºåÂ∫îËØ•2Ê¨°`);
                    }
                });
                return false;
            }
            
            console.log('‚úÖ È™åËØÅÈÄöËøáÔºöÊØè‰∫∫10Âú∫ÔºåÊØèÂØπÊê≠ÈÖç2Ê¨°');
            return true;
        }

        // ÁîüÊàê5‰∫∫ÊúÄ‰ºòÊØîËµõÂÆâÊéí
        function generate5PlayerOptimalMatches() {
            console.log('üìä 5‰∫∫Ê®°ÂºèÊï∞Â≠¶ÊûÑÈÄ†ÂºÄÂßã...');
            
            // 5‰∫∫ËΩÆËΩ¨‰ºëÊÅØÔºå15Âú∫ÊØîËµõÁöÑÊúÄ‰ºòÂÆâÊéí
            // ÊØè‰∫∫‰ºëÊÅØ3Âú∫ÔºåÂèÇ‰∏é12Âú∫
            const schedule = [
                // Áé©ÂÆ∂0‰ºëÊÅØÁöÑ3Âú∫
                [1,2,3,4], [1,3,2,4], [1,4,2,3],
                // Áé©ÂÆ∂1‰ºëÊÅØÁöÑ3Âú∫  
                [0,2,3,4], [0,3,2,4], [0,4,2,3],
                // Áé©ÂÆ∂2‰ºëÊÅØÁöÑ3Âú∫
                [0,1,3,4], [0,3,1,4], [0,4,1,3],
                // Áé©ÂÆ∂3‰ºëÊÅØÁöÑ3Âú∫
                [0,1,2,4], [0,2,1,4], [0,4,1,2],
                // Áé©ÂÆ∂4‰ºëÊÅØÁöÑ3Âú∫
                [0,1,2,3], [0,2,1,3], [0,3,1,2]
            ];
            
            // È™åËØÅËøô‰∏™ÂÆâÊéí
            if (!validate5PlayerSchedule(schedule)) {
                throw new Error('5‰∫∫Êï∞Â≠¶ÊûÑÈÄ†È™åËØÅÂ§±Ë¥•');
            }
            
            console.log('‚úÖ 5‰∫∫ÂÆâÊéíÈ™åËØÅÈÄöËøá');
            return schedule;
        }


        // È™åËØÅ5‰∫∫ÂÆâÊéíÁöÑÊ≠£Á°ÆÊÄß
        function validate5PlayerSchedule(schedule) {
            console.log('üîç È™åËØÅ5‰∫∫ÂÆâÊéí...');
            
            // Ê£ÄÊü•ÊÄªÂú∫Ê¨°
            if (schedule.length !== 15) {
                console.error(`‚ùå ÊÄªÂú∫Ê¨°ÈîôËØØÔºö${schedule.length}ÔºåÂ∫îËØ•15Âú∫`);
                return false;
            }
            
            // ÁªüËÆ°ÊØè‰∫∫ÂèÇ‰∏éÊ¨°Êï∞
            const playerCounts = Array(5).fill(0);
            schedule.forEach(match => {
                if (match.length !== 4) {
                    console.error(`‚ùå Âú∫Ê¨°‰∫∫Êï∞ÈîôËØØÔºö${match.length}‰∫∫ÔºåÂ∫îËØ•4‰∫∫`);
                    return false;
                }
                match.forEach(playerId => playerCounts[playerId]++);
            });
            
            // Ê£ÄÊü•ÊØè‰∫∫ÊòØÂê¶ÈÉΩÊòØ12Âú∫
            const allTwelve = playerCounts.every(count => count === 12);
            if (!allTwelve) {
                console.error(`‚ùå Âú∫Ê¨°ÂàÜÈÖçÈîôËØØÔºö[${playerCounts.join(',')}]ÔºåÂ∫îËØ•ÊØè‰∫∫12Âú∫`);
                return false;
            }
            
            // ÁªüËÆ°Êê≠ÈÖçÊ¨°Êï∞
            const partnerships = {};
            for (let i = 0; i < 5; i++) {
                for (let j = i + 1; j < 5; j++) {
                    partnerships[`${i}-${j}`] = 0;
                }
            }
            
            schedule.forEach(match => {
                // ÁªüËÆ°ËøôÂú∫ÊØîËµõ‰∏≠ÁöÑÊâÄÊúâÊê≠ÈÖç
                for (let i = 0; i < match.length; i++) {
                    for (let j = i + 1; j < match.length; j++) {
                        const key = `${Math.min(match[i], match[j])}-${Math.max(match[i], match[j])}`;
                        partnerships[key]++;
                    }
                }
            });
            
            // Ê£ÄÊü•Êê≠ÈÖçÂàÜÂ∏ÉÔºöÂ∫îËØ•2-3Ê¨°
            const partnerCounts = Object.values(partnerships);
            const validRange = partnerCounts.every(count => count >= 2 && count <= 3);
            if (!validRange) {
                console.error(`‚ùå Êê≠ÈÖçÂàÜÈÖçÈîôËØØÔºö${JSON.stringify(partnerships)}`);
                return false;
            }
            
            console.log('‚úÖ 5‰∫∫È™åËØÅÔºöÊØè‰∫∫12Âú∫ÔºåÊØèÂØπ2-3Ê¨°Êê≠ÈÖç');
            return true;
        }

        // Â∞ÜÊï∞Â≠óÂÆâÊéíËΩ¨Êç¢‰∏∫ÂÆûÈôÖÊØîËµõÊ†ºÂºè
        function convertScheduleToMatches(schedule, players) {
            const matches = [];
            
            schedule.forEach((match, index) => {
                let team1, team2;
                
                if (match.team1 && match.team2) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊåáÂÆö‰∫ÜÈòü‰ºçÂàÜÈÖçÔºåÁõ¥Êé•‰ΩøÁî®
                    team1 = [players[match.team1[0]], players[match.team1[1]]];
                    team2 = [players[match.team2[0]], players[match.team2[1]]];
                } else {
                    // Â¶ÇÊûúÂè™ÊòØ4‰∫∫Êï∞ÁªÑÔºåÈöèÊú∫ÂàÜÈòüÔºàÁî®‰∫é5‰∫∫Ê®°ÂºèÔºâ
                    const shuffled = [...match].sort(() => Math.random() - 0.5);
                    team1 = [players[shuffled[0]], players[shuffled[1]]];
                    team2 = [players[shuffled[2]], players[shuffled[3]]];
                }
                
                matches.push({
                    team1: team1,
                    team2: team2,
                    score1: 0,
                    score2: 0,
                    matchIndex: index
                });
            });
            
            console.log(`‚úÖ ËΩ¨Êç¢ÂÆåÊàêÔºö${matches.length}Âú∫ÊØîËµõ`);
            return matches;
        }

        // Âº∫Âà∂Âà∑Êñ∞ÂáΩÊï∞
        function forceRefresh() {
            // Ê∏ÖÁêÜÊâÄÊúâÁºìÂ≠ò
            localStorage.clear();
            sessionStorage.clear();
            
            // Ê∏ÖÁêÜ Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                    });
                });
            }
            
            // Ê∏ÖÁêÜÊµèËßàÂô®ÁºìÂ≠ò
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => caches.delete(cacheName))
                    );
                });
            }
            
            // ÊòæÁ§∫ÊèêÁ§∫
            showSyncNotification('üîÑ Ê≠£Âú®Ê∏ÖÁêÜÁºìÂ≠òÂπ∂Âà∑Êñ∞...');
            
            // Âª∂ËøüÂà∑Êñ∞ÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÊèêÁ§∫
            setTimeout(() => {
                // ‰ΩøÁî®Êó∂Èó¥Êà≥Âº∫Âà∂ÁªïËøáÁºìÂ≠ò
                const url = window.location.href;
                const separator = url.includes('?') ? '&' : '?';
                window.location.href = url + separator + '_t=' + Date.now();
            }, 1000);
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOMÂä†ËΩΩÂÆåÊàê');
            safeInit();
        });

        // Â§áÁî®ÂàùÂßãÂåñÔºàÂ¶ÇÊûú DOMContentLoaded Â∑≤ÁªèËß¶ÂèëÔºâ
        if (document.readyState === 'loading') {
            debugLog('Á≠âÂæÖDOMÂä†ËΩΩ');
        } else {
            debugLog('DOMÂ∑≤ÁªèÂä†ËΩΩÔºåÁ´ãÂç≥ÂàùÂßãÂåñ');
            setTimeout(safeInit, 100); // Á®çÂæÆÂª∂ËøüÁ°Æ‰øùÊâÄÊúâËÑöÊú¨ÈÉΩÂä†ËΩΩÂÆåÊàê
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('advancedScoreModal').addEventListener('click', function(e) {
            if (e.target === this) closeAdvancedScoreModal();
        });

        document.getElementById('playerConfigModal').addEventListener('click', function(e) {
            if (e.target === this) closePlayerConfigModal();
        });

        document.getElementById('scheduleModal').addEventListener('click', function(e) {
            if (e.target === this) closeScheduleModal();
        });

        document.getElementById('customDialog').addEventListener('click', function(e) {
            if (e.target === this) closeDialog();
        });

    </script>
</body>
</html>

