<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç¾½æ¯›çƒæ¯”èµ›ç³»ç»Ÿ</title>
    
    <!-- LeanCloud SDK - å›½å†…æœ€ä½³å®æ—¶æ•°æ®åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    <!-- LeanCloud å®æ—¶é€šä¿¡SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@5.0.0/dist/realtime.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, button {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            overflow-x: hidden;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 20px);
            overscroll-behavior: none;
            -webkit-overscroll-behavior: none;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .header p {
            color: #7f8c8d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* é¡µé¢åˆ‡æ¢ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ç©å®¶åå• */
        .players-list {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .players-list h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .players-names {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* æ¯”èµ›é¢„è§ˆ */
        .rounds-preview {
            margin: 20px 0;
        }

        .round-preview {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .round-preview h3 {
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .preview-matches {
            display: grid;
            gap: 8px;
        }

        .preview-match {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            font-size: 0.85rem;
            color: #495057;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .preview-match:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .preview-match:active {
            transform: scale(0.98);
        }

        .preview-match.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }

        .preview-match.completed::after {
            content: 'âœ…';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1rem;
        }

        .preview-match.incomplete {
            background: #fff3cd;
            border-color: #ffc107;
            animation: pulse-incomplete 2s infinite;
        }

        @keyframes pulse-incomplete {
            0% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2); }
            50% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4); }
            100% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2); }
        }

        .match-score {
            font-weight: bold;
            font-size: 1rem;
            color: #667eea;
            background: white;
            padding: 6px 12px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            min-width: 60px;
            align-self: center;
        }

        .match-score.has-score {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .control-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }

        .control-btn:hover, .control-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: scale(0.98);
        }

        /* é«˜çº§æ¯”åˆ†é€‰æ‹©å™¨ */
        .advanced-score-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .advanced-score-modal.active {
            display: flex;
        }

        .advanced-modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 350px;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .teams-score-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0;
            gap: 20px;
        }

        .team-score-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .team-name-display {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            text-align: center;
            line-height: 1.3;
        }

        .score-wheel-container {
            position: relative;
            height: 120px;
            width: 80px;
            overflow: hidden;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
        }

        .score-wheel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .score-item {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .score-item.center {
            color: #667eea;
            font-size: 1.6rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .score-item.adjacent {
            font-size: 1rem;
            color: #adb5bd;
        }

        .score-item.distant {
            font-size: 0.8rem;
            color: #ced4da;
        }

        .vs-separator {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .score-controls {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .score-control-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-save-scores {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-save-scores:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-save-scores:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-cancel-scores {
            background: #6c757d;
            color: white;
        }

        .btn-cancel-scores:hover {
            background: #5a6268;
        }

        .score-status {
            margin: 15px 0;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .score-status.complete {
            color: #28a745;
            font-weight: 600;
        }

        /* è‡ªå®šä¹‰å¼¹æ¡† */
        .custom-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .custom-dialog.active {
            display: flex;
        }

        .dialog-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 340px;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: dialogSlideIn 0.3s ease-out;
        }

        @keyframes dialogSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .dialog-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .dialog-icon.info {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .dialog-icon.warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .dialog-icon.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .dialog-icon.error {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .dialog-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .dialog-message {
            color: #6c757d;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 25px;
            white-space: pre-line;
        }

        .dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .dialog-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .dialog-btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .dialog-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .dialog-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .dialog-btn-secondary:hover {
            background: #5a6268;
        }

        /* LoadingçŠ¶æ€ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
            line-height: 1.4;
        }

        /* æ’åè¡¨æ ¼ */
        .results-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .results-table h3 {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .results-grid {
            display: grid;
            gap: 8px;
        }

        .result-row {
            display: grid;
            grid-template-columns: 50px 1fr 50px 50px 70px;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            font-size: 0.9rem;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .result-row.header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 12px;
            border-left: none;
        }

        .result-row.winner {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            font-weight: bold;
            border-left-color: #ffd700;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }

        .result-row:not(.header):not(.winner) {
            border-left-color: #e9ecef;
        }

        .result-row:not(.header):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .rank-cell {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
        }

        .name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .score-cell {
            text-align: center;
            font-weight: 500;
        }

        .net-score-positive {
            color: #28a745;
            font-weight: bold;
        }

        .net-score-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .net-score-zero {
            color: #6c757d;
        }


        .sync-notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¸ ç¾½æ¯›çƒæ¯”èµ›ç³»ç»Ÿ</h1>
            <p>5äººè½®è½¬åˆ¶ - 3è½®æ¯”èµ›ï¼Œæ¯è½®5åœº</p>
        </div>

        <!-- ä¸»é¡µé¢ -->
        <div id="mainPage" class="page active">
            <div class="players-list">
                <h4>ğŸ“‹ å‚èµ›äººå‘˜åå•</h4>
                <div class="players-names" id="playersNames">
                    <!-- ç©å®¶åå•å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
        </div>

            <div class="rounds-preview">
                <div class="round-preview">
                    <h3>ç¬¬ä¸€è½®æ¯”èµ›</h3>
                    <div class="preview-matches">
                        <div class="preview-match" onclick="openMatchScore(0, 0)">
                            <div class="match-text">æ¯”èµ›1</div>
                            <span class="match-score" id="score-0-0">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(0, 1)">
                            <div class="match-text">æ¯”èµ›2</div>
                            <span class="match-score" id="score-0-1">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(0, 2)">
                            <div class="match-text">æ¯”èµ›3</div>
                            <span class="match-score" id="score-0-2">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(0, 3)">
                            <div class="match-text">æ¯”èµ›4</div>
                            <span class="match-score" id="score-0-3">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(0, 4)">
                            <div class="match-text">æ¯”èµ›5</div>
                            <span class="match-score" id="score-0-4">0 : 0</span>
                        </div>
                    </div>
            </div>
            
                <div class="round-preview">
                    <h3>ç¬¬äºŒè½®æ¯”èµ›</h3>
                    <div class="preview-matches">
                        <div class="preview-match" onclick="openMatchScore(1, 0)">
                            <div class="match-text">æ¯”èµ›1</div>
                            <span class="match-score" id="score-1-0">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(1, 1)">
                            <div class="match-text">æ¯”èµ›2</div>
                            <span class="match-score" id="score-1-1">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(1, 2)">
                            <div class="match-text">æ¯”èµ›3</div>
                            <span class="match-score" id="score-1-2">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(1, 3)">
                            <div class="match-text">æ¯”èµ›4</div>
                            <span class="match-score" id="score-1-3">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(1, 4)">
                            <div class="match-text">æ¯”èµ›5</div>
                            <span class="match-score" id="score-1-4">0 : 0</span>
                        </div>
                    </div>
                </div>

                <div class="round-preview">
                    <h3>ç¬¬ä¸‰è½®æ¯”èµ›</h3>
                    <div class="preview-matches">
                        <div class="preview-match" onclick="openMatchScore(2, 0)">
                            <div class="match-text">æ¯”èµ›1</div>
                            <span class="match-score" id="score-2-0">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(2, 1)">
                            <div class="match-text">æ¯”èµ›2</div>
                            <span class="match-score" id="score-2-1">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(2, 2)">
                            <div class="match-text">æ¯”èµ›3</div>
                            <span class="match-score" id="score-2-2">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(2, 3)">
                            <div class="match-text">æ¯”èµ›4</div>
                            <span class="match-score" id="score-2-3">0 : 0</span>
                        </div>
                        <div class="preview-match" onclick="openMatchScore(2, 4)">
                            <div class="match-text">æ¯”èµ›5</div>
                            <span class="match-score" id="score-2-4">0 : 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="game-controls">
                <button class="control-btn btn-success" onclick="showFinalRanking()" id="showRankingBtn">
                    ğŸ“Š æŸ¥çœ‹æœ€ç»ˆæ’å
                </button>
                <button class="control-btn btn-primary" onclick="regenerateMatches()">
                    ğŸ² é‡æ–°å¼€å§‹æ¯”èµ›
                </button>
            </div>
            
            <!-- æœ€ç»ˆæ’å -->
            <div class="final-ranking" id="finalRanking" style="display: none;">
                <div class="results-table">
                    <h3>ğŸ† æœ€ç»ˆæ’å</h3>
                    <div class="results-grid" id="resultsGrid">
                        <!-- ç»“æœå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
                <button class="control-btn btn-warning" onclick="hideFinalRanking()" style="margin-top: 15px;">
                    âŒ å…³é—­æ’å
                </button>
            </div>
        </div>
        </div>

    <!-- LoadingçŠ¶æ€ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
        <div class="loading-subtitle">æ­£åœ¨ä»LeanCloudäº‘ç«¯åŠ è½½æœ€æ–°æ¯”åˆ†æ•°æ®<br>è¯·ç¨ç­‰ç‰‡åˆ»</div>
    </div>

    <!-- é«˜çº§æ¯”åˆ†é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <div id="advancedScoreModal" class="advanced-score-modal">
        <div class="advanced-modal-content">
            <h3 id="advancedScoreTitle">è®°å½•æ¯”åˆ†</h3>
            <div class="score-status" id="scoreStatus">è¯·ä¸ºåŒæ–¹é˜Ÿä¼è®¾ç½®æ¯”åˆ†</div>
            
            <div class="teams-score-section">
                <!-- é˜Ÿä¼1 -->
                <div class="team-score-container">
                    <div class="team-name-display" id="team1Name">é˜Ÿä¼1</div>
                    <div class="score-wheel-container" 
                         ontouchstart="handleTouchStart(event, 0)" 
                         ontouchmove="handleTouchMove(event, 0)" 
                         ontouchend="handleTouchEnd(event, 0)"
                         onmousedown="handleMouseDown(event, 0)"
                         onmousemove="handleMouseMove(event, 0)"
                         onmouseup="handleMouseUp(event, 0)">
                        <div class="score-wheel" id="scoreWheel1">
                            <!-- æ¯”åˆ†è½®æ’­é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </div>
            </div>
        </div>

                <div class="vs-separator">VS</div>

                <!-- é˜Ÿä¼2 -->
                <div class="team-score-container">
                    <div class="team-name-display" id="team2Name">é˜Ÿä¼2</div>
                    <div class="score-wheel-container" 
                         ontouchstart="handleTouchStart(event, 1)" 
                         ontouchmove="handleTouchMove(event, 1)" 
                         ontouchend="handleTouchEnd(event, 1)"
                         onmousedown="handleMouseDown(event, 1)"
                         onmousemove="handleMouseMove(event, 1)"
                         onmouseup="handleMouseUp(event, 1)">
                        <div class="score-wheel" id="scoreWheel2">
                            <!-- æ¯”åˆ†è½®æ’­é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="score-controls">
                <button class="score-control-btn btn-save-scores" onclick="saveMatchScores()" id="saveScoresBtn" disabled>
                    ä¿å­˜æ¯”åˆ†
                </button>
                <button class="score-control-btn btn-cancel-scores" onclick="closeAdvancedScoreModal()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å¼¹æ¡† -->
    <div id="customDialog" class="custom-dialog">
        <div class="dialog-content">
            <div class="dialog-icon" id="dialogIcon">
                <span id="dialogIconText">â„¹ï¸</span>
            </div>
            <div class="dialog-title" id="dialogTitle">æç¤º</div>
            <div class="dialog-message" id="dialogMessage">æ¶ˆæ¯å†…å®¹</div>
            <div class="dialog-buttons" id="dialogButtons">
                <!-- æŒ‰é’®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let selectedRound = 0;
        let selectedMatch = 0;
        let team1Score = 0;
        let team2Score = 0;
        let team1ScoreSet = false;
        let team2ScoreSet = false;

        // è§¦æ‘¸å’Œæ‹–æ‹½çŠ¶æ€
        let touchStartY = 0;
        let isDragging = false;

        // äº‘ç«¯åŒæ­¥çŠ¶æ€
        let isConnected = false;
        let saveToSync = null;

        // ç”Ÿæˆç”¨æˆ·ID
        window.currentUserId = 'user-' + Math.random().toString(36).substr(2, 6);
        window.lastActionType = 'init';

        // ç©å®¶é…ç½®
        const playerConfig = [
            { name: 'é›·é”‹', avatar: 'é›·', id: 1 },
            { name: 'é­”', avatar: 'é­”', id: 2 },
            { name: 'é™ˆå¼º', avatar: 'å¼º', id: 3 },
            { name: 'ä½•å±±æ°´', avatar: 'ä½•', id: 4 },
            { name: 'å¤§è‹¹æœ', avatar: 'æœ', id: 5 }
        ];

        // æ¯”èµ›å®‰æ’
        let matchSchedule = [];

        // ç”Ÿæˆéšæœºæ¯”èµ›å®‰æ’
        function generateRandomMatches() {
            matchSchedule = [];
            const players = playerConfig.map(p => p.name);
            
            const matchTemplates = [
                [
                    { team1: [0, 1], team2: [2, 3] },
                    { team1: [0, 2], team2: [1, 4] },
                    { team1: [0, 3], team2: [2, 4] },
                    { team1: [0, 4], team2: [1, 3] },
                    { team1: [1, 2], team2: [3, 4] }
                ],
                [
                    { team1: [1, 3], team2: [0, 4] },
                    { team1: [1, 4], team2: [0, 2] },
                    { team1: [2, 3], team2: [0, 1] },
                    { team1: [2, 4], team2: [1, 3] },
                    { team1: [0, 3], team2: [1, 2] }
                ],
                [
                    { team1: [0, 2], team2: [3, 4] },
                    { team1: [1, 4], team2: [2, 3] },
                    { team1: [0, 1], team2: [2, 4] },
                    { team1: [1, 3], team2: [0, 4] },
                    { team1: [0, 3], team2: [1, 4] }
                ]
            ];
            
            for (let round = 0; round < 3; round++) {
                const roundMatches = [];
                const template = [...matchTemplates[round]];
                template.sort(() => Math.random() - 0.5);
                
                template.forEach(match => {
                    const team1 = [players[match.team1[0]], players[match.team1[1]]];
                    const team2 = [players[match.team2[0]], players[match.team2[1]]];
                    
                    if (Math.random() > 0.5) team1.reverse();
                    if (Math.random() > 0.5) team2.reverse();
                    
                    roundMatches.push({
                        team1: team1,
                        team2: team2,
                        score1: 0,
                        score2: 0
                    });
                });
                
                matchSchedule.push(roundMatches);
            }
        }

        // æ›´æ–°ç©å®¶æ˜¾ç¤º
        function updatePlayersDisplay() {
            const playersContainer = document.getElementById('playersNames');
            const playerNames = playerConfig.map(player => player.name);
            playersContainer.textContent = playerNames.join(' â€¢ ');
        }

        // æ›´æ–°æ¯”èµ›æ˜¾ç¤º
        function updateMatchDisplay() {
            for (let round = 0; round < 3; round++) {
                for (let match = 0; match < 5; match++) {
                    const scoreElement = document.getElementById(`score-${round}-${match}`);
                    const matchElement = scoreElement ? scoreElement.closest('.preview-match') : null;
                    const matchData = matchSchedule[round] && matchSchedule[round][match];
                    
                    if (scoreElement && matchData && matchElement) {
                        const score1 = matchData.score1;
                        const score2 = matchData.score2;
                        scoreElement.textContent = `${score1} : ${score2}`;
                        
                        if (score1 > 0 || score2 > 0) {
                            scoreElement.classList.add('has-score');
                            matchElement.classList.add('completed');
                            matchElement.classList.remove('incomplete');
                } else {
                            scoreElement.classList.remove('has-score');
                            matchElement.classList.remove('completed');
                        }
                    }
                }
            }
            
            updateMatchTexts();
        }

        // æ›´æ–°æ¯”èµ›æ–‡æœ¬
        function updateMatchTexts() {
            const matchTexts = document.querySelectorAll('.preview-match .match-text');
            matchTexts.forEach((textElement, index) => {
                const round = Math.floor(index / 5);
                const match = index % 5;
                const matchData = matchSchedule[round] && matchSchedule[round][match];
                
                if (matchData) {
                    textElement.textContent = `${matchData.team1.join(' + ')} VS ${matchData.team2.join(' + ')}`;
                }
            });
        }

        // LeanCloudå®æ—¶åŒæ­¥ï¼ˆå›½å†…æœ€ä½³æ–¹æ¡ˆï¼‰
        function initSimpleJsonSync() {
            // LeanCloudé…ç½®ï¼ˆæ¼”ç¤ºé…ç½®ï¼Œæ‚¨å¯ä»¥åˆ›å»ºè‡ªå·±çš„ï¼‰
            const leancloudConfig = {
                appId: 'sHFMtBnumqNruNtqiQFGNuah-gzGzoHsz',
                appKey: 'OQLGQDKCo48oayq0OAnd8g5K',
                serverURL: 'https://shfmtbnu.lc-cn-n1-shared.com'
            };
            
            let lastSyncTime = 0;
            let gameClass = null;
            
            // åˆå§‹åŒ–LeanCloud
            async function init() {
                try {
                    showLoading('æ­£åœ¨è¿æ¥äº‘ç«¯...', 'è¿æ¥LeanCloudå®æ—¶æ•°æ®åº“');
                    
                    // åˆå§‹åŒ–LeanCloud
                    AV.init(leancloudConfig);
                    
                    // åˆ›å»ºæ•°æ®ç±»
                    gameClass = AV.Object.extend('BadmintonGame');
                    
                    // ä»äº‘ç«¯åŠ è½½æ•°æ®
                    await loadFromCloud();
                    
                    // è®¾ç½®å®æ—¶ç›‘å¬
                    setupRealtimeListener();
                    
                    isConnected = true;
                    hideLoading();
                    showSyncNotification('ğŸ‰ LeanCloudè¿æ¥æˆåŠŸï¼å®æ—¶åŒæ­¥å·²å¼€å¯');
                    
                } catch (error) {
                    console.error('LeanCloudè¿æ¥å¤±è´¥:', error);
                    isConnected = false;
                    hideLoading();
                    
                    // ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼
                    initDemoMode();
                    
                    showSyncNotification('âš ï¸ LeanCloudè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼ˆæ•°æ®ä»…æœ¬åœ°ä¿å­˜ï¼‰');
                }
            }
            
            // æ¼”ç¤ºæ¨¡å¼ï¼ˆæ¨¡æ‹Ÿå®æ—¶åŒæ­¥ï¼‰
            function initDemoMode() {
                generateRandomMatches();
                updatePlayersDisplay();
                updateMatchDisplay();
                
                // æ¨¡æ‹Ÿå®æ—¶åŒæ­¥çš„æœ¬åœ°ç‰ˆæœ¬
                let syncData = {
                    matchSchedule: matchSchedule,
                    timestamp: Date.now(),
                    lastUpdatedBy: window.currentUserId
                };
                
                // ä¿å­˜å‡½æ•°
                saveToSync = function() {
                    syncData = {
                        matchSchedule: matchSchedule,
                        finalRankingVisible: document.getElementById('finalRanking').style.display !== 'none',
                        timestamp: Date.now(),
                        lastUpdatedBy: window.currentUserId,
                        actionType: window.lastActionType
                    };
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('badminton-realtime-demo', JSON.stringify(syncData));
                    
                    showSyncNotification('ğŸ“Š æ¯”åˆ†å·²æ›´æ–°ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
                    
                    // æ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·çš„æ›´æ–°é€šçŸ¥
                    setTimeout(() => {
                        const actions = {
                            'score_update': 'ğŸ“Š æ¨¡æ‹Ÿï¼šå…¶ä»–äººçœ‹åˆ°äº†æ¯”åˆ†æ›´æ–°',
                            'regenerate_matches': 'ğŸ² æ¨¡æ‹Ÿï¼šå…¶ä»–äººçœ‹åˆ°äº†é‡æ–°å¼€å§‹',
                            'show_ranking': 'ğŸ† æ¨¡æ‹Ÿï¼šå…¶ä»–äººçœ‹åˆ°äº†æ’å'
                        };
                        showSyncNotification(actions[window.lastActionType] || 'ğŸ“Š æ¨¡æ‹ŸåŒæ­¥å®Œæˆ');
                    }, 2000);
                };
                
                // æ£€æŸ¥æœ¬åœ°æ•°æ®
                try {
                    const stored = localStorage.getItem('badminton-realtime-demo');
                    if (stored) {
                        const data = JSON.parse(stored);
                        if (data.matchSchedule) {
                            matchSchedule = data.matchSchedule;
                            updateMatchDisplay();
                            
                            if (data.finalRankingVisible) {
                                document.getElementById('finalRanking').style.display = 'block';
                            }
                            
                            showSyncNotification('ğŸ“Š åŠ è½½äº†ä¹‹å‰çš„æ¯”èµ›æ•°æ®');
                        }
                    }
                } catch (e) {
                    console.log('æ•°æ®åŠ è½½å¤±è´¥');
                }
            }
            
            // ä¿å­˜åˆ°LeanCloudï¼ˆæ›´æ–°ç°æœ‰è®°å½•ï¼‰
            async function save() {
                if (!gameClass) {
                    console.log('LeanCloudæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼');
                return;
            }

                try {
                    showLoading('æ­£åœ¨åŒæ­¥...', 'ä¿å­˜æ¯”åˆ†åˆ°äº‘ç«¯æ•°æ®åº“');
                    
                    const gameData = {
                        matchSchedule: matchSchedule,
                        finalRankingVisible: document.getElementById('finalRanking').style.display !== 'none',
                        timestamp: Date.now(),
                        lastUpdatedBy: window.currentUserId,
                        actionType: window.lastActionType || 'score_update'
                    };
                    
                    // å…ˆæŸ¥æ‰¾ç°æœ‰è®°å½•
                    const query = new AV.Query(gameClass);
                    query.equalTo('gameId', 'current_game');
                    const results = await query.find();
                    
                    let gameObject;
                    if (results.length > 0) {
                        // æ›´æ–°ç°æœ‰è®°å½•
                        gameObject = results[0];
                    } else {
                        // åˆ›å»ºæ–°è®°å½•
                        gameObject = new gameClass();
                        gameObject.set('gameId', 'current_game');
                    }
                    
                    gameObject.set('data', gameData);
                    await gameObject.save();
                    
                    lastSyncTime = gameData.timestamp;
                    hideLoading();
                    showSyncNotification('â˜ï¸ æ¯”åˆ†å·²å®æ—¶åŒæ­¥');
                    
                } catch (error) {
                    console.error('LeanCloudä¿å­˜å¤±è´¥:', error);
                    hideLoading();
                    showSyncNotification('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                }
            }
            
            // ä»LeanCloudåŠ è½½æ•°æ®
            async function loadFromCloud() {
                if (!gameClass) return;
                
                try {
                    showLoading('æ­£åœ¨åŠ è½½æ•°æ®...', 'ä»äº‘ç«¯è·å–æœ€æ–°æ¯”åˆ†æ•°æ®');
                    
                    const query = new AV.Query(gameClass);
                    query.equalTo('gameId', 'current_game');
                    query.descending('updatedAt');
                    query.limit(1);
                    
                    const results = await query.find();
                    
                    if (results.length > 0) {
                        const gameData = results[0].get('data');
                        
                        if (gameData && gameData.matchSchedule) {
                            matchSchedule = gameData.matchSchedule;
                            lastSyncTime = gameData.timestamp || 0;
                            updateMatchDisplay();
                            
                            if (gameData.finalRankingVisible) {
                                document.getElementById('finalRanking').style.display = 'block';
                            }
                            
                            hideLoading();
                            showSyncNotification('ğŸ“Š äº‘ç«¯æ•°æ®åŠ è½½å®Œæˆ');
                        } else {
                            hideLoading();
                            generateRandomMatches();
                            updateMatchDisplay();
                            showSyncNotification('ğŸ² ç”Ÿæˆäº†æ–°çš„æ¯”èµ›å®‰æ’');
                        }
                    } else {
                        // äº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œç”Ÿæˆæ–°æ¯”èµ›
                        hideLoading();
                        generateRandomMatches();
                        updateMatchDisplay();
                        showSyncNotification('ğŸ² ç”Ÿæˆäº†æ–°çš„æ¯”èµ›å®‰æ’');
                    }
                    
                } catch (error) {
                    console.error('LeanCloudåŠ è½½å¤±è´¥:', error);
                    hideLoading();
                    generateRandomMatches();
                    updateMatchDisplay();
                    showSyncNotification('âš ï¸ åŠ è½½å¤±è´¥ï¼Œç”Ÿæˆæ–°æ¯”èµ›');
                }
            }
            
            // è®¾ç½®å®æ—¶ç›‘å¬ï¼ˆä½¿ç”¨è½®è¯¢ç¡®ä¿å¯é æ€§ï¼‰
            function setupRealtimeListener() {
                if (!gameClass) return;
                
                // æ¯10ç§’æ£€æŸ¥äº‘ç«¯æ›´æ–°ï¼ˆé™ä½é¢‘ç‡é¿å…è¶…è¿‡LeanCloudé™åˆ¶ï¼‰
                setInterval(async () => {
                    try {
                        const query = new AV.Query(gameClass);
                        query.equalTo('gameId', 'current_game');
                        query.descending('updatedAt');
                        query.limit(1);
                        
                        const results = await query.find();
                        
                        if (results.length > 0) {
                            const gameData = results[0].get('data');
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®
                            if (gameData && gameData.timestamp > lastSyncTime && 
                                gameData.lastUpdatedBy !== window.currentUserId) {
                                
                                lastSyncTime = gameData.timestamp;
                                
                                // æ›´æ–°æ¯”èµ›æ•°æ®
                                matchSchedule = gameData.matchSchedule;
                                updateMatchDisplay();
                                
                                // æ›´æ–°æ’åæ˜¾ç¤ºçŠ¶æ€
                                if (gameData.finalRankingVisible) {
                                    document.getElementById('finalRanking').style.display = 'block';
                                } else {
                                    document.getElementById('finalRanking').style.display = 'none';
                                }
                                
                                // æ˜¾ç¤ºå®æ—¶æ›´æ–°æç¤º - æ›´æ˜æ˜¾çš„é€šçŸ¥
                                const actions = {
                                    'score_update': 'ğŸ”¥ æœ‰äººä¿®æ”¹äº†æ¯”åˆ†ï¼',
                                    'regenerate_matches': 'ğŸ² æœ‰äººé‡æ–°å¼€å§‹äº†æ¯”èµ›',
                                    'show_ranking': 'ğŸ† æœ‰äººæŸ¥çœ‹äº†æ’å',
                                    'hide_ranking': 'âŒ æœ‰äººå…³é—­äº†æ’å'
                                };
                                
                                const notificationMessage = actions[gameData.actionType] || 'ğŸ“Š å®æ—¶æ•°æ®æ›´æ–°';
                                showSyncNotification(notificationMessage);
                                
                                // å¦‚æœæ˜¯æ¯”åˆ†æ›´æ–°ï¼Œæ˜¾ç¤ºæ›´æ˜æ˜¾çš„æç¤º
                                if (gameData.actionType === 'score_update') {
                                    showAlert('ğŸ”¥ æœ‰äººä¿®æ”¹äº†æ¯”åˆ†ï¼\n\né¡µé¢æ•°æ®å·²è‡ªåŠ¨æ›´æ–°', 'æ¯”åˆ†æ›´æ–°æé†’', 'info');
                                }
                            }
                        }
                        
                    } catch (error) {
                        console.log('å®æ—¶æ£€æŸ¥å¤±è´¥:', error);
                    }
                }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œé™ä½é¢‘ç‡é¿å…è¶…è¿‡ä½¿ç”¨é™åˆ¶
                
                showSyncNotification('ğŸ”¥ å®æ—¶ç›‘å¬å·²å¼€å¯ï¼ˆ10ç§’æ£€æŸ¥ï¼‰');
            }
            
            
            init();
            return save;
        }

        // æ‰“å¼€æ¯”åˆ†é€‰æ‹©å™¨
        function openMatchScore(round, match) {
            selectedRound = round;
            selectedMatch = match;
            
            const matchData = matchSchedule[round] && matchSchedule[round][match];
            if (!matchData) return;

            team1Score = matchData.score1;
            team2Score = matchData.score2;
            team1ScoreSet = matchData.score1 > 0;
            team2ScoreSet = matchData.score2 > 0;

            document.getElementById('advancedScoreTitle').textContent = `ç¬¬${round + 1}è½®ç¬¬${match + 1}åœºæ¯”èµ›`;
            document.getElementById('team1Name').textContent = matchData.team1.join(' + ');
            document.getElementById('team2Name').textContent = matchData.team2.join(' + ');

            createScoreWheel('scoreWheel1', team1Score);
            createScoreWheel('scoreWheel2', team2Score);
            updateScoreStatus();

            document.getElementById('advancedScoreModal').classList.add('active');
        }

        // åˆ›å»ºæ¯”åˆ†è½®æ’­
        function createScoreWheel(wheelId, currentScore) {
            const wheel = document.getElementById(wheelId);
            wheel.innerHTML = '';

            for (let i = 0; i <= 30; i++) {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                scoreItem.textContent = i;
                scoreItem.onclick = () => selectWheelScore(wheelId, i);
                wheel.appendChild(scoreItem);
            }

            setWheelPosition(wheelId, currentScore);
        }

        // è®¾ç½®è½®æ’­ä½ç½®
        function setWheelPosition(wheelId, score) {
            const wheel = document.getElementById(wheelId);
            const items = wheel.children;
            
            const offset = -score * 40 + 40;
            wheel.style.transform = `translateY(${offset}px)`;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const distance = Math.abs(i - score);
                
                item.classList.remove('center', 'adjacent', 'distant');
                
                if (distance === 0) {
                    item.classList.add('center');
                } else if (distance === 1) {
                    item.classList.add('adjacent');
                } else {
                    item.classList.add('distant');
                }
            }
        }

        // é€‰æ‹©åˆ†æ•°
        function selectWheelScore(wheelId, score) {
            if (wheelId === 'scoreWheel1') {
                team1Score = score;
                team1ScoreSet = true;
            } else {
                team2Score = score;
                team2ScoreSet = true;
            }

            setWheelPosition(wheelId, score);
            updateScoreStatus();
        }

        // è§¦æ‘¸å¤„ç†
        function handleTouchStart(event, teamIndex) {
            event.preventDefault();
            touchStartY = event.touches[0].clientY;
            isDragging = true;
        }

        function handleTouchMove(event, teamIndex) {
            if (!isDragging) return;
            event.preventDefault();
            
            const currentY = event.touches[0].clientY;
            const deltaY = touchStartY - currentY;
            const sensitivity = 40;
            
            const scoreChange = Math.round(deltaY / sensitivity);
            if (Math.abs(scoreChange) >= 1) {
                const currentScore = teamIndex === 0 ? team1Score : team2Score;
                const newScore = Math.max(0, Math.min(30, currentScore + scoreChange));
                
                selectWheelScore(teamIndex === 0 ? 'scoreWheel1' : 'scoreWheel2', newScore);
                touchStartY = currentY;
            }
        }

        function handleTouchEnd(event, teamIndex) {
            isDragging = false;
        }

        function handleMouseDown(event, teamIndex) {
            event.preventDefault();
            touchStartY = event.clientY;
            isDragging = true;
        }

        function handleMouseMove(event, teamIndex) {
            if (!isDragging) return;
            event.preventDefault();
            
            const currentY = event.clientY;
            const deltaY = touchStartY - currentY;
            const sensitivity = 40;
            
            const scoreChange = Math.round(deltaY / sensitivity);
            if (Math.abs(scoreChange) >= 1) {
                const currentScore = teamIndex === 0 ? team1Score : team2Score;
                const newScore = Math.max(0, Math.min(30, currentScore + scoreChange));
                
                selectWheelScore(teamIndex === 0 ? 'scoreWheel1' : 'scoreWheel2', newScore);
                touchStartY = currentY;
            }
        }

        function handleMouseUp(event, teamIndex) {
            isDragging = false;
        }

        // æ›´æ–°æ¯”åˆ†çŠ¶æ€
        function updateScoreStatus() {
            const statusElement = document.getElementById('scoreStatus');
            const saveBtn = document.getElementById('saveScoresBtn');

            if (team1ScoreSet && team2ScoreSet) {
                statusElement.textContent = `æ¯”åˆ†è®¾ç½®å®Œæˆï¼š${team1Score} : ${team2Score}`;
                statusElement.className = 'score-status complete';
                saveBtn.disabled = false;
            } else if (team1ScoreSet) {
                statusElement.textContent = `å·¦ä¾§å·²è®¾ç½®ï¼š${team1Score}åˆ†ï¼Œè¯·è®¾ç½®å³ä¾§æ¯”åˆ†`;
                statusElement.className = 'score-status';
                saveBtn.disabled = true;
            } else if (team2ScoreSet) {
                statusElement.textContent = `å³ä¾§å·²è®¾ç½®ï¼š${team2Score}åˆ†ï¼Œè¯·è®¾ç½®å·¦ä¾§æ¯”åˆ†`;
                statusElement.className = 'score-status';
                saveBtn.disabled = true;
            } else {
                statusElement.textContent = 'è¯·æ»‘åŠ¨æˆ–ç‚¹å‡»æ•°å­—è®¾ç½®åŒæ–¹æ¯”åˆ†ï¼ˆ0-30åˆ†ï¼‰';
                statusElement.className = 'score-status';
                saveBtn.disabled = true;
            }
        }

        // ä¿å­˜æ¯”åˆ†
        function saveMatchScores() {
            if (!team1ScoreSet || !team2ScoreSet) {
                showAlert('è¯·ä¸ºåŒæ–¹é˜Ÿä¼éƒ½è®¾ç½®æ¯”åˆ†ï¼', 'âš ï¸ è®¾ç½®ä¸å®Œæ•´', 'warning');
                return;
            }

            const matchData = matchSchedule[selectedRound][selectedMatch];
            matchData.score1 = team1Score;
            matchData.score2 = team2Score;

            updateMatchDisplay();
            closeAdvancedScoreModal();
            
            window.lastActionType = 'score_update';
            if (saveToSync) saveToSync();
            
            showAlert(`æ¯”åˆ†å·²ä¿å­˜ï¼š${team1Score} : ${team2Score}`, 'âœ… ä¿å­˜æˆåŠŸ', 'success');
        }

        // å…³é—­æ¯”åˆ†é€‰æ‹©å™¨
        function closeAdvancedScoreModal() {
            document.getElementById('advancedScoreModal').classList.remove('active');
            team1ScoreSet = false;
            team2ScoreSet = false;
        }

        // é‡æ–°å¼€å§‹æ¯”èµ›
        function regenerateMatches() {
            showConfirm(
                'ç¡®å®šè¦é‡æ–°å¼€å§‹æ¯”èµ›å—ï¼Ÿ\nè¿™å°†é‡æ–°éšæœºå®‰æ’é˜Ÿå‹å¹¶æ¸…é™¤æ‰€æœ‰æ¯”åˆ†ã€‚',
                'ğŸ² é‡æ–°å¼€å§‹æ¯”èµ›',
                () => {
                    generateRandomMatches();
                    updatePlayersDisplay();
                    updateMatchDisplay();
                    hideFinalRanking();
                    
                    window.lastActionType = 'regenerate_matches';
                    if (saveToSync) saveToSync();
                    
                    showAlert('ğŸ‰ æ¯”èµ›å·²é‡æ–°å®‰æ’ï¼', 'å®‰æ’å®Œæˆ', 'success');
                }
            );
        }

        // æ˜¾ç¤ºæ’å
        function showFinalRanking() {
            const incompleteMatches = [];
            
            for (let round = 0; round < 3; round++) {
                for (let match = 0; match < 5; match++) {
                    const matchData = matchSchedule[round] && matchSchedule[round][match];
                    if (matchData && matchData.score1 === 0 && matchData.score2 === 0) {
                        const matchElement = document.getElementById(`score-${round}-${match}`)?.closest('.preview-match');
                        incompleteMatches.push({
                            element: matchElement,
                            round: round,
                            match: match
                        });
                    }
                }
            }

            if (incompleteMatches.length > 0) {
                // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªæœªè®¡åˆ†çš„æ¯”èµ›
                const firstIncompleteMatch = incompleteMatches[0];
                if (firstIncompleteMatch.element) {
                    // æ·»åŠ é«˜äº®æ•ˆæœ
                    firstIncompleteMatch.element.classList.add('incomplete');
                    
                    // å¹³æ»‘æ»šåŠ¨åˆ°è¯¥æ¯”èµ›
                    firstIncompleteMatch.element.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    // 3ç§’åç§»é™¤é«˜äº®æ•ˆæœ
                    setTimeout(() => {
                        firstIncompleteMatch.element.classList.remove('incomplete');
                    }, 3000);
                }
                
                showAlert(
                    `è¿˜æœ‰ ${incompleteMatches.length} åœºæ¯”èµ›æœªè®°å½•æ¯”åˆ†ï¼\n\nå·²è‡ªåŠ¨æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªæœªè®¡åˆ†çš„æ¯”èµ›ï¼ˆç¬¬${firstIncompleteMatch.round + 1}è½®ç¬¬${firstIncompleteMatch.match + 1}åœºï¼‰\n\nè¯·å®Œæˆæ‰€æœ‰æ¯”èµ›åå†æŸ¥çœ‹æ’åã€‚`,
                    'âš ï¸ æ¯”èµ›æœªå®Œæˆ',
                    'warning'
                );
                return;
            }

            calculateAndDisplayResults();
            document.getElementById('finalRanking').style.display = 'block';
            
            window.lastActionType = 'show_ranking';
            if (saveToSync) saveToSync();
        }

        // éšè—æ’å
        function hideFinalRanking() {
            document.getElementById('finalRanking').style.display = 'none';
            window.lastActionType = 'hide_ranking';
            if (saveToSync) saveToSync();
        }

        // è®¡ç®—æ’å
        function calculateAndDisplayResults() {
            const playerStats = {};
            playerConfig.forEach(player => {
                playerStats[player.name] = {
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    totalOpponentScore: 0
                };
            });

            matchSchedule.forEach(round => {
                round.forEach(match => {
                    if (match.score1 > 0 || match.score2 > 0) {
                        match.team1.forEach(player => {
                            playerStats[player].totalScore += match.score1;
                            playerStats[player].totalOpponentScore += match.score2;
                            if (match.score1 > match.score2) {
                                playerStats[player].wins += 1;
                            } else if (match.score1 < match.score2) {
                                playerStats[player].losses += 1;
                            }
                        });

                        match.team2.forEach(player => {
                            playerStats[player].totalScore += match.score2;
                            playerStats[player].totalOpponentScore += match.score1;
                            if (match.score2 > match.score1) {
                                playerStats[player].wins += 1;
                            } else if (match.score2 < match.score1) {
                                playerStats[player].losses += 1;
                            }
                        });
                    }
                });
            });

            const sortedPlayers = Object.entries(playerStats).sort((a, b) => {
                if (b[1].wins !== a[1].wins) return b[1].wins - a[1].wins;
                return (b[1].totalScore - b[1].totalOpponentScore) - (a[1].totalScore - a[1].totalOpponentScore);
            });

            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = `
                <div class="result-row header">
                    <div class="rank-cell">æ’å</div>
                    <div class="name-cell">å§“å</div>
                    <div class="score-cell">èƒœåœº</div>
                    <div class="score-cell">è´Ÿåœº</div>
                    <div class="score-cell">å‡€èƒœåˆ†</div>
                </div>
            `;

            sortedPlayers.forEach(([player, stats], index) => {
                const row = document.createElement('div');
                row.className = `result-row ${index === 0 ? 'winner' : ''}`;
                
                const netScore = stats.totalScore - stats.totalOpponentScore;
                const netScoreClass = netScore > 0 ? 'net-score-positive' : 
                                   netScore < 0 ? 'net-score-negative' : 'net-score-zero';
                
                row.innerHTML = `
                    <div class="rank-cell">${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : index + 1}</div>
                    <div class="name-cell">${player}</div>
                    <div class="score-cell">${stats.wins}</div>
                    <div class="score-cell">${stats.losses}</div>
                    <div class="score-cell ${netScoreClass}">${netScore > 0 ? '+' : ''}${netScore}</div>
                `;
                resultsGrid.appendChild(row);
            });
        }

        // å¼¹æ¡†å‡½æ•°
        function showDialog(options) {
            const dialog = document.getElementById('customDialog');
            const icon = document.getElementById('dialogIcon');
            const iconText = document.getElementById('dialogIconText');
            const title = document.getElementById('dialogTitle');
            const message = document.getElementById('dialogMessage');
            const buttons = document.getElementById('dialogButtons');

            const iconMap = {
                info: { text: 'â„¹ï¸', class: 'info' },
                warning: { text: 'âš ï¸', class: 'warning' },
                success: { text: 'âœ…', class: 'success' },
                error: { text: 'âŒ', class: 'error' },
                question: { text: 'â“', class: 'info' }
            };

            const iconConfig = iconMap[options.type] || iconMap.info;
            iconText.textContent = iconConfig.text;
            icon.className = `dialog-icon ${iconConfig.class}`;

            title.textContent = options.title || 'æç¤º';
            message.textContent = options.message || '';

            buttons.innerHTML = '';
            if (options.buttons && options.buttons.length > 0) {
                options.buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = `dialog-btn ${btn.class || 'dialog-btn-secondary'}`;
                    button.textContent = btn.text;
                    button.onclick = () => {
                        closeDialog();
                        if (btn.onClick) btn.onClick();
                    };
                    buttons.appendChild(button);
                });
            } else {
                const okButton = document.createElement('button');
                okButton.className = 'dialog-btn dialog-btn-primary';
                okButton.textContent = 'ç¡®å®š';
                okButton.onclick = () => {
                    closeDialog();
                    if (options.onOk) options.onOk();
                };
                buttons.appendChild(okButton);
            }

            dialog.classList.add('active');
        }

        function closeDialog() {
            document.getElementById('customDialog').classList.remove('active');
        }

        function showAlert(message, title = 'æç¤º', type = 'info', onOk = null) {
            showDialog({
                type: type,
                title: title,
                message: message,
                onOk: onOk
            });
        }

        function showConfirm(message, title = 'ç¡®è®¤', onConfirm = null, onCancel = null) {
            showDialog({
                type: 'question',
                title: title,
                message: message,
                buttons: [
                    {
                        text: 'å–æ¶ˆ',
                        class: 'dialog-btn-secondary',
                        onClick: onCancel
                    },
                    {
                        text: 'ç¡®å®š',
                        class: 'dialog-btn-primary',
                        onClick: onConfirm
                    }
                ]
            });
        }

        // Loadingå‡½æ•°
        function showLoading(text = 'æ­£åœ¨è¿æ¥äº‘ç«¯...', subtitle = 'æ­£åœ¨ä»LeanCloudäº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®') {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = overlay.querySelector('.loading-text');
            const subtitleEl = overlay.querySelector('.loading-subtitle');
            
            textEl.textContent = text;
            subtitleEl.innerHTML = subtitle;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // åŒæ­¥é€šçŸ¥
        function showSyncNotification(message, type = 'success') {
            let notification = document.getElementById('syncNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'syncNotification';
                notification.className = 'sync-notification';
                document.body.appendChild(notification);
            }
            
            // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„èƒŒæ™¯é¢œè‰²
            if (type === 'warning' || message.includes('å¤±è´¥') || message.includes('æ¼”ç¤ºæ¨¡å¼')) {
                notification.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
            } else {
                notification.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
            }
            
            notification.textContent = message;
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(-50%) translateY(0)';
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-20px)';
            }, 4000); // å»¶é•¿åˆ°4ç§’ï¼Œè®©ç”¨æˆ·æœ‰è¶³å¤Ÿæ—¶é—´çœ‹åˆ°
        }


        // é˜²æ­¢ä¸‹æ‹‰åˆ·æ–°
        function preventPullToRefresh() {
            let startY = 0;
            
            document.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
            }, { passive: false });
            
            document.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                
                if (window.scrollY === 0 && deltaY > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.body.style.overscrollBehavior = 'none';
            document.documentElement.style.overscrollBehavior = 'none';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updatePlayersDisplay();
            saveToSync = initSimpleJsonSync();
            preventPullToRefresh();
        });

        // äº‹ä»¶ç›‘å¬
        document.getElementById('advancedScoreModal').addEventListener('click', function(e) {
            if (e.target === this) closeAdvancedScoreModal();
        });

        document.getElementById('customDialog').addEventListener('click', function(e) {
            if (e.target === this) closeDialog();
        });

    </script>
</body>
</html>
